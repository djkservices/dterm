<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>My Network Tools</title>
  <link rel="stylesheet" href="node_modules/xterm/css/xterm.css">
  <link rel="stylesheet" href="node_modules/monaco-editor/min/vs/editor/editor.main.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000000;
      color: #ccc;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #app-container {
      flex: 1;
      display: flex;
      min-height: 0;
      overflow: hidden;
    }

    /* Left Panel */
    #left-panel {
      width: 400px;
      min-width: 200px;
      max-width: 500px;
      background: #0a0a0a;
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    /* Panel Resizers */
    .panel-resizer {
      width: 4px;
      background: #222;
      cursor: ew-resize;
      flex-shrink: 0;
    }
    .panel-resizer:hover { background: #0066cc; }

    /* File Manager */
    #file-manager {
      flex: 3;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    /* Mini Browser */
    #mini-browser {
      flex: 1;
      min-height: 450px;
      background: #0a0a0a;
      border-top: 1px solid #222;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #mini-browser-toolbar {
      padding: 6px;
      display: flex;
      gap: 4px;
      border-bottom: 1px solid #222;
    }

    #mini-browser-toolbar button {
      padding: 5px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      cursor: pointer;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #mini-browser-toolbar button:hover {
      background: #2a2a2a;
      border-color: #444;
    }

    #mini-browser-url {
      flex: 1;
      padding: 4px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 11px;
      outline: none;
    }

    #mini-browser-url:focus {
      border-color: #0066cc;
    }

    #mini-browser-frame {
      flex: 1;
      border: none;
      background: #fff;
      min-height: 0;
      width: 100%;
      height: 100%;
    }

    #mini-browser-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 12px;
      display: none;
    }

    #mini-browser-loading.visible {
      display: block;
    }

    #mini-browser-content {
      position: relative;
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* File list loading */
    #file-list-loading {
      padding: 20px;
      text-align: center;
      color: #666;
      display: none;
    }

    #file-list-loading.visible {
      display: block;
    }

    /* Left panel resizer between file manager and mini browser */
    #left-panel-resizer {
      height: 4px;
      background: #222;
      cursor: ns-resize;
      flex-shrink: 0;
    }
    #left-panel-resizer:hover { background: #0066cc; }

    #fm-toolbar {
      padding: 6px;
      border-bottom: 1px solid #222;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    #fm-toolbar button, #fm-bottom-toolbar button {
      padding: 5px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      cursor: pointer;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      white-space: nowrap;
    }

    #fm-toolbar button:hover, #fm-bottom-toolbar button:hover {
      background: #2a2a2a;
      border-color: #444;
    }

    #fm-toolbar button.active {
      background: #0066cc;
      border-color: #0066cc;
    }

    #fm-search {
      flex: 1;
      min-width: 60px;
      padding: 4px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 11px;
      outline: none;
    }

    #fm-search:focus { border-color: #0066cc; }

    #fm-path {
      padding: 6px 10px;
      font-size: 11px;
      color: #666;
      border-bottom: 1px solid #222;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #fm-path span { flex: 1; overflow: hidden; text-overflow: ellipsis; }

    #fm-path button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
    }

    #fm-path button:hover { color: #0066cc; }

    /* Bookmarks */
    #bookmarks-bar {
      display: flex;
      gap: 4px;
      padding: 4px 6px;
      border-bottom: 1px solid #222;
      overflow-x: auto;
      flex-shrink: 0;
    }

    #bookmarks-bar:empty { display: none; }

    .bookmark-item {
      padding: 3px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      font-size: 10px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bookmark-item:hover { background: #2a2a2a; color: #ccc; }

    .bookmark-item .remove-bookmark {
      opacity: 0;
      font-size: 10px;
    }

    .bookmark-item:hover .remove-bookmark { opacity: 0.6; }
    .bookmark-item .remove-bookmark:hover { opacity: 1; color: #f44; }

    /* Recent Menu */
    #recent-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #recent-menu.visible { display: block; }

    #recent-menu .recent-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      color: #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #recent-menu .recent-item:hover { background: #0066cc; }

    #recent-menu .recent-header {
      padding: 4px 12px;
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    #recent-menu .recent-clear {
      padding: 6px 12px;
      font-size: 11px;
      color: #888;
      cursor: pointer;
      border-top: 1px solid #222;
      margin-top: 4px;
    }

    #recent-menu .recent-clear:hover { color: #f44; }

    #fm-toolbar { position: relative; }

    /* Git indicators */
    #git-branch {
      padding: 2px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 10px;
      color: #888;
      display: none;
      align-items: center;
      gap: 4px;
    }

    #git-branch.visible { display: flex; }
    #git-branch .branch-icon { color: #f90; }

    .file-item.git-modified .file-name { color: #f90; }
    .file-item.git-added .file-name { color: #0f0; }
    .file-item.git-deleted .file-name { color: #f44; text-decoration: line-through; }
    .file-item.git-untracked .file-name { color: #888; }

    .git-indicator {
      font-size: 10px;
      margin-left: auto;
      padding: 1px 4px;
      border-radius: 2px;
    }

    .git-indicator.modified { color: #f90; }
    .git-indicator.added { color: #0f0; }
    .git-indicator.untracked { color: #888; }

    #file-list {
      flex: 1;
      overflow-y: auto;
    }

    #file-list.drop-over {
      outline: 2px dashed #0066cc;
      outline-offset: -2px;
      background: rgba(0, 102, 204, 0.05);
    }

    .file-item {
      padding: 4px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      user-select: none;
    }

    .file-item[draggable="true"] {
      cursor: grab;
    }

    .file-item.dragging {
      opacity: 0.5;
    }

    .file-item:hover { background: #1a1a1a; }
    .file-item.selected { background: #0066cc; }
    .file-item.cut { opacity: 0.5; }

    .file-item .file-info {
      margin-left: auto;
      font-size: 10px;
      color: #666;
    }

    #fm-bottom-toolbar {
      padding: 6px;
      border-top: 1px solid #222;
      display: flex;
      gap: 4px;
    }

    /* Main Area */
    #main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }

    /* Editor Area */
    #editor-area {
      display: none;
      flex-direction: column;
      border-bottom: 1px solid #222;
    }

    #editor-area.visible {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    #editor-tabs {
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      overflow-x: auto;
    }

    #editor-container {
      flex: 1;
      position: relative;
      min-height: 0;
      overflow: hidden;
    }

    /* Terminal Area */
    #terminal-area {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    #terminal-area.with-editor {
      flex: none;
      height: 250px;
      border-top: 1px solid #222;
    }

    /* Tabs */
    #terminal-tabs {
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
    }

    .tab {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      border-right: 1px solid #222;
    }

    .tab.active { background: #000000; }
    .tab:hover:not(.active) { background: #1a1a1a; }
    .tab.modified span:first-child::before { content: '● '; color: #0af; }

    .tab-close {
      opacity: 0.6;
      font-size: 12px;
    }

    .tab-close:hover { opacity: 1; }

    #new-term-btn, .term-profile-btn {
      padding: 8px 12px;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
    }

    #new-term-btn:hover, .term-profile-btn:hover { color: #ccc; }

    /* Terminal search bar */
    #terminal-search {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 8px;
      z-index: 100;
      gap: 4px;
      align-items: center;
    }

    #terminal-search.visible { display: flex; }

    #terminal-search input {
      width: 200px;
      padding: 4px 8px;
      background: #000;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      outline: none;
    }

    #terminal-search input:focus { border-color: #0066cc; }

    #terminal-search button {
      padding: 4px 8px;
      background: #333;
      border: none;
      border-radius: 4px;
      color: #ccc;
      cursor: pointer;
      font-size: 11px;
    }

    #terminal-search button:hover { background: #444; }

    #terminal-search .search-count {
      font-size: 10px;
      color: #666;
      min-width: 40px;
    }

    .term-profiles {
      display: flex;
      margin-left: auto;
      border-left: 1px solid #222;
    }

    /* Terminal Container */
    #terminal-container {
      flex: 1;
      position: relative;
      background: #000000;
      min-height: 0;
      overflow: hidden;
    }

    #terminal-container.drag-over {
      outline: 2px dashed #0066cc;
      outline-offset: -2px;
    }

    /* Right Panel */
    #right-panel {
      width: 400px;
      min-width: 300px;
      max-width: 700px;
      background: #0a0a0a;
      border-left: 1px solid #222;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    #right-panel-header {
      padding: 8px;
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    #right-panel-tabs {
      display: flex;
      gap: 4px;
    }

    .right-tab {
      padding: 5px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .right-tab:hover {
      background: #2a2a2a;
      color: #ccc;
    }

    .right-tab.active {
      background: #0066cc;
      border-color: #0066cc;
      color: #fff;
    }

    #ai-select {
      background: #1a1a1a;
      color: #ccc;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      outline: none;
    }

    #ai-select:hover {
      background: #2a2a2a;
    }

    #ai-frame {
      flex: 1;
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
      min-height: 0;
    }

    /* Right Panel Notes */
    #right-notes-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    #notes-area {
      flex: 1;
      background: #000;
      color: #ccc;
      border: none;
      outline: none;
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      padding: 12px;
      line-height: 1.5;
    }

    /* Right Panel Tools */
    #right-tools-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    #tools-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .tools-category {
      color: #888;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 4px 4px;
      border-bottom: 1px solid #333;
      margin-bottom: 4px;
    }

    .tools-category:first-child {
      padding-top: 0;
    }

    .tool-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 8px;
      background: none;
      border: none;
      color: #ccc;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      border-radius: 4px;
    }

    .tool-btn:hover {
      background: #1a1a1a;
      color: #fff;
    }

    .tool-btn.active {
      background: #0066cc;
      color: #fff;
    }

    #tools-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
      background: #111;
    }

    .tool-back-btn {
      background: none;
      border: none;
      color: #0088ff;
      font-size: 14px;
      cursor: pointer;
      padding: 2px 4px;
    }

    .tool-back-btn:hover { color: #44aaff; }

    .tool-title {
      color: #ccc;
      font-size: 13px;
      font-weight: 600;
    }

    .tool-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .tool-body label {
      display: block;
      color: #888;
      font-size: 11px;
      margin-bottom: 3px;
      margin-top: 8px;
    }

    .tool-body label:first-child { margin-top: 0; }

    .tool-input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      outline: none;
    }

    .tool-input:focus { border-color: #0066cc; }

    .tool-textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      outline: none;
      resize: vertical;
      min-height: 60px;
    }

    .tool-textarea:focus { border-color: #0066cc; }

    .tool-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .tool-run-btn {
      padding: 6px 14px;
      background: #0066cc;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .tool-run-btn:hover { background: #0077ee; }
    .tool-run-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

    .tool-secondary-btn {
      padding: 6px 14px;
      background: #333;
      border: none;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .tool-secondary-btn:hover { background: #444; }

    .tool-output {
      margin-top: 10px;
      padding: 8px;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #0f0;
      font-size: 11px;
      font-family: 'SF Mono', Monaco, monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }

    .tool-output.error { color: #f55; }

    .tool-result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 11px;
    }

    .tool-result-table td, .tool-result-table th {
      padding: 4px 6px;
      border: 1px solid #333;
      color: #ccc;
      text-align: left;
    }

    .tool-result-table th {
      background: #1a1a1a;
      color: #888;
      font-weight: 600;
    }

    .tool-result-table td:first-child {
      color: #0088ff;
      white-space: nowrap;
      width: 1%;
    }

    .tool-status { font-size: 11px; color: #888; margin-top: 6px; }
    .tool-status.ok { color: #4c4; }
    .tool-status.warn { color: #cc4; }
    .tool-status.fail { color: #f55; }

    /* FTP Bar (bottom of right panel, always visible) */
    #ftp-bar {
      background: #0a0a0a;
      border-top: 1px solid #222;
      padding: 12px;
      flex-shrink: 0;
    }

    #ftp-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 12px;
    }

    #ftp-bar input, #ftp-bar select {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      box-sizing: border-box;
    }

    #ftp-bar input:focus { border-color: #0066cc; }

    #ftp-bar-row {
      display: flex;
      gap: 8px;
    }

    #ftp-bar-row input {
      flex: 1;
      min-width: 0;
    }

    #ftp-port { max-width: 70px; }

    #ftp-bar-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    #ftp-bar button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #ftp-connect-btn {
      flex: 1;
      background: #0066cc;
      color: #fff;
    }
    #ftp-connect-btn:hover { background: #0077dd; }

    #ftp-disconnect-btn {
      flex: 1;
      background: #cc3333;
      color: #fff;
    }
    #ftp-disconnect-btn:hover { background: #dd4444; }

    #ftp-save-btn {
      background: #333;
      color: #ccc;
    }
    #ftp-save-btn:hover { background: #444; }

    #ftp-delete-saved-btn {
      background: #333;
      color: #f44;
    }
    #ftp-delete-saved-btn:hover { background: #444; }

    #ftp-status {
      font-size: 11px;
      color: #666;
      border-bottom: 1px solid #222;
    }

    .terminal-panel {
      position: absolute;
      inset: 0;
      display: none;
    }

    .terminal-panel.active { display: block; }

    /* Context Menu */
    #context-menu {
      position: fixed;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #context-menu button {
      display: block;
      width: 100%;
      padding: 8px 16px;
      background: none;
      border: none;
      color: #ccc;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    #context-menu button:hover { background: #0066cc; }
    #context-menu button.danger { color: #f44; }

    /* Terminal Context Menu */
    #terminal-context-menu {
      position: fixed;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #terminal-context-menu button {
      display: block;
      width: 100%;
      padding: 8px 16px;
      background: none;
      border: none;
      color: #ccc;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    #terminal-context-menu button:hover { background: #0066cc; }

    /* Command Palette */
    #command-palette {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 500px;
      max-width: 90%;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      display: none;
      flex-direction: column;
      z-index: 4000;
      max-height: 400px;
    }

    #command-palette.visible { display: flex; }

    #command-palette-input {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-bottom: 1px solid #333;
      color: #fff;
      font-size: 14px;
      outline: none;
    }

    #command-palette-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .command-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .command-item:hover, .command-item.selected { background: #0066cc; }

    .command-item .command-icon { font-size: 16px; opacity: 0.7; }
    .command-item .command-name { flex: 1; }
    .command-item .command-shortcut { font-size: 11px; color: #888; }

    .command-item.selected .command-shortcut { color: #ccc; }

    /* Resizer */
    #resizer {
      height: 4px;
      background: #222;
      cursor: ns-resize;
    }
    #resizer:hover { background: #0066cc; }

    /* File Preview */
    #file-preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }

    #file-preview-overlay.visible { display: flex; }

    #file-preview-container {
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #file-preview-container img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 4px;
    }

    #file-preview-container video {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 4px;
    }

    #file-preview-name {
      margin-top: 12px;
      color: #888;
      font-size: 12px;
    }

    #file-preview-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }

    #file-preview-close:hover { color: #fff; }

    /* Settings Panel */
    #settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #settings-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #settings-panel h2 {
      margin-bottom: 16px;
      font-size: 16px;
      color: #fff;
    }

    .settings-group {
      margin-bottom: 16px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: #888;
    }

    .settings-group input, .settings-group select {
      width: 100%;
      padding: 8px;
      background: #000;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 13px;
      outline: none;
    }

    .settings-group input:focus, .settings-group select:focus {
      border-color: #0066cc;
    }

    #settings-panel .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    #settings-panel button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    #settings-panel button.primary {
      background: #0066cc;
      color: #fff;
    }

    #settings-panel button.secondary {
      background: #333;
      color: #ccc;
    }

    /* Shortcuts Panel */
    #shortcuts-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #shortcuts-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      width: 450px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #shortcuts-panel h2 {
      margin-bottom: 16px;
      font-size: 16px;
      color: #fff;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #222;
      font-size: 13px;
    }

    .shortcut-key {
      background: #333;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      color: #fff;
    }

    /* Status Bar */
    #status-bar {
      height: 24px;
      background: #0a0a0a;
      border-top: 1px solid #222;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      color: #666;
      gap: 16px;
      flex-shrink: 0;
    }

    #status-bar button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 6px;
    }

    #status-bar button:hover { color: #ccc; }

    /* FTP mode indicator */
    #ftp-mode-badge {
      display: none;
      background: #0066cc;
      color: #fff;
      padding: 1px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }

    #ftp-mode-badge.visible { display: inline-block; }

    /* Welcome / Cloud Account Overlay */
    #welcome-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #welcome-overlay.hidden { display: none; }
    #welcome-box {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 40px;
      max-width: 420px;
      width: 90%;
      text-align: center;
    }
    #welcome-box h1 { font-size: 28px; margin-bottom: 8px; color: #fff; }
    #welcome-box .brand { color: #569cd6; font-family: 'SF Mono', Monaco, monospace; }
    #welcome-box .welcome-msg { color: #888; font-size: 14px; margin-bottom: 24px; line-height: 1.5; }
    #welcome-box .form-group { margin-bottom: 14px; text-align: left; }
    #welcome-box .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
    #welcome-box .form-group input { width: 100%; padding: 10px 12px; background: #2d2d2d; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 14px; }
    #welcome-box .form-group input:focus { outline: none; border-color: #569cd6; }
    #welcome-box .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-top: 8px; }
    #welcome-box .btn-primary { background: #0e639c; color: #fff; }
    #welcome-box .btn-primary:hover { background: #1177bb; }
    #welcome-box .btn-secondary { background: #333; color: #ccc; }
    #welcome-box .btn-secondary:hover { background: #444; }
    #welcome-box .toggle-link { color: #569cd6; cursor: pointer; font-size: 13px; margin-top: 16px; display: inline-block; }
    #welcome-box .error-msg { color: #f48771; font-size: 13px; margin-top: 8px; }
    #welcome-box .skip-link { color: #666; cursor: pointer; font-size: 12px; margin-top: 16px; display: inline-block; }
    #welcome-box .skip-link:hover { color: #888; }

    /* Cloud account badge in status bar */
    #cloud-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #569cd6;
      cursor: pointer;
    }
    #cloud-badge:hover { color: #7ab8e8; }
    #cloud-badge .sync-icon { animation: none; }
    #cloud-badge .sync-icon.syncing { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <!-- Welcome / Login Overlay -->
  <div id="welcome-overlay" class="hidden">
    <div id="welcome-box">
      <h1>dTerm</h1>
      <p class="welcome-msg" id="welcome-msg">Welcome to dTerm</p>
      <div id="welcome-error" class="error-msg" style="display:none;"></div>

      <!-- Login Form -->
      <div id="login-form">
        <div class="form-group">
          <label>Username or Email</label>
          <input type="text" id="cloud-username" placeholder="username" autocomplete="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="cloud-password" placeholder="password" autocomplete="current-password" onkeydown="if(event.key==='Enter')cloudLogin()">
        </div>
        <button class="btn btn-primary" onclick="cloudLogin()">Sign In</button>
        <span class="toggle-link" onclick="showRegisterForm()">Create Account</span>
      </div>

      <!-- Register Form -->
      <div id="register-form" style="display:none;">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="reg-username" placeholder="username">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="reg-email" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="reg-password" placeholder="password (min 5 chars)">
        </div>
        <button class="btn btn-primary" onclick="cloudRegister()">Create Account</button>
        <span class="toggle-link" onclick="showLoginForm()">Already have an account? Sign In</span>
      </div>

      <!-- Logged In View -->
      <div id="welcome-logged-in" style="display:none;">
        <p style="color:#4ec94e; margin-bottom:16px;">&#10003; Signed in as <strong id="welcome-username"></strong></p>
        <button class="btn btn-primary" onclick="dismissWelcome()">Continue to dTerm</button>
        <button class="btn btn-secondary" onclick="cloudLogout()">Sign Out</button>
      </div>

    </div>
  </div>

  <!-- App Container -->
  <div id="app-container">
  <!-- Left Panel -->
  <div id="left-panel">
    <!-- File Manager -->
    <div id="file-manager">
      <div id="fm-toolbar">
        <button onclick="goHome()">Home</button>
        <button onclick="goUp()">Up</button>
        <button onclick="openFolder()">Open</button>
        <button onclick="refresh()">Refresh</button>
        <button id="hidden-toggle" onclick="toggleHidden()">Hidden</button>
        <button onclick="showRecentMenu(event)">Recent ▾</button>
        <input type="text" id="fm-search" placeholder="Search..." oninput="filterFiles()">
      </div>
      <div id="recent-menu"></div>
      <div id="fm-path"><span>Loading...</span><div id="git-branch"><span class="branch-icon">⎇</span><span id="git-branch-name"></span></div><button onclick="toggleBookmark()" title="Bookmark this folder">☆</button></div>
      <div id="bookmarks-bar"></div>
      <div id="file-list"></div>
      <div id="fm-bottom-toolbar">
        <button onclick="newFile()">+ File</button>
        <button onclick="newFolder()">+ Folder</button>
      </div>
    </div>

    <!-- Left Panel Resizer -->
    <div id="left-panel-resizer"></div>

    <!-- Mini Browser -->
    <div id="mini-browser">
      <div id="mini-browser-toolbar">
        <button onclick="miniBrowserBack()">←</button>
        <button onclick="miniBrowserForward()">→</button>
        <button onclick="miniBrowserRefresh()">↻</button>
        <button onclick="miniBrowserHome()">⌂</button>
        <input type="text" id="mini-browser-url" placeholder="Enter URL..." value="" onkeydown="if(event.key==='Enter')miniBrowserGo()">
        <button onclick="miniBrowserGo()">Go</button>
      </div>
      <div id="mini-browser-content">
        <div id="mini-browser-loading"><span class="loading-spinner"></span>Loading...</div>
        <webview id="mini-browser-frame" allowpopups></webview>
      </div>
    </div>
  </div>

  <!-- Left Resizer -->
  <div class="panel-resizer" id="left-resizer"></div>

  <!-- Main Area -->
  <div id="main-area">
    <!-- Editor Area -->
    <div id="editor-area">
      <div id="editor-tabs"></div>
      <div id="editor-container"></div>
    </div>

    <div id="resizer"></div>

    <!-- Terminal Area -->
    <div id="terminal-area">
      <div id="terminal-tabs">
        <button id="new-term-btn" onclick="createTerminal()">+</button>
        <div class="term-profiles">
          <button class="term-profile-btn" onclick="createTerminal('/bin/zsh')" title="Zsh">zsh</button>
          <button class="term-profile-btn" onclick="createTerminal('/bin/bash')" title="Bash">bash</button>
          <button class="term-profile-btn" onclick="createTerminal('node')" title="Node">node</button>
          <button class="term-profile-btn" onclick="createTerminal('python3')" title="Python">py</button>
        </div>
      </div>
      <div id="terminal-container">
        <div id="terminal-search">
          <input type="text" id="terminal-search-input" placeholder="Search..." onkeydown="handleTerminalSearchKey(event)">
          <button onclick="terminalSearchPrev()">↑</button>
          <button onclick="terminalSearchNext()">↓</button>
          <span class="search-count" id="terminal-search-count"></span>
          <button onclick="closeTerminalSearch()">✕</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Resizer -->
  <div class="panel-resizer" id="right-resizer"></div>

  <!-- Right Panel - AI / Notes / FTP -->
  <div id="right-panel">
    <div id="right-panel-header">
      <div id="right-panel-tabs">
        <button class="right-tab active" onclick="showRightTab('notes')">Notes</button>
        <button class="right-tab" onclick="showRightTab('tools')">Tools</button>
        <button class="right-tab" onclick="showRightTab('ai')">AI</button>
      </div>
      <select id="ai-select" onchange="switchAI()">
        <option value="https://chatgpt.com">ChatGPT</option>
        <option value="https://copilot.microsoft.com">Copilot</option>
        <option value="https://claude.ai">Claude</option>
        <option value="https://gemini.google.com">Gemini</option>
        <option value="https://poe.com">Poe</option>
        <option value="https://perplexity.ai">Perplexity</option>
      </select>
    </div>
    <div id="right-notes-panel">
      <textarea id="notes-area" placeholder="Quick notes..."></textarea>
    </div>
    <div id="right-tools-panel" style="display:none;">
      <div id="tools-list">
        <div class="tools-category">Network</div>
        <button class="tool-btn" onclick="openTool('ping')">Ping</button>
        <button class="tool-btn" onclick="openTool('traceroute')">Traceroute</button>
        <button class="tool-btn" onclick="openTool('dns-lookup')">DNS Lookup</button>
        <button class="tool-btn" onclick="openTool('reverse-dns')">Reverse DNS</button>
        <button class="tool-btn" onclick="openTool('port-scanner')">Port Scanner</button>
        <button class="tool-btn" onclick="openTool('ip-info')">IP Info</button>
        <button class="tool-btn" onclick="openTool('whois')">Whois</button>
        <button class="tool-btn" onclick="openTool('mac-lookup')">MAC Lookup</button>
        <button class="tool-btn" onclick="openTool('subnet-calc')">Subnet Calculator</button>
        <button class="tool-btn" onclick="openTool('ping-monitor')">Ping Monitor</button>
        <button class="tool-btn" onclick="openTool('uptime-monitor')">Uptime Monitor</button>
        <button class="tool-btn" onclick="openTool('blacklist-check')">Blacklist Check</button>

        <div class="tools-category">SSL / Security</div>
        <button class="tool-btn" onclick="openTool('ssl-checker')">SSL Checker</button>
        <button class="tool-btn" onclick="openTool('ssl-expiry')">SSL Expiry</button>
        <button class="tool-btn" onclick="openTool('security-headers')">Security Headers</button>
        <button class="tool-btn" onclick="openTool('password-generator')">Password Generator</button>
        <button class="tool-btn" onclick="openTool('password-checker')">Password Checker</button>
        <button class="tool-btn" onclick="openTool('hash-generator')">Hash Generator</button>

        <div class="tools-category">Web / SEO</div>
        <button class="tool-btn" onclick="openTool('seo-analyzer')">SEO Analyzer</button>
        <button class="tool-btn" onclick="openTool('page-speed')">Page Speed</button>
        <button class="tool-btn" onclick="openTool('broken-links')">Broken Links</button>
        <button class="tool-btn" onclick="openTool('http-headers')">HTTP Headers</button>
        <button class="tool-btn" onclick="openTool('open-graph')">Open Graph</button>
        <button class="tool-btn" onclick="openTool('meta-tags')">Meta Tags</button>
        <button class="tool-btn" onclick="openTool('robots-txt')">Robots.txt</button>
        <button class="tool-btn" onclick="openTool('sitemap-generator')">Sitemap Generator</button>
        <button class="tool-btn" onclick="openTool('domain-expiry')">Domain Expiry</button>

        <div class="tools-category">Developer</div>
        <button class="tool-btn" onclick="openTool('api-tester')">API Tester</button>
        <button class="tool-btn" onclick="openTool('json-formatter')">JSON Formatter</button>
        <button class="tool-btn" onclick="openTool('code-beautifier')">Code Beautifier</button>
        <button class="tool-btn" onclick="openTool('regex-tester')">Regex Tester</button>
        <button class="tool-btn" onclick="openTool('base64')">Base64</button>
        <button class="tool-btn" onclick="openTool('jwt-decoder')">JWT Decoder</button>
        <button class="tool-btn" onclick="openTool('cron-parser')">Cron Parser</button>
        <button class="tool-btn" onclick="openTool('uuid-generator')">UUID Generator</button>
        <button class="tool-btn" onclick="openTool('timestamp-converter')">Timestamp Converter</button>

        <div class="tools-category">Utilities</div>
        <button class="tool-btn" onclick="openTool('markdown-preview')">Markdown Preview</button>
        <button class="tool-btn" onclick="openTool('lorem-ipsum')">Lorem Ipsum</button>
        <button class="tool-btn" onclick="openTool('qr-generator')">QR Generator</button>
        <button class="tool-btn" onclick="openTool('color-picker')">Color Picker</button>
      </div>
    </div>
    <div id="tools-content" style="display:none;"></div>
    <webview id="ai-frame" src="about:blank" allowpopups style="display:none;"></webview>
    <!-- FTP Bar (bottom of right panel) -->
    <div id="ftp-bar">
      <div id="ftp-bar-header">
        <span style="font-weight:600;color:#ccc;">FTP Connection</span>
        <span id="ftp-status">Not connected</span>
      </div>
      <select id="ftp-saved" onchange="loadSavedConnection()">
        <option value="">Saved connections...</option>
      </select>
      <input type="text" id="ftp-host" placeholder="Host (e.g., ftp.example.com)" spellcheck="false">
      <div id="ftp-bar-row">
        <input type="text" id="ftp-port" placeholder="Port" value="21" spellcheck="false">
        <input type="text" id="ftp-user" placeholder="Username" spellcheck="false">
      </div>
      <input type="password" id="ftp-pass" placeholder="Password">
      <div id="ftp-bar-actions">
        <button id="ftp-save-btn" onclick="saveConnection()">Save</button>
        <button id="ftp-delete-saved-btn" onclick="deleteSavedConnection()" style="display:none;">Delete</button>
        <button id="ftp-connect-btn" onclick="connectFtp()">Connect</button>
        <button id="ftp-disconnect-btn" onclick="disconnectFtp()" style="display:none;">Disconnect</button>
      </div>
    </div>
  </div>
  </div><!-- End app-container -->

  <!-- Context Menu (File Manager) -->
  <div id="context-menu">
    <button onclick="openSelectedFile()">Open</button>
    <button onclick="previewSelectedFile()">Preview</button>
    <button id="ctx-download" style="display:none;" onclick="downloadFtpFile()">Download</button>
    <button id="ctx-upload" style="display:none;" onclick="uploadFtpFile()">Upload File</button>
    <button onclick="copyFile()">Copy</button>
    <button onclick="cutFile()">Cut</button>
    <button onclick="pasteFile()">Paste</button>
    <button onclick="renameFile()">Rename</button>
    <button onclick="deleteFile()" class="danger">Delete</button>
  </div>

  <!-- Terminal Context Menu -->
  <div id="terminal-context-menu">
    <button onclick="terminalCopy()">Copy</button>
    <button onclick="terminalPaste()">Paste</button>
    <button onclick="terminalSelectAll()">Select All</button>
    <button onclick="terminalClear()">Clear</button>
  </div>

  <!-- Command Palette -->
  <div id="command-palette">
    <input type="text" id="command-palette-input" placeholder="Type a command or search..." oninput="filterCommands()" onkeydown="handleCommandKey(event)">
    <div id="command-palette-list"></div>
  </div>

  <!-- File Preview -->
  <div id="file-preview-overlay" onclick="if(event.target===this)closeFilePreview()">
    <button id="file-preview-close" onclick="closeFilePreview()">✕</button>
    <div id="file-preview-container"></div>
  </div>

  <!-- Input Dialog -->
  <div id="input-dialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:20px; border-radius:8px; border:1px solid #333; min-width:300px;">
      <div id="input-dialog-title" style="margin-bottom:12px; font-size:14px; color:#ccc;"></div>
      <input type="text" id="input-dialog-input" style="width:100%; padding:8px; background:#000; border:1px solid #333; border-radius:4px; color:#ccc; font-size:14px; outline:none;">
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button onclick="closeInputDialog()" style="padding:6px 12px; background:#333; border:none; border-radius:4px; color:#ccc; cursor:pointer;">Cancel</button>
        <button onclick="confirmInputDialog()" style="padding:6px 12px; background:#0066cc; border:none; border-radius:4px; color:#fff; cursor:pointer;">OK</button>
      </div>
    </div>
  </div>

  <!-- Settings Overlay -->
  <div id="settings-overlay" onclick="if(event.target===this)closeSettings()">
    <div id="settings-panel">
      <h2>Settings</h2>
      <div class="settings-group">
        <label>Editor Font Size</label>
        <input type="number" id="setting-font-size" value="14" min="10" max="24">
      </div>
      <div class="settings-group">
        <label>Default Shell</label>
        <select id="setting-shell">
          <option value="/bin/zsh">Zsh</option>
          <option value="/bin/bash">Bash</option>
          <option value="/bin/sh">Sh</option>
        </select>
      </div>
      <div class="settings-group">
        <label>Theme</label>
        <select id="setting-theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
      <div class="settings-group">
        <label>Browser Home Page</label>
        <input type="text" id="setting-browser-home" value="https://duckduckgo.com" placeholder="https://duckduckgo.com" style="width:100%; padding:6px 8px; background:#1a1a1a; border:1px solid #333; border-radius:4px; color:#ccc; font-size:12px;">
      </div>
      <div class="btn-row">
        <button class="secondary" onclick="closeSettings()">Cancel</button>
        <button class="primary" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Shortcuts Overlay -->
  <div id="shortcuts-overlay" onclick="if(event.target===this)closeShortcuts()">
    <div id="shortcuts-panel">
      <h2>Keyboard Shortcuts</h2>
      <div class="shortcut-row"><span>Save file</span><span class="shortcut-key">⌘S</span></div>
      <div class="shortcut-row"><span>New terminal</span><span class="shortcut-key">⌘T</span></div>
      <div class="shortcut-row"><span>Close tab</span><span class="shortcut-key">⌘W</span></div>
      <div class="shortcut-row"><span>Find in file</span><span class="shortcut-key">⌘F</span></div>
      <div class="shortcut-row"><span>Go to line</span><span class="shortcut-key">⌘G</span></div>
      <div class="shortcut-row"><span>Command palette</span><span class="shortcut-key">⌘⇧P</span></div>
      <div class="shortcut-row"><span>Toggle sidebar</span><span class="shortcut-key">⌘B</span></div>
      <div class="shortcut-row"><span>Settings</span><span class="shortcut-key">⌘,</span></div>
      <div class="shortcut-row"><span>Shortcuts help</span><span class="shortcut-key">⌘/</span></div>
      <div class="shortcut-row"><span>Copy file</span><span class="shortcut-key">⌘C</span></div>
      <div class="shortcut-row"><span>Cut file</span><span class="shortcut-key">⌘X</span></div>
      <div class="shortcut-row"><span>Paste file</span><span class="shortcut-key">⌘V</span></div>
      <div style="margin-top:16px; text-align:center;">
        <button class="secondary" onclick="closeShortcuts()" style="padding:8px 20px; background:#333; border:none; border-radius:4px; color:#ccc; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="status-bar">
    <span id="ftp-mode-badge">FTP</span>
    <span id="status-file">No file open</span>
    <span id="status-line">Ln 1, Col 1</span>
    <span style="flex:1;"></span>
    <span id="cloud-badge" onclick="showCloudMenu()" style="display:none;" title="Cloud Account">
      <span class="sync-icon">&#9729;</span>
      <span id="cloud-badge-text">Not signed in</span>
    </span>
    <button id="cloud-sync-btn" onclick="manualSync()" style="display:none;" title="Sync Now">&#8635; Sync</button>
    <button onclick="showShortcuts()">Shortcuts</button>
    <button onclick="showSettings()">Settings</button>
  </div>

  <script src="node_modules/xterm/lib/xterm.js"></script>
  <script src="node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script src="node_modules/xterm-addon-search/lib/xterm-addon-search.js"></script>
  <script>
    // Monaco Editor loader
    const monacoLoader = document.createElement('script');
    monacoLoader.src = 'node_modules/monaco-editor/min/vs/loader.js';
    monacoLoader.onload = () => {
      require.config({ paths: { vs: 'node_modules/monaco-editor/min/vs' } });
      require(['vs/editor/editor.main'], () => {
        monacoReady = true;
        monaco.editor.setTheme('vs-dark');
      });
    };
    document.head.appendChild(monacoLoader);

    let monacoReady = false;
    let monacoEditor = null;
    let currentPath = '';
    let selectedFile = null;
    let terminals = [];
    let openFiles = [];
    let activeFileIndex = -1;
    let showHidden = false;
    let allFiles = [];
    let clipboard = { file: null, action: null };
    let settings = {
      fontSize: 14,
      shell: '/bin/zsh',
      theme: 'dark',
      browserHome: 'https://duckduckgo.com'
    };

    // FTP mode state
    let appMode = 'local'; // 'local' or 'ftp'
    let ftpRemoteHost = '';

    // Switch to FTP mode - called when connecting from the FTP tab
    function switchToFtpMode(host) {
      appMode = 'ftp';
      ftpRemoteHost = host;
      currentPath = '/';
      document.getElementById('ftp-mode-badge').classList.add('visible');
      loadFtpFileBrowser();
    }

    // Switch back to local mode
    function switchToLocalMode() {
      appMode = 'local';
      ftpRemoteHost = '';
      document.getElementById('ftp-mode-badge').classList.remove('visible');
      window.api.fs.getHome().then(home => {
        currentPath = home;
        loadFiles();
      });
    }

    async function loadFtpFileBrowser() {
      const fileList = document.getElementById('file-list');
      if (!fileList) return;

      const pathEl = document.querySelector('#fm-path span');
      if (pathEl) pathEl.textContent = `FTP: ${ftpRemoteHost}${currentPath}`;

      fileList.innerHTML = '';

      try {
        const files = await window.api.ftp.list(currentPath);
        allFiles = files.map(f => ({
          name: f.name,
          path: currentPath === '/' ? '/' + f.name : currentPath + '/' + f.name,
          isDirectory: f.isDirectory,
          isFile: !f.isDirectory,
          size: f.size || 0
        }));

        // Add parent directory
        if (currentPath !== '/') {
          const upDiv = document.createElement('div');
          upDiv.className = 'file-item';
          upDiv.innerHTML = '<span>📁</span><span>..</span>';
          upDiv.ondblclick = () => {
            currentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
            loadFtpFileBrowser();
          };
          fileList.appendChild(upDiv);
        }

        const sortedFiles = [...allFiles].filter(f => showHidden || !f.name.startsWith('.'));
        sortedFiles.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.localeCompare(b.name);
        });

        sortedFiles.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          const icon = file.isDirectory ? '📁' : '📄';
          const sizeStr = file.isFile ? formatSize(file.size) : '';
          div.innerHTML = `<span>${icon}</span><span class="file-name">${file.name}</span><span class="file-info">${sizeStr}</span>`;
          div.onclick = (e) => handleClick(file, e);
          div.ondblclick = () => handleDoubleClick(file);
          div.oncontextmenu = (e) => showContextMenu(e, file);
          fileList.appendChild(div);
        });
      } catch (err) {
        fileList.innerHTML = `<div style="padding:10px;color:#f44">Error: ${err.message}</div>`;
      }
    }

    async function openFtpFile(file) {
      const existingIndex = openFiles.findIndex(f => f.path === file.path);
      if (existingIndex !== -1) {
        activateFile(existingIndex);
        return;
      }
      try {
        const content = await window.api.ftp.readFile(file.path);
        openFiles.push({ path: file.path, name: file.name, content: content, modified: false, ftpFile: true });
        activeFileIndex = openFiles.length - 1;
        updateEditorTabs();
        showEditor();
        setEditorContent(content, file.name);
        updateStatusBar();
      } catch (err) {
        document.getElementById('status-file').textContent = `Error: ${err.message}`;
      }
    }

    // Load settings
    function loadSettings() {
      const saved = localStorage.getItem('dterm-settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
        document.getElementById('setting-font-size').value = settings.fontSize;
        document.getElementById('setting-shell').value = settings.shell;
        document.getElementById('setting-theme').value = settings.theme;
        applyTheme();
      }
      // Always apply browser home page setting to the input field
      document.getElementById('setting-browser-home').value = settings.browserHome;
      // Apply browser home page to webview
      const webview = document.getElementById('mini-browser-frame');
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = settings.browserHome;
      if (urlInput) urlInput.value = settings.browserHome;
    }

    function saveSettings() {
      settings.fontSize = parseInt(document.getElementById('setting-font-size').value);
      settings.shell = document.getElementById('setting-shell').value;
      settings.theme = document.getElementById('setting-theme').value;
      let browserHome = document.getElementById('setting-browser-home').value.trim();
      if (browserHome && !browserHome.startsWith('http://') && !browserHome.startsWith('https://')) {
        browserHome = 'https://' + browserHome;
      }
      settings.browserHome = browserHome || 'https://duckduckgo.com';
      localStorage.setItem('dterm-settings', JSON.stringify(settings));
      applyTheme();
      if (monacoEditor) {
        monacoEditor.updateOptions({ fontSize: settings.fontSize });
      }
      // Apply new home page to browser
      const webview = document.getElementById('mini-browser-frame');
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = settings.browserHome;
      if (urlInput) urlInput.value = settings.browserHome;
      closeSettings();
    }

    function applyTheme() {
      if (settings.theme === 'light') {
        document.body.style.background = '#f5f5f5';
        document.body.style.color = '#333';
        if (monacoReady) monaco.editor.setTheme('vs');
      } else {
        document.body.style.background = '#000000';
        document.body.style.color = '#ccc';
        if (monacoReady) monaco.editor.setTheme('vs-dark');
      }
    }

    function showSettings() {
      document.getElementById('settings-overlay').style.display = 'flex';
    }

    function closeSettings() {
      document.getElementById('settings-overlay').style.display = 'none';
    }

    function showShortcuts() {
      document.getElementById('shortcuts-overlay').style.display = 'flex';
    }

    function closeShortcuts() {
      document.getElementById('shortcuts-overlay').style.display = 'none';
    }

    // Initialize
    async function init() {
      loadSettings();
      loadBookmarks();
      currentPath = await window.api.fs.getHome();
      loadFiles();
      setupResizer();
      setupPanelResizers();
      setupTerminalDropZone();
      setupFileManagerDropZone();
      showRightTab('notes');
    }

    // Recent files/folders
    let recentFolders = JSON.parse(localStorage.getItem('dterm-recent-folders') || '[]');
    let recentFiles = JSON.parse(localStorage.getItem('dterm-recent-files') || '[]');
    const MAX_RECENT = 10;

    function addRecentFolder(path) {
      recentFolders = recentFolders.filter(p => p !== path);
      recentFolders.unshift(path);
      if (recentFolders.length > MAX_RECENT) recentFolders.pop();
      localStorage.setItem('dterm-recent-folders', JSON.stringify(recentFolders));
    }

    function addRecentFile(path) {
      recentFiles = recentFiles.filter(p => p !== path);
      recentFiles.unshift(path);
      if (recentFiles.length > MAX_RECENT) recentFiles.pop();
      localStorage.setItem('dterm-recent-files', JSON.stringify(recentFiles));
    }

    function showRecentMenu(e) {
      e.stopPropagation();
      const menu = document.getElementById('recent-menu');
      menu.innerHTML = '';

      if (recentFolders.length === 0 && recentFiles.length === 0) {
        menu.innerHTML = '<div class="recent-item" style="color:#666">No recent items</div>';
      } else {
        if (recentFolders.length > 0) {
          menu.innerHTML += '<div class="recent-header">Recent Folders</div>';
          recentFolders.forEach(path => {
            const name = path.split('/').pop() || path;
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = '📁 ' + name;
            item.title = path;
            item.onclick = () => { currentPath = path; loadFiles(); hideRecentMenu(); };
            menu.appendChild(item);
          });
        }
        if (recentFiles.length > 0) {
          menu.innerHTML += '<div class="recent-header">Recent Files</div>';
          recentFiles.forEach(path => {
            const name = path.split('/').pop();
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = '📄 ' + name;
            item.title = path;
            item.onclick = () => { openFileInEditor(path); hideRecentMenu(); };
            menu.appendChild(item);
          });
        }
        const clear = document.createElement('div');
        clear.className = 'recent-clear';
        clear.textContent = 'Clear Recent';
        clear.onclick = () => {
          recentFolders = [];
          recentFiles = [];
          localStorage.removeItem('dterm-recent-folders');
          localStorage.removeItem('dterm-recent-files');
          hideRecentMenu();
        };
        menu.appendChild(clear);
      }

      menu.classList.add('visible');
    }

    function hideRecentMenu() {
      document.getElementById('recent-menu').classList.remove('visible');
    }

    document.addEventListener('click', hideRecentMenu);

    // Bookmarks
    let bookmarks = JSON.parse(localStorage.getItem('dterm-bookmarks') || '[]');

    function loadBookmarks() {
      const bar = document.getElementById('bookmarks-bar');
      bar.innerHTML = '';
      bookmarks.forEach((path, i) => {
        const name = path.split('/').pop() || path;
        const item = document.createElement('div');
        item.className = 'bookmark-item';
        item.innerHTML = `<span>📁 ${name}</span><span class="remove-bookmark" onclick="removeBookmark(${i}, event)">✕</span>`;
        item.onclick = () => goToBookmark(path);
        item.title = path;
        bar.appendChild(item);
      });
      updateBookmarkButton();
    }

    function toggleBookmark() {
      const index = bookmarks.indexOf(currentPath);
      if (index >= 0) {
        bookmarks.splice(index, 1);
      } else {
        bookmarks.push(currentPath);
      }
      localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
      loadBookmarks();
    }

    function removeBookmark(index, e) {
      e.stopPropagation();
      bookmarks.splice(index, 1);
      localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
      loadBookmarks();
    }

    function goToBookmark(path) {
      currentPath = path;
      loadFiles();
    }

    function updateBookmarkButton() {
      const btn = document.querySelector('#fm-path button');
      if (btn) {
        btn.textContent = bookmarks.includes(currentPath) ? '★' : '☆';
        btn.style.color = bookmarks.includes(currentPath) ? '#f90' : '#666';
      }
    }

    // File Manager
    async function loadFiles() {
      if (appMode === 'ftp') {
        loadFtpFileBrowser();
        return;
      }
      document.querySelector('#fm-path span').textContent = currentPath;
      updateBookmarkButton();
      addRecentFolder(currentPath);
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';

      try {
        const files = await window.api.fs.readDir(currentPath);
        allFiles = files;

        let filtered = files;
        if (!showHidden) {
          filtered = files.filter(f => !f.name.startsWith('.'));
        }

        const searchTerm = document.getElementById('fm-search').value.toLowerCase();
        if (searchTerm) {
          filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));
        }

        filtered.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.localeCompare(b.name);
        });

        // Get git status
        const gitBranch = await window.api.git.getBranch(currentPath);
        const gitStatus = await window.api.git.getStatus(currentPath);

        // Update git branch display
        const branchEl = document.getElementById('git-branch');
        const branchNameEl = document.getElementById('git-branch-name');
        if (gitBranch) {
          branchNameEl.textContent = gitBranch;
          branchEl.classList.add('visible');
        } else {
          branchEl.classList.remove('visible');
        }

        filtered.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.draggable = true;
          if (clipboard.file && clipboard.file.path === file.path && clipboard.action === 'cut') {
            div.classList.add('cut');
          }

          // Check git status for this file
          let gitIndicator = '';
          if (gitStatus) {
            const relPath = file.name;
            const status = gitStatus[relPath] || gitStatus[relPath + '/'];
            if (status) {
              if (status.includes('M') || status.includes('m')) {
                div.classList.add('git-modified');
                gitIndicator = '<span class="git-indicator modified">M</span>';
              } else if (status.includes('A')) {
                div.classList.add('git-added');
                gitIndicator = '<span class="git-indicator added">A</span>';
              } else if (status.includes('?')) {
                div.classList.add('git-untracked');
                gitIndicator = '<span class="git-indicator untracked">?</span>';
              } else if (status.includes('D')) {
                div.classList.add('git-deleted');
                gitIndicator = '<span class="git-indicator modified">D</span>';
              }
            }
          }

          const sizeStr = file.isDirectory ? '' : formatSize(file.size);
          div.innerHTML = `
            <span>${file.isDirectory ? '📁' : '📄'}</span>
            <span class="file-name">${file.name}</span>
            ${gitIndicator}
            <span class="file-info">${sizeStr}</span>
          `;
          div.onclick = (e) => handleClick(file, e);
          div.ondblclick = () => handleDoubleClick(file);
          div.oncontextmenu = (e) => showContextMenu(e, file);
          div.ondragstart = (e) => handleDragStart(e, file);
          div.ondragend = (e) => handleDragEnd(e);
          fileList.appendChild(div);
        });
      } catch (err) {
        fileList.innerHTML = `<div style="padding:10px;color:#f44">Error: ${err.message}</div>`;
      }
    }

    function formatSize(bytes) {
      if (!bytes) return '';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
      return (bytes / 1024 / 1024 / 1024).toFixed(1) + ' GB';
    }

    function filterFiles() {
      loadFiles();
    }

    function toggleHidden() {
      showHidden = !showHidden;
      document.getElementById('hidden-toggle').classList.toggle('active', showHidden);
      loadFiles();
    }

    function handleClick(file, e) {
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
      e.currentTarget.classList.add('selected');
      selectedFile = file;
    }

    async function handleDoubleClick(file) {
      if (file.isDirectory) {
        currentPath = file.path;
        loadFiles();
      } else if (canPreview(file.name)) {
        showFilePreview(file);
      } else {
        addRecentFile(file.path);
        await openFileInEditor(file);
      }
    }

    // Drag and drop for terminal
    function handleDragStart(e, file) {
      e.dataTransfer.setData('text/plain', file.path);
      e.dataTransfer.setData('application/x-dterm-file', JSON.stringify(file));
      e.dataTransfer.effectAllowed = 'copy';
      e.currentTarget.classList.add('dragging');
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
    }

    function setupFileManagerDropZone() {
      const fileList = document.getElementById('file-list');

      fileList.addEventListener('dragover', (e) => {
        // Only handle external drops (from Finder), not internal dTerm drags
        if (e.dataTransfer.types.includes('application/x-dterm-file')) return;
        if (e.dataTransfer.types.includes('Files')) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          fileList.classList.add('drop-over');
        }
      });

      fileList.addEventListener('dragleave', (e) => {
        if (!fileList.contains(e.relatedTarget)) {
          fileList.classList.remove('drop-over');
        }
      });

      fileList.addEventListener('drop', async (e) => {
        fileList.classList.remove('drop-over');
        if (e.dataTransfer.types.includes('application/x-dterm-file')) return;
        if (!e.dataTransfer.files || e.dataTransfer.files.length === 0) return;
        e.preventDefault();

        const files = Array.from(e.dataTransfer.files);

        if (appMode === 'ftp') {
          // Upload each dropped file to current FTP directory
          for (const file of files) {
            const localPath = file.path;
            const fileName = file.name;
            const remotePath = currentPath === '/' ? '/' + fileName : currentPath + '/' + fileName;
            try {
              await window.api.ftp.uploadFromLocal(localPath, remotePath);
              document.getElementById('ftp-status').textContent = `Uploaded: ${fileName}`;
            } catch (err) {
              alert('Upload failed for ' + fileName + ': ' + err.message);
            }
          }
          loadFiles();
        } else {
          // Copy each dropped file to current local directory
          for (const file of files) {
            const srcPath = file.path;
            const fileName = file.name;
            const destPath = currentPath + '/' + fileName;
            if (srcPath === destPath) continue;
            try {
              await window.api.fs.copy(srcPath, destPath);
            } catch (err) {
              alert('Copy failed for ' + fileName + ': ' + err.message);
            }
          }
          loadFiles();
        }
      });
    }

    function setupTerminalDropZone() {
      const container = document.getElementById('terminal-container');

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        container.classList.add('drag-over');
      });

      container.addEventListener('dragleave', (e) => {
        container.classList.remove('drag-over');
      });

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        container.classList.remove('drag-over');

        const filePath = e.dataTransfer.getData('text/plain');
        if (filePath) {
          // Escape spaces and special characters for shell
          const escapedPath = escapePathForShell(filePath);
          // Write to active terminal
          const activeTerminal = terminals.find(t =>
            document.getElementById(t.id).classList.contains('active')
          );
          if (activeTerminal) {
            activeTerminal.term.paste(escapedPath);
            activeTerminal.term.focus();
          }
        }
      });
    }

    function escapePathForShell(path) {
      // Escape special characters for shell: spaces, quotes, parentheses, etc.
      return path.replace(/([ '"\\()&;|<>$`!#*?[\]{}])/g, '\\$1');
    }

    // Clipboard operations
    function copyFile() {
      hideContextMenu();
      if (selectedFile) {
        clipboard = { file: selectedFile, action: 'copy' };
        loadFiles();
      }
    }

    function cutFile() {
      hideContextMenu();
      if (selectedFile) {
        clipboard = { file: selectedFile, action: 'cut' };
        loadFiles();
      }
    }

    async function pasteFile() {
      hideContextMenu();
      if (!clipboard.file) return;

      const destPath = currentPath + '/' + clipboard.file.name;
      try {
        if (clipboard.action === 'copy') {
          await window.api.fs.copy(clipboard.file.path, destPath);
        } else {
          await window.api.fs.rename(clipboard.file.path, destPath);
          clipboard = { file: null, action: null };
        }
        loadFiles();
      } catch (err) {
        alert('Could not paste: ' + err.message);
      }
    }

    // Editor with Monaco
    async function openFileInEditor(file) {
      if (appMode === 'ftp' || file.ftpFile) {
        return openFtpFile(file);
      }
      const existingIndex = openFiles.findIndex(f => f.path === file.path);
      if (existingIndex !== -1) {
        activateFile(existingIndex);
        return;
      }

      try {
        const content = await window.api.fs.readFile(file.path);
        openFiles.push({
          path: file.path,
          name: file.name,
          content: content,
          modified: false
        });
        activeFileIndex = openFiles.length - 1;
        updateEditorTabs();
        showEditor();
        setEditorContent(content, file.name);
        updateStatusBar();
      } catch (err) {
        alert('Could not open file: ' + err.message);
      }
    }

    function setEditorContent(content, filename) {
      const container = document.getElementById('editor-container');

      if (!monacoReady) {
        // Fallback to textarea if Monaco not loaded
        container.innerHTML = `<textarea id="editor-fallback" style="width:100%;height:100%;background:#000;color:#ccc;border:none;outline:none;resize:none;font-family:Menlo,Monaco,monospace;font-size:13px;padding:10px;">${content}</textarea>`;
        return;
      }

      if (monacoEditor) {
        monacoEditor.dispose();
      }

      const language = getLanguage(filename);
      monacoEditor = monaco.editor.create(container, {
        value: content,
        language: language,
        theme: settings.theme === 'light' ? 'vs' : 'vs-dark',
        fontSize: settings.fontSize,
        minimap: { enabled: true },
        automaticLayout: true,
        scrollBeyondLastLine: false,
        wordWrap: 'on'
      });

      monacoEditor.onDidChangeModelContent(() => {
        if (activeFileIndex >= 0) {
          openFiles[activeFileIndex].modified = true;
          openFiles[activeFileIndex].content = monacoEditor.getValue();
          updateEditorTabs();
        }
      });

      monacoEditor.onDidChangeCursorPosition((e) => {
        document.getElementById('status-line').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
      });
    }

    function getLanguage(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const langMap = {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'py': 'python',
        'rb': 'ruby',
        'java': 'java',
        'c': 'c',
        'cpp': 'cpp',
        'h': 'c',
        'cs': 'csharp',
        'go': 'go',
        'rs': 'rust',
        'php': 'php',
        'html': 'html',
        'htm': 'html',
        'css': 'css',
        'scss': 'scss',
        'less': 'less',
        'json': 'json',
        'xml': 'xml',
        'yaml': 'yaml',
        'yml': 'yaml',
        'md': 'markdown',
        'sql': 'sql',
        'sh': 'shell',
        'bash': 'shell',
        'zsh': 'shell',
        'ps1': 'powershell',
        'swift': 'swift',
        'kt': 'kotlin',
        'r': 'r',
        'lua': 'lua',
        'pl': 'perl',
        'dockerfile': 'dockerfile'
      };
      return langMap[ext] || 'plaintext';
    }

    function updateEditorTabs() {
      const tabsContainer = document.getElementById('editor-tabs');
      tabsContainer.innerHTML = '';

      openFiles.forEach((file, index) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (index === activeFileIndex ? ' active' : '') + (file.modified ? ' modified' : '');
        tab.innerHTML = `<span>${file.name}</span><span class="tab-close" onclick="closeEditorTab(${index}, event)">✕</span>`;
        tab.onclick = () => activateFile(index);
        tabsContainer.appendChild(tab);
      });
    }

    function activateFile(index) {
      if (activeFileIndex >= 0 && openFiles[activeFileIndex] && monacoEditor) {
        openFiles[activeFileIndex].content = monacoEditor.getValue();
      }

      activeFileIndex = index;
      setEditorContent(openFiles[index].content, openFiles[index].name);
      updateEditorTabs();
      updateStatusBar();
    }

    function closeEditorTab(index, e) {
      e.stopPropagation();

      if (openFiles[index].modified) {
        if (!confirm(`Save changes to ${openFiles[index].name}?`)) {
          // Don't save
        } else {
          saveCurrentFile();
        }
      }

      openFiles.splice(index, 1);

      if (openFiles.length === 0) {
        activeFileIndex = -1;
        hideEditor();
        if (monacoEditor) {
          monacoEditor.dispose();
          monacoEditor = null;
        }
      } else {
        activeFileIndex = Math.min(index, openFiles.length - 1);
        setEditorContent(openFiles[activeFileIndex].content, openFiles[activeFileIndex].name);
      }
      updateEditorTabs();
      updateStatusBar();
    }

    function showEditor() {
      document.getElementById('editor-area').classList.add('visible');
      document.getElementById('terminal-area').classList.add('with-editor');
      document.getElementById('resizer').style.display = 'block';
      terminals.forEach(t => t.fitAddon.fit());
    }

    function hideEditor() {
      document.getElementById('editor-area').classList.remove('visible');
      document.getElementById('terminal-area').classList.remove('with-editor');
      document.getElementById('resizer').style.display = 'none';
      terminals.forEach(t => t.fitAddon.fit());
    }

    async function saveCurrentFile() {
      if (activeFileIndex < 0) return;
      const file = openFiles[activeFileIndex];
      if (monacoEditor) {
        file.content = monacoEditor.getValue();
      }
      if (file.ftpFile || appMode === 'ftp') {
        await window.api.ftp.writeFile(file.path, file.content);
      } else {
        await window.api.fs.writeFile(file.path, file.content);
      }
      file.modified = false;
      updateEditorTabs();
    }

    function updateStatusBar() {
      if (activeFileIndex >= 0) {
        const file = openFiles[activeFileIndex];
        const prefix = file.ftpFile ? 'FTP: ' : '';
        document.getElementById('status-file').textContent = prefix + file.path;
      } else {
        document.getElementById('status-file').textContent = 'No file open';
        document.getElementById('status-line').textContent = '';
      }
    }

    // Resizers
    function setupResizer() {
      const resizer = document.getElementById('resizer');
      const editorArea = document.getElementById('editor-area');
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'ns-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const mainArea = document.getElementById('main-area');
        const rect = mainArea.getBoundingClientRect();
        const editorHeight = e.clientY - rect.top;
        const minHeight = 100;
        const maxHeight = rect.height - 150;

        if (editorHeight > minHeight && editorHeight < maxHeight) {
          editorArea.style.flex = 'none';
          editorArea.style.height = editorHeight + 'px';
          terminals.forEach(t => t.fitAddon.fit());
        }
      });

      document.addEventListener('mouseup', () => {
        isResizing = false;
        document.body.style.cursor = '';
      });
    }

    function setupPanelResizers() {
      // Left panel resizer
      const leftResizer = document.getElementById('left-resizer');
      const leftPanel = document.getElementById('left-panel');
      let leftResizing = false;

      leftResizer.addEventListener('mousedown', () => {
        leftResizing = true;
        document.body.style.cursor = 'ew-resize';
      });

      // Right panel resizer
      const rightResizer = document.getElementById('right-resizer');
      const rightPanel = document.getElementById('right-panel');
      let rightResizing = false;

      rightResizer.addEventListener('mousedown', () => {
        rightResizing = true;
        document.body.style.cursor = 'ew-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (leftResizing) {
          const width = e.clientX;
          if (width >= 200 && width <= 500) {
            leftPanel.style.width = width + 'px';
            terminals.forEach(t => t.fitAddon.fit());
          }
        }
        if (rightResizing) {
          const width = window.innerWidth - e.clientX;
          if (width >= 300 && width <= 700) {
            rightPanel.style.width = width + 'px';
            terminals.forEach(t => t.fitAddon.fit());
          }
        }
      });

      document.addEventListener('mouseup', () => {
        leftResizing = false;
        rightResizing = false;
        leftPanelResizing = false;
        document.body.style.cursor = '';
      });

      // Left panel internal resizer (between file manager and mini browser)
      const leftPanelResizer = document.getElementById('left-panel-resizer');
      const fileManager = document.getElementById('file-manager');
      const miniBrowser = document.getElementById('mini-browser');
      let leftPanelResizing = false;

      leftPanelResizer.addEventListener('mousedown', () => {
        leftPanelResizing = true;
        document.body.style.cursor = 'ns-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (leftPanelResizing) {
          const leftPanel = document.getElementById('left-panel');
          const rect = leftPanel.getBoundingClientRect();
          const offsetY = e.clientY - rect.top;
          const totalHeight = rect.height;
          const minHeight = 100;

          if (offsetY >= minHeight && offsetY <= totalHeight - minHeight) {
            fileManager.style.flex = 'none';
            fileManager.style.height = offsetY + 'px';
            miniBrowser.style.flex = '1';
          }
        }
      });
    }

    async function goHome() {
      if (appMode === 'ftp') {
        currentPath = '/';
        loadFiles();
      } else {
        currentPath = await window.api.fs.getHome();
        loadFiles();
      }
    }

    // Mini Browser functions
    function miniBrowserGo() {
      const webview = document.getElementById('mini-browser-frame');
      let url = document.getElementById('mini-browser-url').value.trim();
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      webview.src = url;
    }

    function miniBrowserBack() {
      const webview = document.getElementById('mini-browser-frame');
      if (webview.canGoBack()) webview.goBack();
    }

    function miniBrowserForward() {
      const webview = document.getElementById('mini-browser-frame');
      if (webview.canGoForward()) webview.goForward();
    }

    function miniBrowserRefresh() {
      const webview = document.getElementById('mini-browser-frame');
      webview.reload();
    }

    function miniBrowserHome() {
      const webview = document.getElementById('mini-browser-frame');
      webview.src = settings.browserHome;
      document.getElementById('mini-browser-url').value = settings.browserHome;
    }

    // Load saved home page immediately and update URL bar on navigation
    (function() {
      const saved = localStorage.getItem('dterm-settings');
      const homePage = saved ? (JSON.parse(saved).browserHome || 'https://duckduckgo.com') : 'https://duckduckgo.com';
      const webview = document.getElementById('mini-browser-frame');
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = homePage;
      if (urlInput) urlInput.value = homePage;
    })();

    document.addEventListener('DOMContentLoaded', () => {
      const webview = document.getElementById('mini-browser-frame');
      const loadingEl = document.getElementById('mini-browser-loading');
      if (webview) {
        webview.addEventListener('did-start-loading', () => {
          loadingEl.classList.add('visible');
        });
        webview.addEventListener('did-stop-loading', () => {
          loadingEl.classList.remove('visible');
        });
        webview.addEventListener('did-navigate', (e) => {
          document.getElementById('mini-browser-url').value = e.url;
        });
        webview.addEventListener('did-navigate-in-page', (e) => {
          document.getElementById('mini-browser-url').value = e.url;
        });
      }
    });

    function goUp() {
      const parent = currentPath.split('/').slice(0, -1).join('/') || '/';
      currentPath = parent;
      loadFiles();
    }

    async function openFolder() {
      const path = await window.api.dialog.openFolder();
      if (path) {
        currentPath = path;
        loadFiles();
      }
    }

    function refresh() {
      loadFiles();
    }

    function showContextMenu(e, file) {
      e.preventDefault();
      selectedFile = file;
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      // Show/hide FTP-specific options
      document.getElementById('ctx-download').style.display = appMode === 'ftp' && !file.isDirectory ? 'block' : 'none';
      document.getElementById('ctx-upload').style.display = appMode === 'ftp' ? 'block' : 'none';
    }

    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
      document.getElementById('terminal-context-menu').style.display = 'none';
    }

    // Terminal context menu
    let activeTerminalForMenu = null;

    function showTerminalContextMenu(e, termId) {
      hideContextMenu();
      activeTerminalForMenu = termId;
      const menu = document.getElementById('terminal-context-menu');
      menu.style.display = 'block';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
    }

    function terminalCopy() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData && termData.term.hasSelection()) {
        navigator.clipboard.writeText(termData.term.getSelection());
      }
    }

    function terminalPaste() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        navigator.clipboard.readText().then(text => {
          termData.term.paste(text);
        });
      }
    }

    function terminalSelectAll() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        termData.term.selectAll();
      }
    }

    function terminalClear() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        termData.term.clear();
      }
    }

    // Command Palette
    const commands = [
      { name: 'New Terminal', icon: '💻', action: () => createTerminal(), shortcut: '⌘T' },
      { name: 'New File', icon: '📄', action: () => newFile() },
      { name: 'New Folder', icon: '📁', action: () => newFolder() },
      { name: 'Open Folder', icon: '📂', action: () => openFolder() },
      { name: 'Save File', icon: '💾', action: () => saveCurrentFile(), shortcut: '⌘S' },
      { name: 'Toggle Sidebar', icon: '◀', action: () => toggleSidebar(), shortcut: '⌘B' },
      { name: 'Settings', icon: '⚙', action: () => showSettings(), shortcut: '⌘,' },
      { name: 'Keyboard Shortcuts', icon: '⌨', action: () => showShortcuts(), shortcut: '⌘/' },
      { name: 'Search in Terminal', icon: '🔍', action: () => openTerminalSearch(), shortcut: '⌘F' },
      { name: 'Clear Terminal', icon: '🧹', action: () => { const t = getActiveTerminalData(); if(t) t.term.clear(); } },
      { name: 'Go Home', icon: '🏠', action: () => goHome() },
      { name: 'Refresh Files', icon: '🔄', action: () => refresh() },
      { name: 'Toggle Hidden Files', icon: '👁', action: () => toggleHidden() },
      { name: 'Notes', icon: '📝', action: () => showRightTab('notes') },
      { name: 'AI Chat', icon: '🤖', action: () => showRightTab('ai') },
    ];

    let selectedCommandIndex = 0;
    let filteredCommands = [...commands];

    function toggleSidebar() {
      const left = document.getElementById('left-panel');
      const resizer = document.getElementById('left-resizer');
      if (left.style.display === 'none') {
        left.style.display = 'flex';
        resizer.style.display = 'block';
      } else {
        left.style.display = 'none';
        resizer.style.display = 'none';
      }
    }

    function showCommandPalette() {
      document.getElementById('command-palette').classList.add('visible');
      document.getElementById('command-palette-input').value = '';
      document.getElementById('command-palette-input').focus();
      selectedCommandIndex = 0;
      filteredCommands = [...commands];
      renderCommands();
    }

    function hideCommandPalette() {
      document.getElementById('command-palette').classList.remove('visible');
    }

    function filterCommands() {
      const query = document.getElementById('command-palette-input').value.toLowerCase();
      filteredCommands = commands.filter(c => c.name.toLowerCase().includes(query));
      selectedCommandIndex = 0;
      renderCommands();
    }

    function renderCommands() {
      const list = document.getElementById('command-palette-list');
      list.innerHTML = '';
      filteredCommands.forEach((cmd, i) => {
        const div = document.createElement('div');
        div.className = 'command-item' + (i === selectedCommandIndex ? ' selected' : '');
        div.innerHTML = `
          <span class="command-icon">${cmd.icon}</span>
          <span class="command-name">${cmd.name}</span>
          ${cmd.shortcut ? `<span class="command-shortcut">${cmd.shortcut}</span>` : ''}
        `;
        div.onclick = () => executeCommand(i);
        div.onmouseenter = () => {
          selectedCommandIndex = i;
          renderCommands();
        };
        list.appendChild(div);
      });
    }

    function executeCommand(index) {
      const cmd = filteredCommands[index];
      if (cmd) {
        hideCommandPalette();
        cmd.action();
      }
    }

    function handleCommandKey(e) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedCommandIndex = Math.min(selectedCommandIndex + 1, filteredCommands.length - 1);
        renderCommands();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
        renderCommands();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        executeCommand(selectedCommandIndex);
      } else if (e.key === 'Escape') {
        hideCommandPalette();
      }
    }

    // File Preview
    const previewableExtensions = {
      image: ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg', 'ico'],
      video: ['mp4', 'webm', 'mov', 'avi'],
      audio: ['mp3', 'wav', 'ogg', 'flac', 'm4a']
    };

    function canPreview(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return previewableExtensions.image.includes(ext) ||
             previewableExtensions.video.includes(ext) ||
             previewableExtensions.audio.includes(ext);
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (previewableExtensions.image.includes(ext)) return 'image';
      if (previewableExtensions.video.includes(ext)) return 'video';
      if (previewableExtensions.audio.includes(ext)) return 'audio';
      return null;
    }

    function showFilePreview(file) {
      const container = document.getElementById('file-preview-container');
      const type = getFileType(file.name);
      const fileUrl = 'file://' + file.path;

      if (type === 'image') {
        container.innerHTML = `<img src="${fileUrl}" alt="${file.name}"><div id="file-preview-name">${file.name}</div>`;
      } else if (type === 'video') {
        container.innerHTML = `<video src="${fileUrl}" controls autoplay><div id="file-preview-name">${file.name}</div>`;
      } else if (type === 'audio') {
        container.innerHTML = `<div style="padding:40px;text-align:center;"><div style="font-size:48px;margin-bottom:20px;">🎵</div><audio src="${fileUrl}" controls autoplay></audio><div id="file-preview-name">${file.name}</div></div>`;
      }

      document.getElementById('file-preview-overlay').classList.add('visible');
    }

    function closeFilePreview() {
      document.getElementById('file-preview-overlay').classList.remove('visible');
      document.getElementById('file-preview-container').innerHTML = '';
    }

    // Terminal search
    function openTerminalSearch() {
      const searchEl = document.getElementById('terminal-search');
      searchEl.classList.add('visible');
      document.getElementById('terminal-search-input').focus();
    }

    function closeTerminalSearch() {
      document.getElementById('terminal-search').classList.remove('visible');
      document.getElementById('terminal-search-input').value = '';
      document.getElementById('terminal-search-count').textContent = '';
    }

    function getActiveTerminalData() {
      return terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
    }

    function terminalSearchNext() {
      const termData = getActiveTerminalData();
      const query = document.getElementById('terminal-search-input').value;
      if (termData && query) {
        termData.searchAddon.findNext(query);
      }
    }

    function terminalSearchPrev() {
      const termData = getActiveTerminalData();
      const query = document.getElementById('terminal-search-input').value;
      if (termData && query) {
        termData.searchAddon.findPrevious(query);
      }
    }

    function handleTerminalSearchKey(e) {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          terminalSearchPrev();
        } else {
          terminalSearchNext();
        }
      } else if (e.key === 'Escape') {
        closeTerminalSearch();
      }
    }

    function openSelectedFile() {
      hideContextMenu();
      if (selectedFile) {
        handleDoubleClick(selectedFile);
      }
    }

    function previewSelectedFile() {
      hideContextMenu();
      if (selectedFile && canPreview(selectedFile.name)) {
        showFilePreview(selectedFile);
      }
    }

    async function deleteFile() {
      hideContextMenu();
      if (selectedFile && confirm(`Delete "${selectedFile.name}"?`)) {
        try {
          if (appMode === 'ftp') {
            await window.api.ftp.delete(selectedFile.path, selectedFile.isDirectory);
          } else {
            await window.api.fs.delete(selectedFile.path);
          }
          loadFiles();
        } catch (err) {
          alert('Delete failed: ' + err.message);
        }
      }
    }

    async function downloadFtpFile() {
      hideContextMenu();
      if (!selectedFile || selectedFile.isDirectory) return;
      try {
        const localPath = await window.api.dialog.saveFile(selectedFile.name);
        if (!localPath) return;
        await window.api.ftp.downloadToLocal(selectedFile.path, localPath);
        document.getElementById('ftp-status').textContent = `Downloaded: ${selectedFile.name}`;
      } catch (err) {
        alert('Download failed: ' + err.message);
      }
    }

    async function uploadFtpFile() {
      hideContextMenu();
      try {
        const localPath = await window.api.dialog.openFile();
        if (!localPath) return;
        const fileName = localPath.split('/').pop();
        const remotePath = currentPath === '/' ? '/' + fileName : currentPath + '/' + fileName;
        await window.api.ftp.uploadFromLocal(localPath, remotePath);
        document.getElementById('ftp-status').textContent = `Uploaded: ${fileName}`;
        loadFiles();
      } catch (err) {
        alert('Upload failed: ' + err.message);
      }
    }

    document.addEventListener('click', (e) => {
      hideContextMenu();
      if (!e.target.closest('#command-palette')) {
        hideCommandPalette();
      }
    });

    // Input dialog
    let inputDialogCallback = null;

    function showInputDialog(title, defaultValue = '') {
      return new Promise((resolve) => {
        document.getElementById('input-dialog-title').textContent = title;
        document.getElementById('input-dialog-input').value = defaultValue;
        document.getElementById('input-dialog').style.display = 'flex';
        document.getElementById('input-dialog-input').focus();
        inputDialogCallback = resolve;
      });
    }

    function closeInputDialog() {
      document.getElementById('input-dialog').style.display = 'none';
      if (inputDialogCallback) {
        inputDialogCallback(null);
        inputDialogCallback = null;
      }
    }

    function confirmInputDialog() {
      const value = document.getElementById('input-dialog-input').value;
      document.getElementById('input-dialog').style.display = 'none';
      if (inputDialogCallback) {
        inputDialogCallback(value);
        inputDialogCallback = null;
      }
    }

    document.getElementById('input-dialog-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') confirmInputDialog();
      if (e.key === 'Escape') closeInputDialog();
    });

    async function newFile() {
      const name = await showInputDialog('Enter file name:');
      if (name && name.trim()) {
        const filePath = currentPath + '/' + name.trim();
        try {
          await window.api.fs.writeFile(filePath, '');
          loadFiles();
          await openFileInEditor({ path: filePath, name: name.trim(), isDirectory: false });
        } catch (err) {
          alert('Could not create file: ' + err.message);
        }
      }
    }

    async function newFolder() {
      const name = await showInputDialog('Enter folder name:');
      if (name && name.trim()) {
        const folderPath = currentPath + '/' + name.trim();
        try {
          await window.api.fs.mkdir(folderPath);
          loadFiles();
        } catch (err) {
          alert('Could not create folder: ' + err.message);
        }
      }
    }

    async function renameFile() {
      hideContextMenu();
      if (!selectedFile) return;
      const newName = await showInputDialog('Enter new name:', selectedFile.name);
      if (newName && newName.trim() && newName !== selectedFile.name) {
        const newPath = currentPath + '/' + newName.trim();
        try {
          await window.api.fs.rename(selectedFile.path, newPath);
          loadFiles();
        } catch (err) {
          alert('Could not rename: ' + err.message);
        }
      }
    }

    // Terminal
    function createTerminal(shell) {
      const id = 'term-' + Date.now();
      const container = document.createElement('div');
      container.className = 'terminal-panel';
      container.id = id;
      document.getElementById('terminal-container').appendChild(container);

      const term = new Terminal({
        fontSize: 13,
        fontFamily: 'Menlo, Monaco, monospace',
        theme: {
          background: '#000000',
          foreground: '#cccccc',
          cursor: '#ffffff',
          cursorAccent: '#000000',
          selectionBackground: '#0066cc'
        },
        cursorBlink: true
      });

      const fitAddon = new FitAddon.FitAddon();
      const searchAddon = new SearchAddon.SearchAddon();
      term.loadAddon(fitAddon);
      term.loadAddon(searchAddon);
      term.open(container);
      fitAddon.fit();

      const shellToUse = shell || settings.shell || '/bin/zsh';
      window.api.terminal.create(id, shellToUse);

      term.onData(data => window.api.terminal.write(id, data));
      term.onResize(({ cols, rows }) => window.api.terminal.resize(id, cols, rows));

      const shellName = shellToUse.split('/').pop();
      const termData = { id, term, fitAddon, searchAddon, name: shellName };
      terminals.push(termData);

      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.id = 'tab-' + id;
      tab.innerHTML = `<span>${shellName}</span><span class="tab-close" onclick="closeTerminal('${id}', event)">✕</span>`;
      tab.onclick = () => activateTerminal(id);
      document.getElementById('terminal-tabs').insertBefore(tab, document.getElementById('new-term-btn'));

      activateTerminal(id);
      new ResizeObserver(() => fitAddon.fit()).observe(container);

      // Terminal context menu
      container.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showTerminalContextMenu(e, id);
      });
    }

    function activateTerminal(id) {
      document.querySelectorAll('.terminal-panel').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('#terminal-tabs .tab').forEach(el => el.classList.remove('active'));

      document.getElementById(id).classList.add('active');
      document.getElementById('tab-' + id).classList.add('active');

      const termData = terminals.find(t => t.id === id);
      if (termData) {
        termData.fitAddon.fit();
        termData.term.focus();
      }
    }

    function closeTerminal(id, e) {
      e.stopPropagation();
      window.api.terminal.kill(id);

      const idx = terminals.findIndex(t => t.id === id);
      if (idx !== -1) {
        terminals[idx].term.dispose();
        terminals.splice(idx, 1);
      }

      document.getElementById(id).remove();
      document.getElementById('tab-' + id).remove();

      if (terminals.length > 0) {
        activateTerminal(terminals[terminals.length - 1].id);
      }
    }

    window.api.terminal.onData((id, data) => {
      const termData = terminals.find(t => t.id === id);
      if (termData) termData.term.write(data);
    });

    window.api.terminal.onExit((id, code) => {
      const termData = terminals.find(t => t.id === id);
      if (termData) termData.term.write(`\r\n[Process exited with code ${code}]\r\n`);
    });

    // Right Panel
    function showRightTab(tab) {
      const aiFrame = document.getElementById('ai-frame');
      const toolsContent = document.getElementById('tools-content');
      const toolsPanel = document.getElementById('right-tools-panel');
      const notesPanel = document.getElementById('right-notes-panel');
      const select = document.getElementById('ai-select');
      const tabs = document.querySelectorAll('.right-tab');

      tabs.forEach(t => t.classList.remove('active'));

      notesPanel.style.display = 'none';
      toolsPanel.style.display = 'none';
      toolsContent.style.display = 'none';
      aiFrame.style.display = 'none';
      select.style.display = 'none';

      if (tab === 'notes') {
        tabs[0].classList.add('active');
        notesPanel.style.display = 'flex';
      } else if (tab === 'tools') {
        tabs[1].classList.add('active');
        if (activeToolName) {
          toolsContent.style.display = 'flex';
        } else {
          toolsPanel.style.display = 'flex';
        }
      } else if (tab === 'ai') {
        tabs[2].classList.add('active');
        aiFrame.style.display = 'flex';
        select.style.display = 'block';
        if (aiFrame.src === 'about:blank') {
          aiFrame.src = select.value;
        }
      }
    }

    // Tools panel - native implementations
    let activeToolName = null;
    let toolMonitorInterval = null;

    function openTool(name) {
      if (toolMonitorInterval) { clearInterval(toolMonitorInterval); toolMonitorInterval = null; }
      activeToolName = name;
      const toolsContent = document.getElementById('tools-content');
      const toolsPanel = document.getElementById('right-tools-panel');
      toolsPanel.style.display = 'none';
      toolsContent.style.display = 'flex';
      const renderer = toolRenderers[name];
      if (renderer) renderer(toolsContent);
      else toolsContent.innerHTML = '<div class="tool-header"><button class="tool-back-btn" onclick="showToolsList()">←</button><span class="tool-title">Unknown Tool</span></div>';
    }

    function showToolsList() {
      if (toolMonitorInterval) { clearInterval(toolMonitorInterval); toolMonitorInterval = null; }
      activeToolName = null;
      const toolsContent = document.getElementById('tools-content');
      const toolsPanel = document.getElementById('right-tools-panel');
      toolsContent.style.display = 'none';
      toolsContent.innerHTML = '';
      toolsPanel.style.display = 'flex';
    }

    function toolHeader(title) {
      return `<div class="tool-header"><button class="tool-back-btn" onclick="showToolsList()">←</button><span class="tool-title">${title}</span></div>`;
    }

    function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    const toolRenderers = {

      // ========== NETWORK ==========

      'ping': (el) => {
        el.innerHTML = toolHeader('Ping') + `<div class="tool-body">
          <label>Host / IP</label><input class="tool-input" id="t-ping-host" placeholder="e.g. google.com">
          <label>Count</label><input class="tool-input" id="t-ping-count" value="4" placeholder="4">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPing()">Ping</button></div>
          <div class="tool-output" id="t-ping-out" style="display:none;"></div></div>`;
      },

      'traceroute': (el) => {
        el.innerHTML = toolHeader('Traceroute') + `<div class="tool-body">
          <label>Host / IP</label><input class="tool-input" id="t-trace-host" placeholder="e.g. google.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunTraceroute()">Trace</button></div>
          <div class="tool-output" id="t-trace-out" style="display:none;"></div></div>`;
      },

      'dns-lookup': (el) => {
        el.innerHTML = toolHeader('DNS Lookup') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-dns-host" placeholder="e.g. example.com">
          <label>Record Type</label>
          <select class="tool-input" id="t-dns-type"><option>A</option><option>AAAA</option><option>MX</option><option>NS</option><option>TXT</option><option>CNAME</option><option>SOA</option><option>ANY</option></select>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunDns()">Lookup</button></div>
          <div class="tool-output" id="t-dns-out" style="display:none;"></div></div>`;
      },

      'reverse-dns': (el) => {
        el.innerHTML = toolHeader('Reverse DNS') + `<div class="tool-body">
          <label>IP Address</label><input class="tool-input" id="t-rdns-ip" placeholder="e.g. 8.8.8.8">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunReverseDns()">Lookup</button></div>
          <div class="tool-output" id="t-rdns-out" style="display:none;"></div></div>`;
      },

      'port-scanner': (el) => {
        el.innerHTML = toolHeader('Port Scanner') + `<div class="tool-body">
          <label>Host</label><input class="tool-input" id="t-port-host" placeholder="e.g. example.com">
          <label>Ports (comma-separated)</label><input class="tool-input" id="t-port-ports" value="21,22,25,53,80,110,143,443,993,995,3306,3389,5432,8080,8443" placeholder="80,443,...">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPortScan()">Scan</button></div>
          <div class="tool-output" id="t-port-out" style="display:none;"></div></div>`;
      },

      'ip-info': (el) => {
        el.innerHTML = toolHeader('IP Info') + `<div class="tool-body">
          <label>IP or Domain (blank for your IP)</label><input class="tool-input" id="t-ipinfo-host" placeholder="Leave blank for your public IP">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunIpInfo()">Lookup</button></div>
          <div id="t-ipinfo-out"></div></div>`;
      },

      'whois': (el) => {
        el.innerHTML = toolHeader('Whois') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-whois-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunWhois()">Lookup</button></div>
          <div class="tool-output" id="t-whois-out" style="display:none;"></div></div>`;
      },

      'mac-lookup': (el) => {
        el.innerHTML = toolHeader('MAC Lookup') + `<div class="tool-body">
          <label>MAC Address</label><input class="tool-input" id="t-mac-addr" placeholder="e.g. 00:1A:2B:3C:4D:5E">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunMacLookup()">Lookup</button></div>
          <div class="tool-output" id="t-mac-out" style="display:none;"></div></div>`;
      },

      'subnet-calc': (el) => {
        el.innerHTML = toolHeader('Subnet Calculator') + `<div class="tool-body">
          <label>IP Address</label><input class="tool-input" id="t-subnet-ip" placeholder="e.g. 192.168.1.0">
          <label>CIDR / Mask</label><input class="tool-input" id="t-subnet-cidr" value="24" placeholder="24 or 255.255.255.0">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSubnet()">Calculate</button></div>
          <div id="t-subnet-out"></div></div>`;
      },

      'ping-monitor': (el) => {
        el.innerHTML = toolHeader('Ping Monitor') + `<div class="tool-body">
          <label>Host / IP</label><input class="tool-input" id="t-pingmon-host" placeholder="e.g. google.com">
          <label>Interval (seconds)</label><input class="tool-input" id="t-pingmon-int" value="5">
          <div class="tool-row"><button class="tool-run-btn" id="t-pingmon-btn" onclick="toolTogglePingMonitor()">Start</button></div>
          <div class="tool-output" id="t-pingmon-out" style="display:none;"></div></div>`;
      },

      'uptime-monitor': (el) => {
        el.innerHTML = toolHeader('Uptime Monitor') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-upmon-url" placeholder="e.g. https://example.com">
          <label>Interval (seconds)</label><input class="tool-input" id="t-upmon-int" value="10">
          <div class="tool-row"><button class="tool-run-btn" id="t-upmon-btn" onclick="toolToggleUptimeMonitor()">Start</button></div>
          <div class="tool-output" id="t-upmon-out" style="display:none;"></div></div>`;
      },

      'blacklist-check': (el) => {
        el.innerHTML = toolHeader('Blacklist Check') + `<div class="tool-body">
          <label>IP Address</label><input class="tool-input" id="t-bl-ip" placeholder="e.g. 1.2.3.4">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunBlacklist()">Check</button></div>
          <div class="tool-output" id="t-bl-out" style="display:none;"></div></div>`;
      },

      // ========== SSL / SECURITY ==========

      'ssl-checker': (el) => {
        el.innerHTML = toolHeader('SSL Checker') + `<div class="tool-body">
          <label>Host</label><input class="tool-input" id="t-ssl-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSslCheck()">Check</button></div>
          <div class="tool-output" id="t-ssl-out" style="display:none;"></div></div>`;
      },

      'ssl-expiry': (el) => {
        el.innerHTML = toolHeader('SSL Expiry') + `<div class="tool-body">
          <label>Host</label><input class="tool-input" id="t-sslexp-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSslExpiry()">Check</button></div>
          <div class="tool-output" id="t-sslexp-out" style="display:none;"></div></div>`;
      },

      'security-headers': (el) => {
        el.innerHTML = toolHeader('Security Headers') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-sechdr-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSecHeaders()">Check</button></div>
          <div id="t-sechdr-out"></div></div>`;
      },

      'password-generator': (el) => {
        el.innerHTML = toolHeader('Password Generator') + `<div class="tool-body">
          <label>Length</label><input class="tool-input" id="t-pwgen-len" type="number" value="16">
          <label>Options</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <label style="margin:0;color:#ccc;font-size:12px;"><input type="checkbox" id="t-pwgen-upper" checked> A-Z</label>
            <label style="margin:0;color:#ccc;font-size:12px;"><input type="checkbox" id="t-pwgen-lower" checked> a-z</label>
            <label style="margin:0;color:#ccc;font-size:12px;"><input type="checkbox" id="t-pwgen-digits" checked> 0-9</label>
            <label style="margin:0;color:#ccc;font-size:12px;"><input type="checkbox" id="t-pwgen-symbols" checked> !@#$</label>
          </div>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPwGen()">Generate</button><button class="tool-secondary-btn" onclick="toolCopyPw()">Copy</button></div>
          <div class="tool-output" id="t-pwgen-out" style="display:none;font-size:14px;"></div></div>`;
      },

      'password-checker': (el) => {
        el.innerHTML = toolHeader('Password Checker') + `<div class="tool-body">
          <label>Password</label><input class="tool-input" id="t-pwchk-pw" type="text" placeholder="Enter password to check">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPwCheck()">Check</button></div>
          <div id="t-pwchk-out"></div></div>`;
      },

      'hash-generator': (el) => {
        el.innerHTML = toolHeader('Hash Generator') + `<div class="tool-body">
          <label>Input Text</label><textarea class="tool-textarea" id="t-hash-input" placeholder="Text to hash..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunHash()">Generate</button></div>
          <div id="t-hash-out"></div></div>`;
      },

      // ========== WEB / SEO ==========

      'seo-analyzer': (el) => {
        el.innerHTML = toolHeader('SEO Analyzer') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-seo-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSeo()">Analyze</button></div>
          <div id="t-seo-out"></div></div>`;
      },

      'page-speed': (el) => {
        el.innerHTML = toolHeader('Page Speed') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-speed-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunPageSpeed()">Test</button></div>
          <div id="t-speed-out"></div></div>`;
      },

      'broken-links': (el) => {
        el.innerHTML = toolHeader('Broken Links') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-blinks-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunBrokenLinks()">Check</button></div>
          <div class="tool-output" id="t-blinks-out" style="display:none;"></div></div>`;
      },

      'http-headers': (el) => {
        el.innerHTML = toolHeader('HTTP Headers') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-hdrs-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunHttpHeaders()">Fetch</button></div>
          <div class="tool-output" id="t-hdrs-out" style="display:none;"></div></div>`;
      },

      'open-graph': (el) => {
        el.innerHTML = toolHeader('Open Graph') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-og-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunOpenGraph()">Fetch</button></div>
          <div id="t-og-out"></div></div>`;
      },

      'meta-tags': (el) => {
        el.innerHTML = toolHeader('Meta Tags') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-meta-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunMetaTags()">Fetch</button></div>
          <div id="t-meta-out"></div></div>`;
      },

      'robots-txt': (el) => {
        el.innerHTML = toolHeader('Robots.txt') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-robots-url" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunRobots()">Fetch</button></div>
          <div class="tool-output" id="t-robots-out" style="display:none;"></div></div>`;
      },

      'sitemap-generator': (el) => {
        el.innerHTML = toolHeader('Sitemap Generator') + `<div class="tool-body">
          <label>URL</label><input class="tool-input" id="t-sitemap-url" placeholder="e.g. https://example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunSitemap()">Crawl</button></div>
          <div class="tool-output" id="t-sitemap-out" style="display:none;"></div></div>`;
      },

      'domain-expiry': (el) => {
        el.innerHTML = toolHeader('Domain Expiry') + `<div class="tool-body">
          <label>Domain</label><input class="tool-input" id="t-domexp-host" placeholder="e.g. example.com">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunDomainExpiry()">Check</button></div>
          <div class="tool-output" id="t-domexp-out" style="display:none;"></div></div>`;
      },

      // ========== DEVELOPER ==========

      'api-tester': (el) => {
        el.innerHTML = toolHeader('API Tester') + `<div class="tool-body">
          <label>Method</label>
          <select class="tool-input" id="t-api-method"><option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option><option>HEAD</option></select>
          <label>URL</label><input class="tool-input" id="t-api-url" placeholder="https://api.example.com/data">
          <label>Headers (JSON)</label><textarea class="tool-textarea" id="t-api-headers" placeholder='{"Content-Type": "application/json"}'></textarea>
          <label>Body</label><textarea class="tool-textarea" id="t-api-body" placeholder='{"key": "value"}'></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunApi()">Send</button></div>
          <div class="tool-output" id="t-api-out" style="display:none;"></div></div>`;
      },

      'json-formatter': (el) => {
        el.innerHTML = toolHeader('JSON Formatter') + `<div class="tool-body">
          <label>Input JSON</label><textarea class="tool-textarea" id="t-json-input" style="min-height:100px;" placeholder='{"key":"value"}'></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunJsonFormat()">Format</button><button class="tool-secondary-btn" onclick="toolJsonMinify()">Minify</button></div>
          <div class="tool-output" id="t-json-out" style="display:none;"></div></div>`;
      },

      'code-beautifier': (el) => {
        el.innerHTML = toolHeader('Code Beautifier') + `<div class="tool-body">
          <label>Code</label><textarea class="tool-textarea" id="t-beautify-input" style="min-height:120px;" placeholder="Paste code here..."></textarea>
          <label>Indent</label>
          <select class="tool-input" id="t-beautify-indent"><option value="2">2 spaces</option><option value="4">4 spaces</option><option value="tab">Tab</option></select>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunBeautify()">Beautify</button></div>
          <div class="tool-output" id="t-beautify-out" style="display:none;"></div></div>`;
      },

      'regex-tester': (el) => {
        el.innerHTML = toolHeader('Regex Tester') + `<div class="tool-body">
          <label>Pattern</label><input class="tool-input" id="t-regex-pattern" placeholder="e.g. \\d+">
          <label>Flags</label><input class="tool-input" id="t-regex-flags" value="g" placeholder="g, i, m...">
          <label>Test String</label><textarea class="tool-textarea" id="t-regex-input" placeholder="Text to test against..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunRegex()">Test</button></div>
          <div class="tool-output" id="t-regex-out" style="display:none;"></div></div>`;
      },

      'base64': (el) => {
        el.innerHTML = toolHeader('Base64') + `<div class="tool-body">
          <label>Input</label><textarea class="tool-textarea" id="t-b64-input" style="min-height:80px;" placeholder="Text to encode/decode..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunB64Encode()">Encode</button><button class="tool-secondary-btn" onclick="toolRunB64Decode()">Decode</button></div>
          <label>Output</label><textarea class="tool-textarea" id="t-b64-output" style="min-height:80px;" readonly></textarea></div>`;
      },

      'jwt-decoder': (el) => {
        el.innerHTML = toolHeader('JWT Decoder') + `<div class="tool-body">
          <label>JWT Token</label><textarea class="tool-textarea" id="t-jwt-input" placeholder="eyJhbGciOiJIUzI1NiIs..."></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunJwt()">Decode</button></div>
          <div id="t-jwt-out"></div></div>`;
      },

      'cron-parser': (el) => {
        el.innerHTML = toolHeader('Cron Parser') + `<div class="tool-body">
          <label>Cron Expression</label><input class="tool-input" id="t-cron-input" placeholder="e.g. */5 * * * *">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunCron()">Parse</button></div>
          <div class="tool-output" id="t-cron-out" style="display:none;"></div></div>`;
      },

      'uuid-generator': (el) => {
        el.innerHTML = toolHeader('UUID Generator') + `<div class="tool-body">
          <label>Count</label><input class="tool-input" id="t-uuid-count" type="number" value="1" min="1" max="100">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunUuid()">Generate</button><button class="tool-secondary-btn" onclick="toolCopyUuid()">Copy</button></div>
          <div class="tool-output" id="t-uuid-out" style="display:none;"></div></div>`;
      },

      'timestamp-converter': (el) => {
        el.innerHTML = toolHeader('Timestamp Converter') + `<div class="tool-body">
          <label>Unix Timestamp</label><input class="tool-input" id="t-ts-unix" placeholder="e.g. 1700000000">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunTsToDate()">→ Date</button><button class="tool-secondary-btn" onclick="toolRunTsNow()">Now</button></div>
          <label>Date String</label><input class="tool-input" id="t-ts-date" placeholder="e.g. 2024-01-15 12:00:00">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunDateToTs()">→ Timestamp</button></div>
          <div class="tool-output" id="t-ts-out" style="display:none;"></div></div>`;
      },

      // ========== UTILITIES ==========

      'markdown-preview': (el) => {
        el.innerHTML = toolHeader('Markdown Preview') + `<div class="tool-body">
          <label>Markdown</label><textarea class="tool-textarea" id="t-md-input" style="min-height:120px;" placeholder="# Hello World"></textarea>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunMarkdown()">Preview</button></div>
          <div id="t-md-out" style="margin-top:10px;padding:8px;background:#1a1a1a;border-radius:4px;color:#ccc;font-size:12px;"></div></div>`;
      },

      'lorem-ipsum': (el) => {
        el.innerHTML = toolHeader('Lorem Ipsum') + `<div class="tool-body">
          <label>Paragraphs</label><input class="tool-input" id="t-lorem-count" type="number" value="3" min="1" max="20">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunLorem()">Generate</button><button class="tool-secondary-btn" onclick="toolCopyLorem()">Copy</button></div>
          <div class="tool-output" id="t-lorem-out" style="display:none;color:#ccc;"></div></div>`;
      },

      'qr-generator': (el) => {
        el.innerHTML = toolHeader('QR Generator') + `<div class="tool-body">
          <label>Text / URL</label><input class="tool-input" id="t-qr-input" placeholder="Enter text or URL">
          <div class="tool-row"><button class="tool-run-btn" onclick="toolRunQr()">Generate</button></div>
          <div id="t-qr-out" style="margin-top:10px;text-align:center;"></div></div>`;
      },

      'color-picker': (el) => {
        el.innerHTML = toolHeader('Color Picker') + `<div class="tool-body">
          <label>Color</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="color" id="t-color-picker" value="#0066cc" style="width:40px;height:32px;border:none;background:none;cursor:pointer;">
            <input class="tool-input" id="t-color-hex" value="#0066cc" style="flex:1;" oninput="toolUpdateColor()">
          </div>
          <div class="tool-row"><button class="tool-run-btn" onclick="toolConvertColor()">Convert</button></div>
          <div id="t-color-out"></div></div>`;
        document.getElementById('t-color-picker').addEventListener('input', (e) => {
          document.getElementById('t-color-hex').value = e.target.value;
        });
      },
    };

    // ========== TOOL FUNCTION IMPLEMENTATIONS ==========

    // --- Network ---
    async function toolRunPing() {
      const host = document.getElementById('t-ping-host').value.trim();
      const count = document.getElementById('t-ping-count').value || '4';
      if (!host) return;
      const out = document.getElementById('t-ping-out');
      out.style.display = 'block'; out.textContent = 'Pinging...';
      const r = await window.api.tools.exec(`ping -c ${parseInt(count)} ${host}`);
      out.textContent = r.stdout || r.stderr || r.error || 'No response';
      if (r.error && !r.stdout) out.classList.add('error'); else out.classList.remove('error');
    }

    async function toolRunTraceroute() {
      const host = document.getElementById('t-trace-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-trace-out');
      out.style.display = 'block'; out.textContent = 'Tracing route... (may take a moment)';
      const r = await window.api.tools.exec(`traceroute -m 20 ${host}`);
      out.textContent = r.stdout || r.stderr || r.error || 'No response';
    }

    async function toolRunDns() {
      const host = document.getElementById('t-dns-host').value.trim();
      const type = document.getElementById('t-dns-type').value;
      if (!host) return;
      const out = document.getElementById('t-dns-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const r = await window.api.tools.exec(`dig ${host} ${type} +noall +answer`);
      out.textContent = r.stdout || r.stderr || r.error || 'No records found';
    }

    async function toolRunReverseDns() {
      const ip = document.getElementById('t-rdns-ip').value.trim();
      if (!ip) return;
      const out = document.getElementById('t-rdns-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const r = await window.api.tools.exec(`dig -x ${ip} +noall +answer`);
      out.textContent = r.stdout || r.stderr || r.error || 'No PTR record found';
    }

    async function toolRunPortScan() {
      const host = document.getElementById('t-port-host').value.trim();
      const ports = document.getElementById('t-port-ports').value.trim();
      if (!host || !ports) return;
      const out = document.getElementById('t-port-out');
      out.style.display = 'block'; out.textContent = 'Scanning ports...';
      const portList = ports.split(',').map(p => p.trim()).filter(p => p);
      let results = '';
      for (const port of portList) {
        const r = await window.api.tools.exec(`nc -z -w 2 ${host} ${port}`);
        const open = !r.error;
        results += `Port ${port}: ${open ? '✓ OPEN' : '✗ closed'}\n`;
        out.textContent = results;
      }
    }

    async function toolRunIpInfo() {
      const host = document.getElementById('t-ipinfo-host').value.trim();
      const out = document.getElementById('t-ipinfo-out');
      out.innerHTML = '<div class="tool-status">Fetching...</div>';
      const url = host ? `http://ip-api.com/json/${host}` : 'http://ip-api.com/json/';
      const r = await window.api.tools.exec(`curl -s "${url}"`);
      try {
        const d = JSON.parse(r.stdout);
        out.innerHTML = `<table class="tool-result-table">
          <tr><td>IP</td><td>${escHtml(d.query||'')}</td></tr>
          <tr><td>Country</td><td>${escHtml(d.country||'')} (${escHtml(d.countryCode||'')})</td></tr>
          <tr><td>Region</td><td>${escHtml(d.regionName||'')}</td></tr>
          <tr><td>City</td><td>${escHtml(d.city||'')}</td></tr>
          <tr><td>ZIP</td><td>${escHtml(d.zip||'')}</td></tr>
          <tr><td>ISP</td><td>${escHtml(d.isp||'')}</td></tr>
          <tr><td>Org</td><td>${escHtml(d.org||'')}</td></tr>
          <tr><td>AS</td><td>${escHtml(d.as||'')}</td></tr>
          <tr><td>Timezone</td><td>${escHtml(d.timezone||'')}</td></tr>
          <tr><td>Lat/Lon</td><td>${d.lat}, ${d.lon}</td></tr></table>`;
      } catch { out.innerHTML = `<div class="tool-output">${escHtml(r.stdout || r.error || 'Error')}</div>`; }
    }

    async function toolRunWhois() {
      const host = document.getElementById('t-whois-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-whois-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const r = await window.api.tools.exec(`whois ${host}`);
      out.textContent = r.stdout || r.stderr || r.error || 'No data';
    }

    async function toolRunMacLookup() {
      const mac = document.getElementById('t-mac-addr').value.trim();
      if (!mac) return;
      const out = document.getElementById('t-mac-out');
      out.style.display = 'block'; out.textContent = 'Looking up...';
      const prefix = mac.replace(/[^a-fA-F0-9]/g, '').substring(0, 6);
      const r = await window.api.tools.exec(`curl -s "https://api.macvendors.com/${encodeURIComponent(mac)}"`);
      out.textContent = r.stdout || 'Vendor not found';
    }

    function toolRunSubnet() {
      const ipStr = document.getElementById('t-subnet-ip').value.trim();
      const cidrStr = document.getElementById('t-subnet-cidr').value.trim();
      if (!ipStr) return;
      const out = document.getElementById('t-subnet-out');
      let cidr = parseInt(cidrStr);
      if (cidrStr.includes('.')) {
        const parts = cidrStr.split('.').map(Number);
        cidr = parts.reduce((a, b) => a + (b >>> 0).toString(2).split('1').length - 1, 0);
      }
      if (isNaN(cidr) || cidr < 0 || cidr > 32) { out.innerHTML = '<div class="tool-status fail">Invalid CIDR</div>'; return; }
      const ip = ipStr.split('.').map(Number);
      const ipNum = (ip[0]<<24 | ip[1]<<16 | ip[2]<<8 | ip[3]) >>> 0;
      const mask = cidr === 0 ? 0 : (0xFFFFFFFF << (32 - cidr)) >>> 0;
      const network = (ipNum & mask) >>> 0;
      const broadcast = (network | ~mask) >>> 0;
      const firstHost = (network + 1) >>> 0;
      const lastHost = (broadcast - 1) >>> 0;
      const hosts = cidr <= 30 ? Math.pow(2, 32 - cidr) - 2 : (cidr === 31 ? 2 : 1);
      const toIp = n => [(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255].join('.');
      const toMask = c => { const m = c===0?0:(0xFFFFFFFF<<(32-c))>>>0; return toIp(m); };
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>Network</td><td>${toIp(network)}/${cidr}</td></tr>
        <tr><td>Netmask</td><td>${toMask(cidr)}</td></tr>
        <tr><td>Wildcard</td><td>${toIp(~mask >>> 0)}</td></tr>
        <tr><td>Broadcast</td><td>${toIp(broadcast)}</td></tr>
        <tr><td>First Host</td><td>${toIp(firstHost)}</td></tr>
        <tr><td>Last Host</td><td>${toIp(lastHost)}</td></tr>
        <tr><td>Usable Hosts</td><td>${hosts.toLocaleString()}</td></tr>
        <tr><td>IP Class</td><td>${ip[0]<128?'A':ip[0]<192?'B':ip[0]<224?'C':ip[0]<240?'D':'E'}</td></tr></table>`;
    }

    async function toolTogglePingMonitor() {
      const btn = document.getElementById('t-pingmon-btn');
      if (toolMonitorInterval) {
        clearInterval(toolMonitorInterval); toolMonitorInterval = null;
        btn.textContent = 'Start'; return;
      }
      const host = document.getElementById('t-pingmon-host').value.trim();
      const interval = parseInt(document.getElementById('t-pingmon-int').value) || 5;
      if (!host) return;
      btn.textContent = 'Stop';
      const out = document.getElementById('t-pingmon-out');
      out.style.display = 'block'; out.textContent = '';
      const doPing = async () => {
        const time = new Date().toLocaleTimeString();
        const r = await window.api.tools.exec(`ping -c 1 -W 2 ${host}`);
        const match = r.stdout && r.stdout.match(/time[=<]([\d.]+)/);
        const ms = match ? match[1] + ' ms' : 'timeout';
        out.textContent += `[${time}] ${host}: ${ms}\n`;
        out.scrollTop = out.scrollHeight;
      };
      await doPing();
      toolMonitorInterval = setInterval(doPing, interval * 1000);
    }

    async function toolToggleUptimeMonitor() {
      const btn = document.getElementById('t-upmon-btn');
      if (toolMonitorInterval) {
        clearInterval(toolMonitorInterval); toolMonitorInterval = null;
        btn.textContent = 'Start'; return;
      }
      const url = document.getElementById('t-upmon-url').value.trim();
      const interval = parseInt(document.getElementById('t-upmon-int').value) || 10;
      if (!url) return;
      btn.textContent = 'Stop';
      const out = document.getElementById('t-upmon-out');
      out.style.display = 'block'; out.textContent = '';
      const doCheck = async () => {
        const time = new Date().toLocaleTimeString();
        const r = await window.api.tools.exec(`curl -o /dev/null -s -w "%{http_code} %{time_total}s" "${url}"`);
        out.textContent += `[${time}] ${r.stdout || 'error'}\n`;
        out.scrollTop = out.scrollHeight;
      };
      await doCheck();
      toolMonitorInterval = setInterval(doCheck, interval * 1000);
    }

    async function toolRunBlacklist() {
      const ip = document.getElementById('t-bl-ip').value.trim();
      if (!ip) return;
      const out = document.getElementById('t-bl-out');
      out.style.display = 'block'; out.textContent = 'Checking blacklists...';
      const reversed = ip.split('.').reverse().join('.');
      const dnsbls = ['zen.spamhaus.org','bl.spamcop.net','b.barracudacentral.org','dnsbl.sorbs.net','spam.dnsbl.sorbs.net'];
      let results = '';
      for (const bl of dnsbls) {
        const r = await window.api.tools.exec(`dig +short ${reversed}.${bl}`);
        const listed = r.stdout && r.stdout.trim().length > 0;
        results += `${bl}: ${listed ? '⚠ LISTED' : '✓ Clean'}\n`;
        out.textContent = results;
      }
    }

    // --- SSL / Security ---
    async function toolRunSslCheck() {
      const host = document.getElementById('t-ssl-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-ssl-out');
      out.style.display = 'block'; out.textContent = 'Checking SSL...';
      const r = await window.api.tools.exec(`openssl s_client -connect ${host}:443 -servername ${host} </dev/null 2>/dev/null | openssl x509 -noout -subject -issuer -dates -serial`);
      out.textContent = r.stdout || r.stderr || r.error || 'Could not connect';
    }

    async function toolRunSslExpiry() {
      const host = document.getElementById('t-sslexp-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-sslexp-out');
      out.style.display = 'block'; out.textContent = 'Checking...';
      const r = await window.api.tools.exec(`openssl s_client -connect ${host}:443 -servername ${host} </dev/null 2>/dev/null | openssl x509 -noout -dates`);
      if (r.stdout) {
        const lines = r.stdout.trim().split('\n');
        let text = '';
        lines.forEach(line => {
          if (line.startsWith('notBefore=')) text += 'Issued: ' + line.replace('notBefore=', '') + '\n';
          if (line.startsWith('notAfter=')) {
            const dateStr = line.replace('notAfter=', '');
            const expiry = new Date(dateStr);
            const now = new Date();
            const days = Math.floor((expiry - now) / 86400000);
            text += 'Expires: ' + dateStr + '\n';
            text += days > 0 ? `${days} days remaining` : `EXPIRED ${Math.abs(days)} days ago`;
          }
        });
        out.textContent = text;
      } else { out.textContent = r.error || 'Could not connect'; out.classList.add('error'); }
    }

    async function toolRunSecHeaders() {
      const url = document.getElementById('t-sechdr-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-sechdr-out');
      out.innerHTML = '<div class="tool-status">Checking...</div>';
      const r = await window.api.tools.exec(`curl -sI "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not connect</div>'; return; }
      const headers = r.stdout.toLowerCase();
      const checks = [
        ['Strict-Transport-Security', 'strict-transport-security'],
        ['Content-Security-Policy', 'content-security-policy'],
        ['X-Frame-Options', 'x-frame-options'],
        ['X-Content-Type-Options', 'x-content-type-options'],
        ['X-XSS-Protection', 'x-xss-protection'],
        ['Referrer-Policy', 'referrer-policy'],
        ['Permissions-Policy', 'permissions-policy'],
      ];
      let html = '<table class="tool-result-table"><tr><th>Header</th><th>Status</th></tr>';
      checks.forEach(([name, key]) => {
        const found = headers.includes(key);
        html += `<tr><td>${name}</td><td class="tool-status ${found?'ok':'fail'}">${found?'✓ Present':'✗ Missing'}</td></tr>`;
      });
      html += '</table>';
      out.innerHTML = html;
    }

    function toolRunPwGen() {
      const len = parseInt(document.getElementById('t-pwgen-len').value) || 16;
      let chars = '';
      if (document.getElementById('t-pwgen-upper').checked) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      if (document.getElementById('t-pwgen-lower').checked) chars += 'abcdefghijklmnopqrstuvwxyz';
      if (document.getElementById('t-pwgen-digits').checked) chars += '0123456789';
      if (document.getElementById('t-pwgen-symbols').checked) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';
      if (!chars) chars = 'abcdefghijklmnopqrstuvwxyz';
      const arr = new Uint32Array(len);
      crypto.getRandomValues(arr);
      let pw = '';
      for (let i = 0; i < len; i++) pw += chars[arr[i] % chars.length];
      const out = document.getElementById('t-pwgen-out');
      out.style.display = 'block'; out.textContent = pw;
    }

    function toolCopyPw() {
      const text = document.getElementById('t-pwgen-out').textContent;
      if (text) navigator.clipboard.writeText(text);
    }

    function toolRunPwCheck() {
      const pw = document.getElementById('t-pwchk-pw').value;
      const out = document.getElementById('t-pwchk-out');
      if (!pw) { out.innerHTML = ''; return; }
      const len = pw.length;
      const hasUpper = /[A-Z]/.test(pw);
      const hasLower = /[a-z]/.test(pw);
      const hasDigit = /\d/.test(pw);
      const hasSymbol = /[^A-Za-z0-9]/.test(pw);
      let pool = 0;
      if (hasUpper) pool += 26;
      if (hasLower) pool += 26;
      if (hasDigit) pool += 10;
      if (hasSymbol) pool += 32;
      const entropy = Math.floor(len * Math.log2(pool || 1));
      let strength = 'Weak', cls = 'fail';
      if (entropy >= 60) { strength = 'Moderate'; cls = 'warn'; }
      if (entropy >= 80) { strength = 'Strong'; cls = 'ok'; }
      if (entropy >= 100) { strength = 'Very Strong'; cls = 'ok'; }
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>Length</td><td>${len}</td></tr>
        <tr><td>Uppercase</td><td>${hasUpper?'✓':'✗'}</td></tr>
        <tr><td>Lowercase</td><td>${hasLower?'✓':'✗'}</td></tr>
        <tr><td>Digits</td><td>${hasDigit?'✓':'✗'}</td></tr>
        <tr><td>Symbols</td><td>${hasSymbol?'✓':'✗'}</td></tr>
        <tr><td>Entropy</td><td>${entropy} bits</td></tr>
        <tr><td>Strength</td><td class="tool-status ${cls}">${strength}</td></tr></table>`;
    }

    async function toolRunHash() {
      const input = document.getElementById('t-hash-input').value;
      const out = document.getElementById('t-hash-out');
      if (!input) { out.innerHTML = ''; return; }
      const enc = new TextEncoder();
      const data = enc.encode(input);
      const algos = ['SHA-1', 'SHA-256', 'SHA-384', 'SHA-512'];
      let html = '<table class="tool-result-table">';
      for (const algo of algos) {
        const hash = await crypto.subtle.digest(algo, data);
        const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        html += `<tr><td>${algo}</td><td style="word-break:break-all;">${hex}</td></tr>`;
      }
      // MD5 via command
      const r = await window.api.tools.exec(`echo -n "${input.replace(/"/g, '\\"')}" | md5`);
      if (r.stdout) html = `<tr><td>MD5</td><td>${escHtml(r.stdout.trim())}</td></tr>` + html;
      html = '<table class="tool-result-table">' + html.replace('<table class="tool-result-table">', '') + '</table>';
      out.innerHTML = html;
    }

    // --- Web / SEO ---
    async function toolRunSeo() {
      const url = document.getElementById('t-seo-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-seo-out');
      out.innerHTML = '<div class="tool-status">Analyzing...</div>';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not fetch page</div>'; return; }
      const html = r.stdout;
      const getTag = (tag) => { const m = html.match(new RegExp(`<${tag}[^>]*>([^<]*)</${tag}>`, 'i')); return m ? m[1].trim() : 'Not found'; };
      const getMeta = (name) => { const m = html.match(new RegExp(`<meta[^>]*name=["']${name}["'][^>]*content=["']([^"']*)["']`, 'i')) || html.match(new RegExp(`<meta[^>]*content=["']([^"']*)["'][^>]*name=["']${name}["']`, 'i')); return m ? m[1] : 'Not found'; };
      const title = getTag('title');
      const h1s = (html.match(/<h1[^>]*>[^<]*<\/h1>/gi) || []).length;
      const h2s = (html.match(/<h2[^>]*>[^<]*<\/h2>/gi) || []).length;
      const imgs = (html.match(/<img /gi) || []).length;
      const imgsNoAlt = (html.match(/<img (?![^>]*alt=)[^>]*>/gi) || []).length;
      const links = (html.match(/<a /gi) || []).length;
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>Title</td><td>${escHtml(title)} (${title.length} chars)</td></tr>
        <tr><td>Description</td><td>${escHtml(getMeta('description'))}</td></tr>
        <tr><td>Keywords</td><td>${escHtml(getMeta('keywords'))}</td></tr>
        <tr><td>H1 Tags</td><td>${h1s}</td></tr>
        <tr><td>H2 Tags</td><td>${h2s}</td></tr>
        <tr><td>Images</td><td>${imgs} (${imgsNoAlt} missing alt)</td></tr>
        <tr><td>Links</td><td>${links}</td></tr>
        <tr><td>Viewport</td><td>${escHtml(getMeta('viewport'))}</td></tr></table>`;
    }

    async function toolRunPageSpeed() {
      const url = document.getElementById('t-speed-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-speed-out');
      out.innerHTML = '<div class="tool-status">Testing...</div>';
      const r = await window.api.tools.exec(`curl -o /dev/null -s -w "DNS: %{time_namelookup}s\\nConnect: %{time_connect}s\\nTLS: %{time_appconnect}s\\nFirst Byte: %{time_starttransfer}s\\nTotal: %{time_total}s\\nSize: %{size_download} bytes\\nHTTP Code: %{http_code}" "${url}"`);
      if (r.stdout) {
        const lines = r.stdout.split('\n');
        let html = '<table class="tool-result-table">';
        lines.forEach(l => { const [k,v] = l.split(': '); if(k&&v) html += `<tr><td>${escHtml(k)}</td><td>${escHtml(v)}</td></tr>`; });
        html += '</table>';
        out.innerHTML = html;
      } else { out.innerHTML = '<div class="tool-status fail">Could not connect</div>'; }
    }

    async function toolRunBrokenLinks() {
      const url = document.getElementById('t-blinks-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-blinks-out');
      out.style.display = 'block'; out.textContent = 'Fetching page...';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.textContent = 'Could not fetch page'; return; }
      const matches = r.stdout.match(/href=["']([^"']+)["']/gi) || [];
      const links = [...new Set(matches.map(m => m.match(/href=["']([^"']+)["']/i)[1]).filter(l => l.startsWith('http')))].slice(0, 20);
      out.textContent = `Found ${links.length} links. Checking...\n\n`;
      for (const link of links) {
        const c = await window.api.tools.exec(`curl -o /dev/null -s -w "%{http_code}" -L "${link}"`);
        const code = (c.stdout || '').trim();
        const ok = code.startsWith('2') || code.startsWith('3');
        out.textContent += `${ok ? '✓' : '✗'} [${code}] ${link}\n`;
        out.scrollTop = out.scrollHeight;
      }
    }

    async function toolRunHttpHeaders() {
      const url = document.getElementById('t-hdrs-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-hdrs-out');
      out.style.display = 'block'; out.textContent = 'Fetching...';
      const r = await window.api.tools.exec(`curl -sI "${url}"`);
      out.textContent = r.stdout || r.error || 'Could not connect';
    }

    async function toolRunOpenGraph() {
      const url = document.getElementById('t-og-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-og-out');
      out.innerHTML = '<div class="tool-status">Fetching...</div>';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not fetch</div>'; return; }
      const ogTags = r.stdout.match(/<meta[^>]*property=["']og:[^"']*["'][^>]*>/gi) || [];
      if (ogTags.length === 0) { out.innerHTML = '<div class="tool-status warn">No Open Graph tags found</div>'; return; }
      let html = '<table class="tool-result-table">';
      ogTags.forEach(tag => {
        const prop = (tag.match(/property=["']([^"']*)["']/i) || [])[1] || '';
        const content = (tag.match(/content=["']([^"']*)["']/i) || [])[1] || '';
        html += `<tr><td>${escHtml(prop)}</td><td>${escHtml(content)}</td></tr>`;
      });
      html += '</table>';
      out.innerHTML = html;
    }

    async function toolRunMetaTags() {
      const url = document.getElementById('t-meta-url').value.trim();
      if (!url) return;
      const out = document.getElementById('t-meta-out');
      out.innerHTML = '<div class="tool-status">Fetching...</div>';
      const r = await window.api.tools.exec(`curl -sL "${url}"`);
      if (!r.stdout) { out.innerHTML = '<div class="tool-status fail">Could not fetch</div>'; return; }
      const metaTags = r.stdout.match(/<meta[^>]*>/gi) || [];
      let html = '<table class="tool-result-table">';
      metaTags.forEach(tag => {
        const name = (tag.match(/(?:name|property|http-equiv)=["']([^"']*)["']/i) || [])[1] || '';
        const content = (tag.match(/content=["']([^"']*)["']/i) || [])[1] || '';
        if (name || content) html += `<tr><td>${escHtml(name)}</td><td>${escHtml(content)}</td></tr>`;
      });
      html += '</table>';
      out.innerHTML = html;
    }

    async function toolRunRobots() {
      let domain = document.getElementById('t-robots-url').value.trim();
      if (!domain) return;
      if (!domain.startsWith('http')) domain = 'https://' + domain;
      const out = document.getElementById('t-robots-out');
      out.style.display = 'block'; out.textContent = 'Fetching...';
      const r = await window.api.tools.exec(`curl -sL "${domain}/robots.txt"`);
      out.textContent = r.stdout || 'No robots.txt found';
    }

    async function toolRunSitemap() {
      let url = document.getElementById('t-sitemap-url').value.trim();
      if (!url) return;
      if (!url.startsWith('http')) url = 'https://' + url;
      const out = document.getElementById('t-sitemap-out');
      out.style.display = 'block'; out.textContent = 'Fetching sitemap...';
      // Try common sitemap locations
      const locations = ['/sitemap.xml', '/sitemap_index.xml', '/sitemap/sitemap.xml'];
      for (const loc of locations) {
        const r = await window.api.tools.exec(`curl -sL "${url}${loc}"`);
        if (r.stdout && r.stdout.includes('<urlset') || r.stdout && r.stdout.includes('<sitemapindex')) {
          const urls = (r.stdout.match(/<loc>([^<]+)<\/loc>/g) || []).map(m => m.replace(/<\/?loc>/g, ''));
          out.textContent = `Found at ${url}${loc}\n${urls.length} URLs:\n\n${urls.join('\n')}`;
          return;
        }
      }
      out.textContent = 'No sitemap found at common locations.';
    }

    async function toolRunDomainExpiry() {
      const host = document.getElementById('t-domexp-host').value.trim();
      if (!host) return;
      const out = document.getElementById('t-domexp-out');
      out.style.display = 'block'; out.textContent = 'Checking...';
      const r = await window.api.tools.exec(`whois ${host}`);
      if (!r.stdout) { out.textContent = r.error || 'Could not lookup'; return; }
      const expiryMatch = r.stdout.match(/(?:expir|paid-till|validity)[^:]*:\s*(.+)/i);
      if (expiryMatch) {
        const expDate = new Date(expiryMatch[1].trim());
        const now = new Date();
        const days = Math.floor((expDate - now) / 86400000);
        out.textContent = `Domain: ${host}\nExpiry: ${expiryMatch[1].trim()}\n${days > 0 ? days + ' days remaining' : 'EXPIRED ' + Math.abs(days) + ' days ago'}`;
      } else {
        out.textContent = 'Could not find expiry date.\n\nFull WHOIS:\n' + r.stdout.substring(0, 2000);
      }
    }

    // --- Developer ---
    async function toolRunApi() {
      const method = document.getElementById('t-api-method').value;
      const url = document.getElementById('t-api-url').value.trim();
      if (!url) return;
      const headersStr = document.getElementById('t-api-headers').value.trim();
      const body = document.getElementById('t-api-body').value.trim();
      const out = document.getElementById('t-api-out');
      out.style.display = 'block'; out.textContent = 'Sending...';
      let cmd = `curl -s -w "\\n\\n--- Response Info ---\\nHTTP Code: %{http_code}\\nTime: %{time_total}s\\nSize: %{size_download} bytes" -X ${method}`;
      if (headersStr) {
        try {
          const hdrs = JSON.parse(headersStr);
          Object.entries(hdrs).forEach(([k, v]) => { cmd += ` -H "${k}: ${v}"`; });
        } catch {}
      }
      if (body && method !== 'GET' && method !== 'HEAD') cmd += ` -d '${body.replace(/'/g, "'\\''")}'`;
      cmd += ` "${url}"`;
      const r = await window.api.tools.exec(cmd);
      out.textContent = r.stdout || r.error || 'No response';
    }

    function toolRunJsonFormat() {
      const input = document.getElementById('t-json-input').value;
      const out = document.getElementById('t-json-out');
      out.style.display = 'block';
      try {
        const parsed = JSON.parse(input);
        out.textContent = JSON.stringify(parsed, null, 2);
        out.classList.remove('error');
      } catch (e) { out.textContent = 'Error: ' + e.message; out.classList.add('error'); }
    }

    function toolJsonMinify() {
      const input = document.getElementById('t-json-input').value;
      const out = document.getElementById('t-json-out');
      out.style.display = 'block';
      try {
        out.textContent = JSON.stringify(JSON.parse(input));
        out.classList.remove('error');
      } catch (e) { out.textContent = 'Error: ' + e.message; out.classList.add('error'); }
    }

    function toolRunBeautify() {
      const input = document.getElementById('t-beautify-input').value;
      const indentVal = document.getElementById('t-beautify-indent').value;
      const out = document.getElementById('t-beautify-out');
      out.style.display = 'block';
      // Try JSON first
      try {
        const indent = indentVal === 'tab' ? '\t' : parseInt(indentVal);
        out.textContent = JSON.stringify(JSON.parse(input), null, indent);
        return;
      } catch {}
      // Basic HTML/code beautifier
      let indent = 0;
      const indentStr = indentVal === 'tab' ? '\t' : ' '.repeat(parseInt(indentVal));
      const lines = input.replace(/>\s*</g, '>\n<').split('\n');
      const result = lines.map(line => {
        line = line.trim();
        if (line.startsWith('</')) indent = Math.max(0, indent - 1);
        const formatted = indentStr.repeat(indent) + line;
        if (line.startsWith('<') && !line.startsWith('</') && !line.startsWith('<!') && !line.endsWith('/>') && !line.includes('</')) indent++;
        return formatted;
      }).join('\n');
      out.textContent = result;
    }

    function toolRunRegex() {
      const pattern = document.getElementById('t-regex-pattern').value;
      const flags = document.getElementById('t-regex-flags').value;
      const input = document.getElementById('t-regex-input').value;
      const out = document.getElementById('t-regex-out');
      out.style.display = 'block';
      try {
        const re = new RegExp(pattern, flags);
        const matches = [];
        let m;
        if (flags.includes('g')) {
          while ((m = re.exec(input)) !== null) { matches.push({ match: m[0], index: m.index, groups: m.slice(1) }); if (!m[0]) break; }
        } else {
          m = re.exec(input);
          if (m) matches.push({ match: m[0], index: m.index, groups: m.slice(1) });
        }
        if (matches.length === 0) { out.textContent = 'No matches'; return; }
        let text = `${matches.length} match(es):\n\n`;
        matches.forEach((m, i) => {
          text += `Match ${i+1}: "${m.match}" at index ${m.index}\n`;
          if (m.groups.length) text += `  Groups: ${m.groups.map((g,j) => `$${j+1}="${g}"`).join(', ')}\n`;
        });
        out.textContent = text;
        out.classList.remove('error');
      } catch (e) { out.textContent = 'Error: ' + e.message; out.classList.add('error'); }
    }

    function toolRunB64Encode() {
      const input = document.getElementById('t-b64-input').value;
      document.getElementById('t-b64-output').value = btoa(unescape(encodeURIComponent(input)));
    }

    function toolRunB64Decode() {
      const input = document.getElementById('t-b64-input').value;
      try { document.getElementById('t-b64-output').value = decodeURIComponent(escape(atob(input))); }
      catch { document.getElementById('t-b64-output').value = 'Error: Invalid Base64'; }
    }

    function toolRunJwt() {
      const token = document.getElementById('t-jwt-input').value.trim();
      const out = document.getElementById('t-jwt-out');
      if (!token) { out.innerHTML = ''; return; }
      try {
        const parts = token.split('.');
        if (parts.length < 2) throw new Error('Invalid JWT format');
        const decode = (s) => JSON.parse(decodeURIComponent(escape(atob(s.replace(/-/g,'+').replace(/_/g,'/')))));
        const header = decode(parts[0]);
        const payload = decode(parts[1]);
        let html = '<label style="margin-top:10px;">Header</label><div class="tool-output">' + escHtml(JSON.stringify(header, null, 2)) + '</div>';
        html += '<label>Payload</label><div class="tool-output">' + escHtml(JSON.stringify(payload, null, 2)) + '</div>';
        if (payload.exp) {
          const exp = new Date(payload.exp * 1000);
          const now = new Date();
          html += `<div class="tool-status ${exp > now ? 'ok' : 'fail'}">Expires: ${exp.toLocaleString()} (${exp > now ? 'valid' : 'EXPIRED'})</div>`;
        }
        if (payload.iat) html += `<div class="tool-status">Issued: ${new Date(payload.iat * 1000).toLocaleString()}</div>`;
        out.innerHTML = html;
      } catch (e) { out.innerHTML = `<div class="tool-status fail">Error: ${escHtml(e.message)}</div>`; }
    }

    function toolRunCron() {
      const expr = document.getElementById('t-cron-input').value.trim();
      const out = document.getElementById('t-cron-out');
      out.style.display = 'block';
      if (!expr) { out.textContent = ''; return; }
      const parts = expr.split(/\s+/);
      if (parts.length < 5) { out.textContent = 'Need 5 fields: min hour dom month dow'; return; }
      const [min, hour, dom, month, dow] = parts;
      const desc = (val, unit, names) => {
        if (val === '*') return `every ${unit}`;
        if (val.includes('/')) return `every ${val.split('/')[1]} ${unit}(s)`;
        if (val.includes(',')) return `at ${unit} ${val}`;
        if (val.includes('-')) return `${unit} ${val}`;
        if (names && names[parseInt(val)]) return names[parseInt(val)];
        return `at ${unit} ${val}`;
      };
      const dowNames = {0:'Sunday',1:'Monday',2:'Tuesday',3:'Wednesday',4:'Thursday',5:'Friday',6:'Saturday',7:'Sunday'};
      const monNames = {1:'January',2:'February',3:'March',4:'April',5:'May',6:'June',7:'July',8:'August',9:'September',10:'October',11:'November',12:'December'};
      let text = `Schedule: ${expr}\n\n`;
      text += `Minute: ${desc(min, 'minute')}\n`;
      text += `Hour: ${desc(hour, 'hour')}\n`;
      text += `Day of Month: ${desc(dom, 'day')}\n`;
      text += `Month: ${desc(month, 'month', monNames)}\n`;
      text += `Day of Week: ${desc(dow, 'day', dowNames)}\n`;
      // Generate next 5 run times (simplified)
      text += '\nHuman readable:\n';
      if (min === '*' && hour === '*') text += 'Runs every minute';
      else if (hour === '*') text += `Runs at minute ${min} of every hour`;
      else if (min !== '*' && hour !== '*' && dom === '*' && month === '*' && dow === '*') text += `Runs daily at ${hour.padStart(2,'0')}:${min.padStart(2,'0')}`;
      else text += 'Custom schedule';
      out.textContent = text;
    }

    function toolRunUuid() {
      const count = parseInt(document.getElementById('t-uuid-count').value) || 1;
      const out = document.getElementById('t-uuid-out');
      out.style.display = 'block';
      let uuids = [];
      for (let i = 0; i < Math.min(count, 100); i++) uuids.push(crypto.randomUUID());
      out.textContent = uuids.join('\n');
    }

    function toolCopyUuid() {
      const text = document.getElementById('t-uuid-out').textContent;
      if (text) navigator.clipboard.writeText(text);
    }

    function toolRunTsToDate() {
      const ts = document.getElementById('t-ts-unix').value.trim();
      const out = document.getElementById('t-ts-out');
      out.style.display = 'block';
      if (!ts) { out.textContent = ''; return; }
      const num = parseInt(ts);
      const ms = num > 9999999999 ? num : num * 1000;
      const d = new Date(ms);
      out.textContent = `UTC: ${d.toUTCString()}\nLocal: ${d.toLocaleString()}\nISO: ${d.toISOString()}`;
    }

    function toolRunDateToTs() {
      const dateStr = document.getElementById('t-ts-date').value.trim();
      const out = document.getElementById('t-ts-out');
      out.style.display = 'block';
      if (!dateStr) { out.textContent = ''; return; }
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) { out.textContent = 'Invalid date'; return; }
      out.textContent = `Unix (seconds): ${Math.floor(d.getTime() / 1000)}\nUnix (ms): ${d.getTime()}\nISO: ${d.toISOString()}`;
    }

    function toolRunTsNow() {
      const out = document.getElementById('t-ts-out');
      out.style.display = 'block';
      const now = new Date();
      document.getElementById('t-ts-unix').value = Math.floor(now.getTime() / 1000);
      out.textContent = `Now: ${now.toLocaleString()}\nUnix: ${Math.floor(now.getTime() / 1000)}\nISO: ${now.toISOString()}`;
    }

    // --- Utilities ---
    function toolRunMarkdown() {
      const input = document.getElementById('t-md-input').value;
      const out = document.getElementById('t-md-out');
      // Simple markdown to HTML
      let html = escHtml(input);
      html = html.replace(/^### (.+)$/gm, '<h3 style="color:#fff;margin:8px 0 4px;">$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2 style="color:#fff;margin:8px 0 4px;">$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1 style="color:#fff;margin:8px 0 4px;">$1</h1>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/`(.+?)`/g, '<code style="background:#333;padding:1px 4px;border-radius:3px;">$1</code>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
      html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" style="color:#0088ff;">$1</a>');
      html = html.replace(/\n/g, '<br>');
      out.innerHTML = html;
    }

    function toolRunLorem() {
      const count = parseInt(document.getElementById('t-lorem-count').value) || 3;
      const out = document.getElementById('t-lorem-out');
      out.style.display = 'block';
      const paras = [
        'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.',
        'Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.',
        'Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.',
        'Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.',
        'Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.',
        'Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?',
        'Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?',
        'At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.',
      ];
      let result = [];
      for (let i = 0; i < count; i++) result.push(paras[i % paras.length]);
      out.textContent = result.join('\n\n');
    }

    function toolCopyLorem() {
      const text = document.getElementById('t-lorem-out').textContent;
      if (text) navigator.clipboard.writeText(text);
    }

    function toolRunQr() {
      const input = document.getElementById('t-qr-input').value.trim();
      const out = document.getElementById('t-qr-out');
      if (!input) { out.innerHTML = ''; return; }
      // Simple QR using a free API (generates image)
      const size = 200;
      const url = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(input)}`;
      out.innerHTML = `<img src="${url}" alt="QR Code" style="border-radius:4px;background:#fff;padding:8px;">`;
    }

    function toolConvertColor() {
      const hex = document.getElementById('t-color-hex').value.trim();
      const out = document.getElementById('t-color-out');
      const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
      if (!m) { out.innerHTML = '<div class="tool-status fail">Invalid hex color</div>'; return; }
      const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
      // HSL conversion
      const r1 = r/255, g1 = g/255, b1 = b/255;
      const max = Math.max(r1,g1,b1), min = Math.min(r1,g1,b1);
      let h, s, l = (max+min)/2;
      if (max === min) { h = s = 0; }
      else {
        const d = max - min;
        s = l > 0.5 ? d/(2-max-min) : d/(max+min);
        switch(max) {
          case r1: h = ((g1-b1)/d + (g1<b1?6:0))/6; break;
          case g1: h = ((b1-r1)/d + 2)/6; break;
          case b1: h = ((r1-g1)/d + 4)/6; break;
        }
      }
      const fullHex = '#' + m[1] + m[2] + m[3];
      document.getElementById('t-color-picker').value = fullHex;
      out.innerHTML = `<table class="tool-result-table">
        <tr><td>HEX</td><td>${fullHex.toUpperCase()}</td></tr>
        <tr><td>RGB</td><td>rgb(${r}, ${g}, ${b})</td></tr>
        <tr><td>HSL</td><td>hsl(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%)</td></tr>
        <tr><td>Preview</td><td><div style="width:100%;height:24px;background:${fullHex};border-radius:3px;"></div></td></tr></table>`;
    }

    function toolUpdateColor() {
      const hex = document.getElementById('t-color-hex').value.trim();
      if (/^#?[a-f\d]{6}$/i.test(hex)) {
        document.getElementById('t-color-picker').value = hex.startsWith('#') ? hex : '#' + hex;
      }
    }

    function switchAI() {
      const select = document.getElementById('ai-select');
      const frame = document.getElementById('ai-frame');
      frame.src = select.value;
    }

    // FTP
    let ftpConnected = false;
    let ftpCurrentPath = '/';

    async function connectFtp() {
      const host = document.getElementById('ftp-host').value.trim();
      const port = parseInt(document.getElementById('ftp-port').value) || 21;
      const user = document.getElementById('ftp-user').value.trim();
      const pass = document.getElementById('ftp-pass').value;

      if (!host) {
        document.getElementById('ftp-status').textContent = 'Enter a host';
        document.getElementById('ftp-status').style.color = '#f44';
        return;
      }

      document.getElementById('ftp-status').textContent = 'Connecting...';
      document.getElementById('ftp-status').style.color = '#888';
      document.getElementById('ftp-connect-btn').disabled = true;

      try {
        await window.api.ftp.connect(host, port, user, pass);
        ftpConnected = true;
        ftpCurrentPath = '/';
        document.getElementById('ftp-status').textContent = `Connected: ${host}`;
        document.getElementById('ftp-status').style.color = '#4c4';
        document.getElementById('ftp-connect-btn').style.display = 'none';
        document.getElementById('ftp-disconnect-btn').style.display = '';
        switchToFtpMode(host);
      } catch (err) {
        document.getElementById('ftp-status').textContent = 'Error: ' + err.message;
        document.getElementById('ftp-status').style.color = '#f44';
      }
      document.getElementById('ftp-connect-btn').disabled = false;
    }

    function disconnectFtp() {
      window.api.ftp.disconnect();
      ftpConnected = false;
      document.getElementById('ftp-status').textContent = 'Not connected';
      document.getElementById('ftp-status').style.color = '#666';
      document.getElementById('ftp-connect-btn').style.display = '';
      document.getElementById('ftp-disconnect-btn').style.display = 'none';
      switchToLocalMode();
    }

    // Saved FTP connections (file-based storage via IPC)
    let cachedConnections = [];

    async function loadSavedConnectionsFromFile() {
      cachedConnections = await window.api.ftpConnections.load();
      return cachedConnections;
    }

    async function saveConnectionsToFile(connections) {
      cachedConnections = connections;
      await window.api.ftpConnections.save(connections);
    }

    async function renderSavedConnections() {
      const select = document.getElementById('ftp-saved');
      const connections = await loadSavedConnectionsFromFile();
      select.innerHTML = '<option value="">Saved...</option>';
      connections.forEach((c, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = c.label || `${c.user}@${c.host}`;
        select.appendChild(opt);
      });
    }

    function loadSavedConnection() {
      const select = document.getElementById('ftp-saved');
      const idx = select.value;
      if (idx === '') {
        document.getElementById('ftp-delete-saved-btn').style.display = 'none';
        return;
      }
      const c = cachedConnections[idx];
      if (c) {
        document.getElementById('ftp-host').value = c.host || '';
        document.getElementById('ftp-port').value = c.port || '21';
        document.getElementById('ftp-user').value = c.user || '';
        document.getElementById('ftp-pass').value = c.pass || '';
        document.getElementById('ftp-delete-saved-btn').style.display = '';
      }
    }

    async function saveConnection() {
      const host = document.getElementById('ftp-host').value.trim();
      const port = document.getElementById('ftp-port').value || '21';
      const user = document.getElementById('ftp-user').value.trim();
      const pass = document.getElementById('ftp-pass').value;
      if (!host) return;
      const connections = [...cachedConnections];
      const existsIdx = connections.findIndex(c => c.host === host && c.user === user);
      if (existsIdx >= 0) {
        connections[existsIdx].port = port;
        connections[existsIdx].pass = pass;
      } else {
        connections.push({ host, port, user, pass, label: `${user}@${host}` });
      }
      await saveConnectionsToFile(connections);
      await renderSavedConnections();
      document.getElementById('ftp-status').textContent = 'Connection saved';
      document.getElementById('ftp-status').style.color = '#4c4';
    }

    async function deleteSavedConnection() {
      const select = document.getElementById('ftp-saved');
      const idx = parseInt(select.value);
      if (isNaN(idx)) return;
      const connections = [...cachedConnections];
      connections.splice(idx, 1);
      await saveConnectionsToFile(connections);
      await renderSavedConnections();
      document.getElementById('ftp-delete-saved-btn').style.display = 'none';
      document.getElementById('ftp-status').textContent = 'Connection deleted';
      document.getElementById('ftp-status').style.color = '#888';
    }

    // Load saved connections on startup
    renderSavedConnections();

    // Notes
    async function initNotes() {
      const notes = document.getElementById('notes-area');
      const saved = await window.api.notes.load();
      if (saved && saved.content) notes.value = saved.content;

      let saveTimeout;
      notes.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          window.api.notes.save({ content: notes.value });
        }, 500);
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd+S - Save
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        saveCurrentFile();
      }
      // Cmd+T - New terminal
      if ((e.metaKey || e.ctrlKey) && e.key === 't') {
        e.preventDefault();
        createTerminal();
      }
      // Cmd+W - Close tab
      if ((e.metaKey || e.ctrlKey) && e.key === 'w') {
        e.preventDefault();
        if (activeFileIndex >= 0) {
          closeEditorTab(activeFileIndex, { stopPropagation: () => {} });
        }
      }
      // Cmd+B - Toggle sidebar
      if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
        e.preventDefault();
        const left = document.getElementById('left-panel');
        const resizer = document.getElementById('left-resizer');
        if (left.style.display === 'none') {
          left.style.display = 'flex';
          resizer.style.display = 'block';
        } else {
          left.style.display = 'none';
          resizer.style.display = 'none';
        }
      }
      // Cmd+, - Settings
      if ((e.metaKey || e.ctrlKey) && e.key === ',') {
        e.preventDefault();
        showSettings();
      }
      // Cmd+/ - Shortcuts
      if ((e.metaKey || e.ctrlKey) && e.key === '/') {
        e.preventDefault();
        showShortcuts();
      }
      // Cmd+Shift+P - Command Palette
      if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'p') {
        e.preventDefault();
        showCommandPalette();
      }
      // Cmd+P - Command Palette (alternative)
      if ((e.metaKey || e.ctrlKey) && !e.shiftKey && e.key === 'p') {
        e.preventDefault();
        showCommandPalette();
      }
      // Escape - Close dialogs
      if (e.key === 'Escape') {
        closeSettings();
        closeShortcuts();
        closeFilePreview();
        closeTerminalSearch();
      }
      // Cmd+Left - Go to beginning of line (send Ctrl+A to terminal)
      if (e.metaKey && !e.altKey && e.key === 'ArrowLeft') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x01');
        }
      }
      // Cmd+Right - Go to end of line (send Ctrl+E to terminal)
      if (e.metaKey && !e.altKey && e.key === 'ArrowRight') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x05');
        }
      }
      // Cmd+Option+Left - Go one word back (send Alt+B to terminal)
      if (e.metaKey && e.altKey && e.key === 'ArrowLeft') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x1bb');
        }
      }
      // Cmd+Option+Right - Go one word forward (send Alt+F to terminal)
      if (e.metaKey && e.altKey && e.key === 'ArrowRight') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x1bf');
        }
      }
      // Cmd+F - Search in terminal (when terminal focused)
      if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal && document.activeElement?.closest('#terminal-container')) {
          e.preventDefault();
          openTerminalSearch();
        }
      }
    });

    // File manager keyboard shortcuts
    document.getElementById('file-list').addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'c') {
        copyFile();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'x') {
        cutFile();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'v') {
        pasteFile();
      }
    });

    // ============ Cloud Sync ============
    let cloudAccount = null;

    function showWelcomeError(msg) {
      const el = document.getElementById('welcome-error');
      el.textContent = msg;
      el.style.display = msg ? 'block' : 'none';
    }

    function showLoginForm() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('welcome-logged-in').style.display = 'none';
      showWelcomeError('');
    }

    function showRegisterForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('welcome-logged-in').style.display = 'none';
      showWelcomeError('');
    }

    function showLoggedInView(username) {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('welcome-logged-in').style.display = 'block';
      document.getElementById('welcome-username').textContent = username;
      showWelcomeError('');
    }

    function dismissWelcome() {
      document.getElementById('welcome-overlay').classList.add('hidden');
    }

    async function cloudLogin() {
      const username = document.getElementById('cloud-username').value.trim();
      const password = document.getElementById('cloud-password').value;
      if (!username || !password) { showWelcomeError('Enter username and password'); return; }
      showWelcomeError('');
      try {
        const result = await window.api.cloud.login(username, password);
        if (result.success) {
          cloudAccount = { token: result.token, user: result.user };
          showLoggedInView(result.user.username);
          updateCloudBadge();
          await pullCloudData();
        } else {
          showWelcomeError(result.error || 'Login failed');
        }
      } catch (e) { showWelcomeError('Connection error'); }
    }

    async function cloudRegister() {
      const username = document.getElementById('reg-username').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      if (!username || !email || !password) { showWelcomeError('All fields are required'); return; }
      showWelcomeError('');
      try {
        const result = await window.api.cloud.register(username, email, password);
        if (result.success) {
          cloudAccount = { token: result.token, user: result.user };
          showLoggedInView(result.user.username);
          updateCloudBadge();
        } else {
          showWelcomeError(result.error || 'Registration failed');
        }
      } catch (e) { showWelcomeError('Connection error'); }
    }

    async function cloudLogout() {
      await window.api.cloud.logout();
      cloudAccount = null;
      updateCloudBadge();
      showLoginForm();
    }

    function updateCloudBadge() {
      const badge = document.getElementById('cloud-badge');
      const text = document.getElementById('cloud-badge-text');
      const syncBtn = document.getElementById('cloud-sync-btn');
      badge.style.display = 'flex';
      if (cloudAccount && cloudAccount.user) {
        text.textContent = cloudAccount.user.username;
        syncBtn.style.display = '';
        startAutoSync();
      } else {
        text.textContent = 'Not signed in';
        syncBtn.style.display = 'none';
        stopAutoSync();
      }
    }

    function showCloudMenu() {
      if (cloudAccount && cloudAccount.user) {
        if (confirm('Sign out of cloud account?')) {
          cloudLogout();
        }
      } else {
        document.getElementById('welcome-overlay').classList.remove('hidden');
        showLoginForm();
      }
    }

    async function pullCloudData() {
      if (!cloudAccount) return;
      try {
        const result = await window.api.cloud.pullAll();
        if (result.success && result.data) {
          if (result.data.settings && result.data.settings.data_json) {
            localStorage.setItem('dterm-settings', result.data.settings.data_json);
            loadSettings();
          }
          if (result.data.bookmarks && result.data.bookmarks.data_json) {
            localStorage.setItem('dterm-bookmarks', result.data.bookmarks.data_json);
            loadBookmarks();
          }
          if (result.data.recent_folders && result.data.recent_folders.data_json) {
            localStorage.setItem('dterm-recent-folders', result.data.recent_folders.data_json);
          }
          if (result.data.recent_files && result.data.recent_files.data_json) {
            localStorage.setItem('dterm-recent-files', result.data.recent_files.data_json);
          }
          if (result.data.notes && result.data.notes.data_json) {
            await window.api.notes.save(JSON.parse(result.data.notes.data_json));
            initNotes();
          }
          if (result.data.ftp_connections && result.data.ftp_connections.data_json) {
            await window.api.ftpConnections.save(JSON.parse(result.data.ftp_connections.data_json));
          }
        }
      } catch (e) { console.error('Pull failed:', e); }
    }

    async function pushCloudData() {
      if (!cloudAccount) return;
      const syncIcon = document.querySelector('#cloud-badge .sync-icon');
      if (syncIcon) syncIcon.classList.add('syncing');
      try {
        // Push localStorage items
        const settings = localStorage.getItem('dterm-settings');
        if (settings) await window.api.cloud.push('settings', settings);

        const bookmarks = localStorage.getItem('dterm-bookmarks');
        if (bookmarks) await window.api.cloud.push('bookmarks', bookmarks);

        const recentFolders = localStorage.getItem('dterm-recent-folders');
        if (recentFolders) await window.api.cloud.push('recent_folders', recentFolders);

        const recentFiles = localStorage.getItem('dterm-recent-files');
        if (recentFiles) await window.api.cloud.push('recent_files', recentFiles);

        // Push file-based items
        const notes = await window.api.notes.load();
        await window.api.cloud.push('notes', JSON.stringify(notes));

        const ftpConns = await window.api.ftpConnections.load();
        await window.api.cloud.push('ftp_connections', JSON.stringify(ftpConns));
      } catch (e) { console.error('Push failed:', e); }
      if (syncIcon) syncIcon.classList.remove('syncing');
    }

    async function checkCloudAccount() {
      try {
        const account = await window.api.cloud.getAccount();
        if (account && account.token) {
          const validation = await window.api.cloud.validate();
          if (validation.success) {
            cloudAccount = account;
            updateCloudBadge();
            await pullCloudData();
            return true;
          }
        }
      } catch (e) {}
      return false;
    }

    async function showWelcomeScreen() {
      try {
        const welcome = await window.api.cloud.getWelcome();
        if (welcome.welcome_enabled && welcome.welcome_message) {
          document.getElementById('welcome-msg').textContent = welcome.welcome_message;
        }
        if (welcome.logged_in && welcome.user) {
          cloudAccount = { user: welcome.user };
          // Reload full account from local
          const localAccount = await window.api.cloud.getAccount();
          if (localAccount) cloudAccount = localAccount;
          showLoggedInView(welcome.user.username);
          updateCloudBadge();
        } else {
          const hasAccount = await checkCloudAccount();
          if (hasAccount) {
            showLoggedInView(cloudAccount.user.username);
          } else {
            showLoginForm();
          }
        }
        if (welcome.welcome_enabled) {
          document.getElementById('welcome-overlay').classList.remove('hidden');
        } else {
          // Still check and pull in background
          await checkCloudAccount();
        }
      } catch (e) {
        // If server unreachable, check local account silently
        await checkCloudAccount();
      }
      updateCloudBadge();
    }

    // Manual sync button
    async function manualSync() {
      if (!cloudAccount) return;
      const btn = document.getElementById('cloud-sync-btn');
      btn.disabled = true;
      btn.textContent = '⟳ Syncing...';
      try {
        await pushCloudData();
        await pullCloudData();
        btn.textContent = '⟳ Synced!';
        setTimeout(() => { btn.textContent = '⟳ Sync'; }, 2000);
      } catch (e) {
        btn.textContent = '⟳ Failed';
        setTimeout(() => { btn.textContent = '⟳ Sync'; }, 2000);
      }
      btn.disabled = false;
    }

    // Auto-sync every 5 minutes
    let cloudSyncInterval = null;
    function startAutoSync() {
      stopAutoSync();
      cloudSyncInterval = setInterval(() => {
        if (cloudAccount) pushCloudData();
      }, 10 * 1000);
    }
    function stopAutoSync() {
      if (cloudSyncInterval) { clearInterval(cloudSyncInterval); cloudSyncInterval = null; }
    }

    // Auto-push on window close
    window.addEventListener('beforeunload', () => {
      if (cloudAccount) {
        pushCloudData();
      }
    });

    // Start
    init();
    initNotes();
    showWelcomeScreen();
  </script>
</body>
</html>
