<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>dTerm</title>
  <link rel="stylesheet" href="node_modules/xterm/css/xterm.css">
  <link rel="stylesheet" href="node_modules/monaco-editor/min/vs/editor/editor.main.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000000;
      color: #ccc;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #app-container {
      flex: 1;
      display: flex;
      min-height: 0;
      overflow: hidden;
    }

    /* Left Panel */
    #left-panel {
      width: 400px;
      min-width: 200px;
      max-width: 500px;
      background: #0a0a0a;
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    /* Panel Resizers */
    .panel-resizer {
      width: 4px;
      background: #222;
      cursor: ew-resize;
      flex-shrink: 0;
    }
    .panel-resizer:hover { background: #0066cc; }

    /* File Manager */
    #file-manager {
      flex: 3;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    /* Mini Browser */
    #mini-browser {
      flex: 1;
      min-height: 450px;
      background: #0a0a0a;
      border-top: 1px solid #222;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #mini-browser-toolbar {
      padding: 6px;
      display: flex;
      gap: 4px;
      border-bottom: 1px solid #222;
    }

    #mini-browser-toolbar button {
      padding: 5px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      cursor: pointer;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #mini-browser-toolbar button:hover {
      background: #2a2a2a;
      border-color: #444;
    }

    #mini-browser-url {
      flex: 1;
      padding: 4px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 11px;
      outline: none;
    }

    #mini-browser-url:focus {
      border-color: #0066cc;
    }

    #mini-browser-frame {
      flex: 1;
      border: none;
      background: #fff;
      min-height: 0;
      width: 100%;
      height: 100%;
    }

    #mini-browser-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 12px;
      display: none;
    }

    #mini-browser-loading.visible {
      display: block;
    }

    #mini-browser-content {
      position: relative;
      flex: 1;
      display: flex;
      min-height: 0;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* File list loading */
    #file-list-loading {
      padding: 20px;
      text-align: center;
      color: #666;
      display: none;
    }

    #file-list-loading.visible {
      display: block;
    }

    /* Left panel resizer between file manager and mini browser */
    #left-panel-resizer {
      height: 4px;
      background: #222;
      cursor: ns-resize;
      flex-shrink: 0;
    }
    #left-panel-resizer:hover { background: #0066cc; }

    #fm-toolbar {
      padding: 6px;
      border-bottom: 1px solid #222;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    #fm-toolbar button, #fm-bottom-toolbar button {
      padding: 5px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      cursor: pointer;
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      white-space: nowrap;
    }

    #fm-toolbar button:hover, #fm-bottom-toolbar button:hover {
      background: #2a2a2a;
      border-color: #444;
    }

    #fm-toolbar button.active {
      background: #0066cc;
      border-color: #0066cc;
    }

    #fm-search {
      flex: 1;
      min-width: 60px;
      padding: 4px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 11px;
      outline: none;
    }

    #fm-search:focus { border-color: #0066cc; }

    #fm-path {
      padding: 6px 10px;
      font-size: 11px;
      color: #666;
      border-bottom: 1px solid #222;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #fm-path span { flex: 1; overflow: hidden; text-overflow: ellipsis; }

    #fm-path button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
    }

    #fm-path button:hover { color: #0066cc; }

    /* Bookmarks */
    #bookmarks-bar {
      display: flex;
      gap: 4px;
      padding: 4px 6px;
      border-bottom: 1px solid #222;
      overflow-x: auto;
      flex-shrink: 0;
    }

    #bookmarks-bar:empty { display: none; }

    .bookmark-item {
      padding: 3px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      font-size: 10px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bookmark-item:hover { background: #2a2a2a; color: #ccc; }

    .bookmark-item .remove-bookmark {
      opacity: 0;
      font-size: 10px;
    }

    .bookmark-item:hover .remove-bookmark { opacity: 0.6; }
    .bookmark-item .remove-bookmark:hover { opacity: 1; color: #f44; }

    /* Recent Menu */
    #recent-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #recent-menu.visible { display: block; }

    #recent-menu .recent-item {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      color: #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #recent-menu .recent-item:hover { background: #0066cc; }

    #recent-menu .recent-header {
      padding: 4px 12px;
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    #recent-menu .recent-clear {
      padding: 6px 12px;
      font-size: 11px;
      color: #888;
      cursor: pointer;
      border-top: 1px solid #222;
      margin-top: 4px;
    }

    #recent-menu .recent-clear:hover { color: #f44; }

    #fm-toolbar { position: relative; }

    /* Git indicators */
    #git-branch {
      padding: 2px 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 10px;
      color: #888;
      display: none;
      align-items: center;
      gap: 4px;
    }

    #git-branch.visible { display: flex; }
    #git-branch .branch-icon { color: #f90; }

    .file-item.git-modified .file-name { color: #f90; }
    .file-item.git-added .file-name { color: #0f0; }
    .file-item.git-deleted .file-name { color: #f44; text-decoration: line-through; }
    .file-item.git-untracked .file-name { color: #888; }

    .git-indicator {
      font-size: 10px;
      margin-left: auto;
      padding: 1px 4px;
      border-radius: 2px;
    }

    .git-indicator.modified { color: #f90; }
    .git-indicator.added { color: #0f0; }
    .git-indicator.untracked { color: #888; }

    #file-list {
      flex: 1;
      overflow-y: auto;
    }

    .file-item {
      padding: 4px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      user-select: none;
    }

    .file-item[draggable="true"] {
      cursor: grab;
    }

    .file-item.dragging {
      opacity: 0.5;
    }

    .file-item:hover { background: #1a1a1a; }
    .file-item.selected { background: #0066cc; }
    .file-item.cut { opacity: 0.5; }

    .file-item .file-info {
      margin-left: auto;
      font-size: 10px;
      color: #666;
    }

    #fm-bottom-toolbar {
      padding: 6px;
      border-top: 1px solid #222;
      display: flex;
      gap: 4px;
    }

    /* Main Area */
    #main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }

    /* Editor Area */
    #editor-area {
      display: none;
      flex-direction: column;
      border-bottom: 1px solid #222;
    }

    #editor-area.visible {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    #editor-tabs {
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      overflow-x: auto;
    }

    #editor-container {
      flex: 1;
      position: relative;
      min-height: 0;
      overflow: hidden;
    }

    /* Terminal Area */
    #terminal-area {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    #terminal-area.with-editor {
      flex: none;
      height: 250px;
      border-top: 1px solid #222;
    }

    /* Tabs */
    #terminal-tabs {
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
    }

    .tab {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      border-right: 1px solid #222;
    }

    .tab.active { background: #000000; }
    .tab:hover:not(.active) { background: #1a1a1a; }
    .tab.modified span:first-child::before { content: '‚óè '; color: #0af; }

    .tab-close {
      opacity: 0.6;
      font-size: 12px;
    }

    .tab-close:hover { opacity: 1; }

    #new-term-btn, .term-profile-btn {
      padding: 8px 12px;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 14px;
    }

    #new-term-btn:hover, .term-profile-btn:hover { color: #ccc; }

    /* Terminal search bar */
    #terminal-search {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 8px;
      z-index: 100;
      gap: 4px;
      align-items: center;
    }

    #terminal-search.visible { display: flex; }

    #terminal-search input {
      width: 200px;
      padding: 4px 8px;
      background: #000;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      outline: none;
    }

    #terminal-search input:focus { border-color: #0066cc; }

    #terminal-search button {
      padding: 4px 8px;
      background: #333;
      border: none;
      border-radius: 4px;
      color: #ccc;
      cursor: pointer;
      font-size: 11px;
    }

    #terminal-search button:hover { background: #444; }

    #terminal-search .search-count {
      font-size: 10px;
      color: #666;
      min-width: 40px;
    }

    .term-profiles {
      display: flex;
      margin-left: auto;
      border-left: 1px solid #222;
    }

    /* Terminal Container */
    #terminal-container {
      flex: 1;
      position: relative;
      background: #000000;
    }

    #terminal-container.drag-over {
      outline: 2px dashed #0066cc;
      outline-offset: -2px;
    }

    /* Right Panel */
    #right-panel {
      width: 400px;
      min-width: 300px;
      max-width: 700px;
      background: #0a0a0a;
      border-left: 1px solid #222;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    #right-panel-header {
      padding: 8px;
      background: #0a0a0a;
      border-bottom: 1px solid #222;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    #right-panel-tabs {
      display: flex;
      gap: 4px;
    }

    .right-tab {
      padding: 5px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      cursor: pointer;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .right-tab:hover {
      background: #2a2a2a;
      color: #ccc;
    }

    .right-tab.active {
      background: #0066cc;
      border-color: #0066cc;
      color: #fff;
    }

    #ai-select {
      background: #1a1a1a;
      color: #ccc;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      outline: none;
    }

    #ai-select:hover {
      background: #2a2a2a;
    }

    #ai-frame {
      flex: 1;
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
      min-height: 0;
    }

    /* Right Panel Notes */
    #right-notes-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    #notes-area {
      flex: 1;
      background: #000;
      color: #ccc;
      border: none;
      outline: none;
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      padding: 12px;
      line-height: 1.5;
    }

    /* FTP Panel */
    #right-ftp-panel {
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    #ftp-connect-form {
      padding: 12px;
      border-bottom: 1px solid #222;
    }

    #ftp-connect-form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 12px;
      outline: none;
    }

    #ftp-connect-form input:focus { border-color: #0066cc; }

    #ftp-connect-form button {
      width: 100%;
      padding: 8px;
      background: #0066cc;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }

    #ftp-connect-form button:hover { background: #0077dd; }

    #ftp-status {
      padding: 8px 12px;
      font-size: 11px;
      color: #666;
      border-bottom: 1px solid #222;
    }

    #ftp-file-list {
      flex: 1;
      overflow-y: auto;
    }

    .terminal-panel {
      position: absolute;
      inset: 0;
      display: none;
    }

    .terminal-panel.active { display: block; }

    /* Context Menu */
    #context-menu {
      position: fixed;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #context-menu button {
      display: block;
      width: 100%;
      padding: 8px 16px;
      background: none;
      border: none;
      color: #ccc;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    #context-menu button:hover { background: #0066cc; }
    #context-menu button.danger { color: #f44; }

    /* Terminal Context Menu */
    #terminal-context-menu {
      position: fixed;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 4px 0;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    #terminal-context-menu button {
      display: block;
      width: 100%;
      padding: 8px 16px;
      background: none;
      border: none;
      color: #ccc;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    #terminal-context-menu button:hover { background: #0066cc; }

    /* Command Palette */
    #command-palette {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 500px;
      max-width: 90%;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      display: none;
      flex-direction: column;
      z-index: 4000;
      max-height: 400px;
    }

    #command-palette.visible { display: flex; }

    #command-palette-input {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-bottom: 1px solid #333;
      color: #fff;
      font-size: 14px;
      outline: none;
    }

    #command-palette-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .command-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .command-item:hover, .command-item.selected { background: #0066cc; }

    .command-item .command-icon { font-size: 16px; opacity: 0.7; }
    .command-item .command-name { flex: 1; }
    .command-item .command-shortcut { font-size: 11px; color: #888; }

    .command-item.selected .command-shortcut { color: #ccc; }

    /* Resizer */
    #resizer {
      height: 4px;
      background: #222;
      cursor: ns-resize;
    }
    #resizer:hover { background: #0066cc; }

    /* File Preview */
    #file-preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }

    #file-preview-overlay.visible { display: flex; }

    #file-preview-container {
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #file-preview-container img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 4px;
    }

    #file-preview-container video {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 4px;
    }

    #file-preview-name {
      margin-top: 12px;
      color: #888;
      font-size: 12px;
    }

    #file-preview-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }

    #file-preview-close:hover { color: #fff; }

    /* Settings Panel */
    #settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #settings-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #settings-panel h2 {
      margin-bottom: 16px;
      font-size: 16px;
      color: #fff;
    }

    .settings-group {
      margin-bottom: 16px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: #888;
    }

    .settings-group input, .settings-group select {
      width: 100%;
      padding: 8px;
      background: #000;
      border: 1px solid #333;
      border-radius: 4px;
      color: #ccc;
      font-size: 13px;
      outline: none;
    }

    .settings-group input:focus, .settings-group select:focus {
      border-color: #0066cc;
    }

    #settings-panel .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    #settings-panel button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    #settings-panel button.primary {
      background: #0066cc;
      color: #fff;
    }

    #settings-panel button.secondary {
      background: #333;
      color: #ccc;
    }

    /* Shortcuts Panel */
    #shortcuts-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #shortcuts-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      width: 450px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #shortcuts-panel h2 {
      margin-bottom: 16px;
      font-size: 16px;
      color: #fff;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #222;
      font-size: 13px;
    }

    .shortcut-key {
      background: #333;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: monospace;
      color: #fff;
    }

    /* Status Bar */
    #status-bar {
      height: 24px;
      background: #0a0a0a;
      border-top: 1px solid #222;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      color: #666;
      gap: 16px;
      flex-shrink: 0;
    }

    #status-bar button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 6px;
    }

    #status-bar button:hover { color: #ccc; }
  </style>
</head>
<body>
  <!-- App Container -->
  <div id="app-container">
  <!-- Left Panel -->
  <div id="left-panel">
    <!-- File Manager -->
    <div id="file-manager">
      <div id="fm-toolbar">
        <button onclick="goHome()">Home</button>
        <button onclick="goUp()">Up</button>
        <button onclick="openFolder()">Open</button>
        <button onclick="refresh()">Refresh</button>
        <button id="hidden-toggle" onclick="toggleHidden()">Hidden</button>
        <button onclick="showRecentMenu(event)">Recent ‚ñæ</button>
        <input type="text" id="fm-search" placeholder="Search..." oninput="filterFiles()">
      </div>
      <div id="recent-menu"></div>
      <div id="fm-path"><span>Loading...</span><div id="git-branch"><span class="branch-icon">‚éá</span><span id="git-branch-name"></span></div><button onclick="toggleBookmark()" title="Bookmark this folder">‚òÜ</button></div>
      <div id="bookmarks-bar"></div>
      <div id="file-list"></div>
      <div id="fm-bottom-toolbar">
        <button onclick="newFile()">+ File</button>
        <button onclick="newFolder()">+ Folder</button>
      </div>
    </div>

    <!-- Left Panel Resizer -->
    <div id="left-panel-resizer"></div>

    <!-- Mini Browser -->
    <div id="mini-browser">
      <div id="mini-browser-toolbar">
        <button onclick="miniBrowserBack()">‚Üê</button>
        <button onclick="miniBrowserForward()">‚Üí</button>
        <button onclick="miniBrowserRefresh()">‚Üª</button>
        <button onclick="miniBrowserHome()">‚åÇ</button>
        <input type="text" id="mini-browser-url" placeholder="Enter URL..." value="" onkeydown="if(event.key==='Enter')miniBrowserGo()">
        <button onclick="miniBrowserGo()">Go</button>
      </div>
      <div id="mini-browser-content">
        <div id="mini-browser-loading"><span class="loading-spinner"></span>Loading...</div>
        <webview id="mini-browser-frame" allowpopups></webview>
      </div>
    </div>
  </div>

  <!-- Left Resizer -->
  <div class="panel-resizer" id="left-resizer"></div>

  <!-- Main Area -->
  <div id="main-area">
    <!-- Editor Area -->
    <div id="editor-area">
      <div id="editor-tabs"></div>
      <div id="editor-container"></div>
    </div>

    <div id="resizer"></div>

    <!-- Terminal Area -->
    <div id="terminal-area">
      <div id="terminal-tabs">
        <button id="new-term-btn" onclick="createTerminal()">+</button>
        <div class="term-profiles">
          <button class="term-profile-btn" onclick="createTerminal('/bin/zsh')" title="Zsh">zsh</button>
          <button class="term-profile-btn" onclick="createTerminal('/bin/bash')" title="Bash">bash</button>
          <button class="term-profile-btn" onclick="createTerminal('node')" title="Node">node</button>
          <button class="term-profile-btn" onclick="createTerminal('python3')" title="Python">py</button>
        </div>
      </div>
      <div id="terminal-container">
        <div id="terminal-search">
          <input type="text" id="terminal-search-input" placeholder="Search..." onkeydown="handleTerminalSearchKey(event)">
          <button onclick="terminalSearchPrev()">‚Üë</button>
          <button onclick="terminalSearchNext()">‚Üì</button>
          <span class="search-count" id="terminal-search-count"></span>
          <button onclick="closeTerminalSearch()">‚úï</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Resizer -->
  <div class="panel-resizer" id="right-resizer"></div>

  <!-- Right Panel - AI / Notes / FTP -->
  <div id="right-panel">
    <div id="right-panel-header">
      <div id="right-panel-tabs">
        <button class="right-tab active" onclick="showRightTab('notes')">Notes</button>
        <button class="right-tab" onclick="showRightTab('ai')">AI</button>
        <button class="right-tab" onclick="showRightTab('ftp')">FTP</button>
      </div>
      <select id="ai-select" onchange="switchAI()">
        <option value="https://chatgpt.com">ChatGPT</option>
        <option value="https://copilot.microsoft.com">Copilot</option>
        <option value="https://claude.ai">Claude</option>
        <option value="https://gemini.google.com">Gemini</option>
        <option value="https://poe.com">Poe</option>
        <option value="https://perplexity.ai">Perplexity</option>
      </select>
    </div>
    <div id="right-notes-panel">
      <textarea id="notes-area" placeholder="Quick notes..."></textarea>
    </div>
    <div id="right-ftp-panel">
      <div id="ftp-connect-form">
        <input type="text" id="ftp-host" placeholder="Host (e.g., ftp.example.com)">
        <input type="text" id="ftp-port" placeholder="Port (default: 21)" value="21">
        <input type="text" id="ftp-user" placeholder="Username">
        <input type="password" id="ftp-pass" placeholder="Password">
        <button onclick="connectFtp()">Connect</button>
      </div>
      <div id="ftp-status">Not connected</div>
      <div id="ftp-file-list"></div>
    </div>
    <webview id="ai-frame" src="about:blank" allowpopups style="display:none;"></webview>
  </div>
  </div><!-- End app-container -->

  <!-- Context Menu (File Manager) -->
  <div id="context-menu">
    <button onclick="openSelectedFile()">Open</button>
    <button onclick="previewSelectedFile()">Preview</button>
    <button onclick="copyFile()">Copy</button>
    <button onclick="cutFile()">Cut</button>
    <button onclick="pasteFile()">Paste</button>
    <button onclick="renameFile()">Rename</button>
    <button onclick="deleteFile()" class="danger">Delete</button>
  </div>

  <!-- Terminal Context Menu -->
  <div id="terminal-context-menu">
    <button onclick="terminalCopy()">Copy</button>
    <button onclick="terminalPaste()">Paste</button>
    <button onclick="terminalSelectAll()">Select All</button>
    <button onclick="terminalClear()">Clear</button>
  </div>

  <!-- Command Palette -->
  <div id="command-palette">
    <input type="text" id="command-palette-input" placeholder="Type a command or search..." oninput="filterCommands()" onkeydown="handleCommandKey(event)">
    <div id="command-palette-list"></div>
  </div>

  <!-- File Preview -->
  <div id="file-preview-overlay" onclick="if(event.target===this)closeFilePreview()">
    <button id="file-preview-close" onclick="closeFilePreview()">‚úï</button>
    <div id="file-preview-container"></div>
  </div>

  <!-- Input Dialog -->
  <div id="input-dialog" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#1a1a1a; padding:20px; border-radius:8px; border:1px solid #333; min-width:300px;">
      <div id="input-dialog-title" style="margin-bottom:12px; font-size:14px; color:#ccc;"></div>
      <input type="text" id="input-dialog-input" style="width:100%; padding:8px; background:#000; border:1px solid #333; border-radius:4px; color:#ccc; font-size:14px; outline:none;">
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button onclick="closeInputDialog()" style="padding:6px 12px; background:#333; border:none; border-radius:4px; color:#ccc; cursor:pointer;">Cancel</button>
        <button onclick="confirmInputDialog()" style="padding:6px 12px; background:#0066cc; border:none; border-radius:4px; color:#fff; cursor:pointer;">OK</button>
      </div>
    </div>
  </div>

  <!-- Settings Overlay -->
  <div id="settings-overlay" onclick="if(event.target===this)closeSettings()">
    <div id="settings-panel">
      <h2>Settings</h2>
      <div class="settings-group">
        <label>Editor Font Size</label>
        <input type="number" id="setting-font-size" value="14" min="10" max="24">
      </div>
      <div class="settings-group">
        <label>Default Shell</label>
        <select id="setting-shell">
          <option value="/bin/zsh">Zsh</option>
          <option value="/bin/bash">Bash</option>
          <option value="/bin/sh">Sh</option>
        </select>
      </div>
      <div class="settings-group">
        <label>Theme</label>
        <select id="setting-theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
      <div class="settings-group">
        <label>Browser Home Page</label>
        <input type="text" id="setting-browser-home" value="https://duckduckgo.com" placeholder="https://duckduckgo.com" style="width:100%; padding:6px 8px; background:#1a1a1a; border:1px solid #333; border-radius:4px; color:#ccc; font-size:12px;">
      </div>
      <div class="btn-row">
        <button class="secondary" onclick="closeSettings()">Cancel</button>
        <button class="primary" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Shortcuts Overlay -->
  <div id="shortcuts-overlay" onclick="if(event.target===this)closeShortcuts()">
    <div id="shortcuts-panel">
      <h2>Keyboard Shortcuts</h2>
      <div class="shortcut-row"><span>Save file</span><span class="shortcut-key">‚åòS</span></div>
      <div class="shortcut-row"><span>New terminal</span><span class="shortcut-key">‚åòT</span></div>
      <div class="shortcut-row"><span>Close tab</span><span class="shortcut-key">‚åòW</span></div>
      <div class="shortcut-row"><span>Find in file</span><span class="shortcut-key">‚åòF</span></div>
      <div class="shortcut-row"><span>Go to line</span><span class="shortcut-key">‚åòG</span></div>
      <div class="shortcut-row"><span>Command palette</span><span class="shortcut-key">‚åò‚áßP</span></div>
      <div class="shortcut-row"><span>Toggle sidebar</span><span class="shortcut-key">‚åòB</span></div>
      <div class="shortcut-row"><span>Settings</span><span class="shortcut-key">‚åò,</span></div>
      <div class="shortcut-row"><span>Shortcuts help</span><span class="shortcut-key">‚åò/</span></div>
      <div class="shortcut-row"><span>Copy file</span><span class="shortcut-key">‚åòC</span></div>
      <div class="shortcut-row"><span>Cut file</span><span class="shortcut-key">‚åòX</span></div>
      <div class="shortcut-row"><span>Paste file</span><span class="shortcut-key">‚åòV</span></div>
      <div style="margin-top:16px; text-align:center;">
        <button class="secondary" onclick="closeShortcuts()" style="padding:8px 20px; background:#333; border:none; border-radius:4px; color:#ccc; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="status-bar">
    <span id="status-file">No file open</span>
    <span id="status-line">Ln 1, Col 1</span>
    <span style="flex:1;"></span>
    <button onclick="showShortcuts()">Shortcuts</button>
    <button onclick="showSettings()">Settings</button>
  </div>

  <script src="node_modules/xterm/lib/xterm.js"></script>
  <script src="node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script src="node_modules/xterm-addon-search/lib/xterm-addon-search.js"></script>
  <script>
    // Monaco Editor loader
    const monacoLoader = document.createElement('script');
    monacoLoader.src = 'node_modules/monaco-editor/min/vs/loader.js';
    monacoLoader.onload = () => {
      require.config({ paths: { vs: 'node_modules/monaco-editor/min/vs' } });
      require(['vs/editor/editor.main'], () => {
        monacoReady = true;
        monaco.editor.setTheme('vs-dark');
      });
    };
    document.head.appendChild(monacoLoader);

    let monacoReady = false;
    let monacoEditor = null;
    let currentPath = '';
    let selectedFile = null;
    let terminals = [];
    let openFiles = [];
    let activeFileIndex = -1;
    let showHidden = false;
    let allFiles = [];
    let clipboard = { file: null, action: null };
    let settings = {
      fontSize: 14,
      shell: '/bin/zsh',
      theme: 'dark',
      browserHome: 'https://duckduckgo.com'
    };

    // Load settings
    function loadSettings() {
      const saved = localStorage.getItem('dterm-settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
        document.getElementById('setting-font-size').value = settings.fontSize;
        document.getElementById('setting-shell').value = settings.shell;
        document.getElementById('setting-theme').value = settings.theme;
        applyTheme();
      }
      // Always apply browser home page setting to the input field
      document.getElementById('setting-browser-home').value = settings.browserHome;
      // Apply browser home page to webview
      const webview = document.getElementById('mini-browser-frame');
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = settings.browserHome;
      if (urlInput) urlInput.value = settings.browserHome;
    }

    function saveSettings() {
      settings.fontSize = parseInt(document.getElementById('setting-font-size').value);
      settings.shell = document.getElementById('setting-shell').value;
      settings.theme = document.getElementById('setting-theme').value;
      let browserHome = document.getElementById('setting-browser-home').value.trim();
      if (browserHome && !browserHome.startsWith('http://') && !browserHome.startsWith('https://')) {
        browserHome = 'https://' + browserHome;
      }
      settings.browserHome = browserHome || 'https://duckduckgo.com';
      localStorage.setItem('dterm-settings', JSON.stringify(settings));
      applyTheme();
      if (monacoEditor) {
        monacoEditor.updateOptions({ fontSize: settings.fontSize });
      }
      // Apply new home page to browser
      const webview = document.getElementById('mini-browser-frame');
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = settings.browserHome;
      if (urlInput) urlInput.value = settings.browserHome;
      closeSettings();
    }

    function applyTheme() {
      if (settings.theme === 'light') {
        document.body.style.background = '#f5f5f5';
        document.body.style.color = '#333';
        if (monacoReady) monaco.editor.setTheme('vs');
      } else {
        document.body.style.background = '#000000';
        document.body.style.color = '#ccc';
        if (monacoReady) monaco.editor.setTheme('vs-dark');
      }
    }

    function showSettings() {
      document.getElementById('settings-overlay').style.display = 'flex';
    }

    function closeSettings() {
      document.getElementById('settings-overlay').style.display = 'none';
    }

    function showShortcuts() {
      document.getElementById('shortcuts-overlay').style.display = 'flex';
    }

    function closeShortcuts() {
      document.getElementById('shortcuts-overlay').style.display = 'none';
    }

    // Initialize
    async function init() {
      loadSettings();
      loadBookmarks();
      currentPath = await window.api.fs.getHome();
      loadFiles();
      createTerminal();
      setupResizer();
      setupPanelResizers();
      setupTerminalDropZone();
      showRightTab('notes');
    }

    // Recent files/folders
    let recentFolders = JSON.parse(localStorage.getItem('dterm-recent-folders') || '[]');
    let recentFiles = JSON.parse(localStorage.getItem('dterm-recent-files') || '[]');
    const MAX_RECENT = 10;

    function addRecentFolder(path) {
      recentFolders = recentFolders.filter(p => p !== path);
      recentFolders.unshift(path);
      if (recentFolders.length > MAX_RECENT) recentFolders.pop();
      localStorage.setItem('dterm-recent-folders', JSON.stringify(recentFolders));
    }

    function addRecentFile(path) {
      recentFiles = recentFiles.filter(p => p !== path);
      recentFiles.unshift(path);
      if (recentFiles.length > MAX_RECENT) recentFiles.pop();
      localStorage.setItem('dterm-recent-files', JSON.stringify(recentFiles));
    }

    function showRecentMenu(e) {
      e.stopPropagation();
      const menu = document.getElementById('recent-menu');
      menu.innerHTML = '';

      if (recentFolders.length === 0 && recentFiles.length === 0) {
        menu.innerHTML = '<div class="recent-item" style="color:#666">No recent items</div>';
      } else {
        if (recentFolders.length > 0) {
          menu.innerHTML += '<div class="recent-header">Recent Folders</div>';
          recentFolders.forEach(path => {
            const name = path.split('/').pop() || path;
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = 'üìÅ ' + name;
            item.title = path;
            item.onclick = () => { currentPath = path; loadFiles(); hideRecentMenu(); };
            menu.appendChild(item);
          });
        }
        if (recentFiles.length > 0) {
          menu.innerHTML += '<div class="recent-header">Recent Files</div>';
          recentFiles.forEach(path => {
            const name = path.split('/').pop();
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.textContent = 'üìÑ ' + name;
            item.title = path;
            item.onclick = () => { openFileInEditor(path); hideRecentMenu(); };
            menu.appendChild(item);
          });
        }
        const clear = document.createElement('div');
        clear.className = 'recent-clear';
        clear.textContent = 'Clear Recent';
        clear.onclick = () => {
          recentFolders = [];
          recentFiles = [];
          localStorage.removeItem('dterm-recent-folders');
          localStorage.removeItem('dterm-recent-files');
          hideRecentMenu();
        };
        menu.appendChild(clear);
      }

      menu.classList.add('visible');
    }

    function hideRecentMenu() {
      document.getElementById('recent-menu').classList.remove('visible');
    }

    document.addEventListener('click', hideRecentMenu);

    // Bookmarks
    let bookmarks = JSON.parse(localStorage.getItem('dterm-bookmarks') || '[]');

    function loadBookmarks() {
      const bar = document.getElementById('bookmarks-bar');
      bar.innerHTML = '';
      bookmarks.forEach((path, i) => {
        const name = path.split('/').pop() || path;
        const item = document.createElement('div');
        item.className = 'bookmark-item';
        item.innerHTML = `<span>üìÅ ${name}</span><span class="remove-bookmark" onclick="removeBookmark(${i}, event)">‚úï</span>`;
        item.onclick = () => goToBookmark(path);
        item.title = path;
        bar.appendChild(item);
      });
      updateBookmarkButton();
    }

    function toggleBookmark() {
      const index = bookmarks.indexOf(currentPath);
      if (index >= 0) {
        bookmarks.splice(index, 1);
      } else {
        bookmarks.push(currentPath);
      }
      localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
      loadBookmarks();
    }

    function removeBookmark(index, e) {
      e.stopPropagation();
      bookmarks.splice(index, 1);
      localStorage.setItem('dterm-bookmarks', JSON.stringify(bookmarks));
      loadBookmarks();
    }

    function goToBookmark(path) {
      currentPath = path;
      loadFiles();
    }

    function updateBookmarkButton() {
      const btn = document.querySelector('#fm-path button');
      if (btn) {
        btn.textContent = bookmarks.includes(currentPath) ? '‚òÖ' : '‚òÜ';
        btn.style.color = bookmarks.includes(currentPath) ? '#f90' : '#666';
      }
    }

    // File Manager
    async function loadFiles() {
      document.querySelector('#fm-path span').textContent = currentPath;
      updateBookmarkButton();
      addRecentFolder(currentPath);
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';

      try {
        const files = await window.api.fs.readDir(currentPath);
        allFiles = files;

        let filtered = files;
        if (!showHidden) {
          filtered = files.filter(f => !f.name.startsWith('.'));
        }

        const searchTerm = document.getElementById('fm-search').value.toLowerCase();
        if (searchTerm) {
          filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));
        }

        filtered.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.localeCompare(b.name);
        });

        // Get git status
        const gitBranch = await window.api.git.getBranch(currentPath);
        const gitStatus = await window.api.git.getStatus(currentPath);

        // Update git branch display
        const branchEl = document.getElementById('git-branch');
        const branchNameEl = document.getElementById('git-branch-name');
        if (gitBranch) {
          branchNameEl.textContent = gitBranch;
          branchEl.classList.add('visible');
        } else {
          branchEl.classList.remove('visible');
        }

        filtered.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.draggable = true;
          if (clipboard.file && clipboard.file.path === file.path && clipboard.action === 'cut') {
            div.classList.add('cut');
          }

          // Check git status for this file
          let gitIndicator = '';
          if (gitStatus) {
            const relPath = file.name;
            const status = gitStatus[relPath] || gitStatus[relPath + '/'];
            if (status) {
              if (status.includes('M') || status.includes('m')) {
                div.classList.add('git-modified');
                gitIndicator = '<span class="git-indicator modified">M</span>';
              } else if (status.includes('A')) {
                div.classList.add('git-added');
                gitIndicator = '<span class="git-indicator added">A</span>';
              } else if (status.includes('?')) {
                div.classList.add('git-untracked');
                gitIndicator = '<span class="git-indicator untracked">?</span>';
              } else if (status.includes('D')) {
                div.classList.add('git-deleted');
                gitIndicator = '<span class="git-indicator modified">D</span>';
              }
            }
          }

          const sizeStr = file.isDirectory ? '' : formatSize(file.size);
          div.innerHTML = `
            <span>${file.isDirectory ? 'üìÅ' : 'üìÑ'}</span>
            <span class="file-name">${file.name}</span>
            ${gitIndicator}
            <span class="file-info">${sizeStr}</span>
          `;
          div.onclick = (e) => handleClick(file, e);
          div.ondblclick = () => handleDoubleClick(file);
          div.oncontextmenu = (e) => showContextMenu(e, file);
          div.ondragstart = (e) => handleDragStart(e, file);
          div.ondragend = (e) => handleDragEnd(e);
          fileList.appendChild(div);
        });
      } catch (err) {
        fileList.innerHTML = `<div style="padding:10px;color:#f44">Error: ${err.message}</div>`;
      }
    }

    function formatSize(bytes) {
      if (!bytes) return '';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
      return (bytes / 1024 / 1024 / 1024).toFixed(1) + ' GB';
    }

    function filterFiles() {
      loadFiles();
    }

    function toggleHidden() {
      showHidden = !showHidden;
      document.getElementById('hidden-toggle').classList.toggle('active', showHidden);
      loadFiles();
    }

    function handleClick(file, e) {
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
      e.currentTarget.classList.add('selected');
      selectedFile = file;
    }

    async function handleDoubleClick(file) {
      if (file.isDirectory) {
        currentPath = file.path;
        loadFiles();
      } else if (canPreview(file.name)) {
        showFilePreview(file);
      } else {
        addRecentFile(file.path);
        await openFileInEditor(file);
      }
    }

    // Drag and drop for terminal
    function handleDragStart(e, file) {
      e.dataTransfer.setData('text/plain', file.path);
      e.dataTransfer.setData('application/x-dterm-file', JSON.stringify(file));
      e.dataTransfer.effectAllowed = 'copy';
      e.currentTarget.classList.add('dragging');
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
    }

    function setupTerminalDropZone() {
      const container = document.getElementById('terminal-container');

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        container.classList.add('drag-over');
      });

      container.addEventListener('dragleave', (e) => {
        container.classList.remove('drag-over');
      });

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        container.classList.remove('drag-over');

        const filePath = e.dataTransfer.getData('text/plain');
        if (filePath) {
          // Escape spaces and special characters for shell
          const escapedPath = escapePathForShell(filePath);
          // Write to active terminal
          const activeTerminal = terminals.find(t =>
            document.getElementById(t.id).classList.contains('active')
          );
          if (activeTerminal) {
            activeTerminal.term.paste(escapedPath);
            activeTerminal.term.focus();
          }
        }
      });
    }

    function escapePathForShell(path) {
      // Escape special characters for shell: spaces, quotes, parentheses, etc.
      return path.replace(/([ '"\\()&;|<>$`!#*?[\]{}])/g, '\\$1');
    }

    // Clipboard operations
    function copyFile() {
      hideContextMenu();
      if (selectedFile) {
        clipboard = { file: selectedFile, action: 'copy' };
        loadFiles();
      }
    }

    function cutFile() {
      hideContextMenu();
      if (selectedFile) {
        clipboard = { file: selectedFile, action: 'cut' };
        loadFiles();
      }
    }

    async function pasteFile() {
      hideContextMenu();
      if (!clipboard.file) return;

      const destPath = currentPath + '/' + clipboard.file.name;
      try {
        if (clipboard.action === 'copy') {
          await window.api.fs.copy(clipboard.file.path, destPath);
        } else {
          await window.api.fs.rename(clipboard.file.path, destPath);
          clipboard = { file: null, action: null };
        }
        loadFiles();
      } catch (err) {
        alert('Could not paste: ' + err.message);
      }
    }

    // Editor with Monaco
    async function openFileInEditor(file) {
      const existingIndex = openFiles.findIndex(f => f.path === file.path);
      if (existingIndex !== -1) {
        activateFile(existingIndex);
        return;
      }

      try {
        const content = await window.api.fs.readFile(file.path);
        openFiles.push({
          path: file.path,
          name: file.name,
          content: content,
          modified: false
        });
        activeFileIndex = openFiles.length - 1;
        updateEditorTabs();
        showEditor();
        setEditorContent(content, file.name);
        updateStatusBar();
      } catch (err) {
        alert('Could not open file: ' + err.message);
      }
    }

    function setEditorContent(content, filename) {
      const container = document.getElementById('editor-container');

      if (!monacoReady) {
        // Fallback to textarea if Monaco not loaded
        container.innerHTML = `<textarea id="editor-fallback" style="width:100%;height:100%;background:#000;color:#ccc;border:none;outline:none;resize:none;font-family:Menlo,Monaco,monospace;font-size:13px;padding:10px;">${content}</textarea>`;
        return;
      }

      if (monacoEditor) {
        monacoEditor.dispose();
      }

      const language = getLanguage(filename);
      monacoEditor = monaco.editor.create(container, {
        value: content,
        language: language,
        theme: settings.theme === 'light' ? 'vs' : 'vs-dark',
        fontSize: settings.fontSize,
        minimap: { enabled: true },
        automaticLayout: true,
        scrollBeyondLastLine: false,
        wordWrap: 'on'
      });

      monacoEditor.onDidChangeModelContent(() => {
        if (activeFileIndex >= 0) {
          openFiles[activeFileIndex].modified = true;
          openFiles[activeFileIndex].content = monacoEditor.getValue();
          updateEditorTabs();
        }
      });

      monacoEditor.onDidChangeCursorPosition((e) => {
        document.getElementById('status-line').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
      });
    }

    function getLanguage(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const langMap = {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'py': 'python',
        'rb': 'ruby',
        'java': 'java',
        'c': 'c',
        'cpp': 'cpp',
        'h': 'c',
        'cs': 'csharp',
        'go': 'go',
        'rs': 'rust',
        'php': 'php',
        'html': 'html',
        'htm': 'html',
        'css': 'css',
        'scss': 'scss',
        'less': 'less',
        'json': 'json',
        'xml': 'xml',
        'yaml': 'yaml',
        'yml': 'yaml',
        'md': 'markdown',
        'sql': 'sql',
        'sh': 'shell',
        'bash': 'shell',
        'zsh': 'shell',
        'ps1': 'powershell',
        'swift': 'swift',
        'kt': 'kotlin',
        'r': 'r',
        'lua': 'lua',
        'pl': 'perl',
        'dockerfile': 'dockerfile'
      };
      return langMap[ext] || 'plaintext';
    }

    function updateEditorTabs() {
      const tabsContainer = document.getElementById('editor-tabs');
      tabsContainer.innerHTML = '';

      openFiles.forEach((file, index) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (index === activeFileIndex ? ' active' : '') + (file.modified ? ' modified' : '');
        tab.innerHTML = `<span>${file.name}</span><span class="tab-close" onclick="closeEditorTab(${index}, event)">‚úï</span>`;
        tab.onclick = () => activateFile(index);
        tabsContainer.appendChild(tab);
      });
    }

    function activateFile(index) {
      if (activeFileIndex >= 0 && openFiles[activeFileIndex] && monacoEditor) {
        openFiles[activeFileIndex].content = monacoEditor.getValue();
      }

      activeFileIndex = index;
      setEditorContent(openFiles[index].content, openFiles[index].name);
      updateEditorTabs();
      updateStatusBar();
    }

    function closeEditorTab(index, e) {
      e.stopPropagation();

      if (openFiles[index].modified) {
        if (!confirm(`Save changes to ${openFiles[index].name}?`)) {
          // Don't save
        } else {
          saveCurrentFile();
        }
      }

      openFiles.splice(index, 1);

      if (openFiles.length === 0) {
        activeFileIndex = -1;
        hideEditor();
        if (monacoEditor) {
          monacoEditor.dispose();
          monacoEditor = null;
        }
      } else {
        activeFileIndex = Math.min(index, openFiles.length - 1);
        setEditorContent(openFiles[activeFileIndex].content, openFiles[activeFileIndex].name);
      }
      updateEditorTabs();
      updateStatusBar();
    }

    function showEditor() {
      document.getElementById('editor-area').classList.add('visible');
      document.getElementById('terminal-area').classList.add('with-editor');
      document.getElementById('resizer').style.display = 'block';
      terminals.forEach(t => t.fitAddon.fit());
    }

    function hideEditor() {
      document.getElementById('editor-area').classList.remove('visible');
      document.getElementById('terminal-area').classList.remove('with-editor');
      document.getElementById('resizer').style.display = 'none';
      terminals.forEach(t => t.fitAddon.fit());
    }

    async function saveCurrentFile() {
      if (activeFileIndex < 0) return;
      const file = openFiles[activeFileIndex];
      if (monacoEditor) {
        file.content = monacoEditor.getValue();
      }
      await window.api.fs.writeFile(file.path, file.content);
      file.modified = false;
      updateEditorTabs();
    }

    function updateStatusBar() {
      if (activeFileIndex >= 0) {
        document.getElementById('status-file').textContent = openFiles[activeFileIndex].path;
      } else {
        document.getElementById('status-file').textContent = 'No file open';
        document.getElementById('status-line').textContent = '';
      }
    }

    // Resizers
    function setupResizer() {
      const resizer = document.getElementById('resizer');
      const editorArea = document.getElementById('editor-area');
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'ns-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const mainArea = document.getElementById('main-area');
        const rect = mainArea.getBoundingClientRect();
        const editorHeight = e.clientY - rect.top;
        const minHeight = 100;
        const maxHeight = rect.height - 150;

        if (editorHeight > minHeight && editorHeight < maxHeight) {
          editorArea.style.flex = 'none';
          editorArea.style.height = editorHeight + 'px';
          terminals.forEach(t => t.fitAddon.fit());
        }
      });

      document.addEventListener('mouseup', () => {
        isResizing = false;
        document.body.style.cursor = '';
      });
    }

    function setupPanelResizers() {
      // Left panel resizer
      const leftResizer = document.getElementById('left-resizer');
      const leftPanel = document.getElementById('left-panel');
      let leftResizing = false;

      leftResizer.addEventListener('mousedown', () => {
        leftResizing = true;
        document.body.style.cursor = 'ew-resize';
      });

      // Right panel resizer
      const rightResizer = document.getElementById('right-resizer');
      const rightPanel = document.getElementById('right-panel');
      let rightResizing = false;

      rightResizer.addEventListener('mousedown', () => {
        rightResizing = true;
        document.body.style.cursor = 'ew-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (leftResizing) {
          const width = e.clientX;
          if (width >= 200 && width <= 500) {
            leftPanel.style.width = width + 'px';
            terminals.forEach(t => t.fitAddon.fit());
          }
        }
        if (rightResizing) {
          const width = window.innerWidth - e.clientX;
          if (width >= 300 && width <= 700) {
            rightPanel.style.width = width + 'px';
            terminals.forEach(t => t.fitAddon.fit());
          }
        }
      });

      document.addEventListener('mouseup', () => {
        leftResizing = false;
        rightResizing = false;
        leftPanelResizing = false;
        document.body.style.cursor = '';
      });

      // Left panel internal resizer (between file manager and mini browser)
      const leftPanelResizer = document.getElementById('left-panel-resizer');
      const fileManager = document.getElementById('file-manager');
      const miniBrowser = document.getElementById('mini-browser');
      let leftPanelResizing = false;

      leftPanelResizer.addEventListener('mousedown', () => {
        leftPanelResizing = true;
        document.body.style.cursor = 'ns-resize';
      });

      document.addEventListener('mousemove', (e) => {
        if (leftPanelResizing) {
          const leftPanel = document.getElementById('left-panel');
          const rect = leftPanel.getBoundingClientRect();
          const offsetY = e.clientY - rect.top;
          const totalHeight = rect.height;
          const minHeight = 100;

          if (offsetY >= minHeight && offsetY <= totalHeight - minHeight) {
            fileManager.style.flex = 'none';
            fileManager.style.height = offsetY + 'px';
            miniBrowser.style.flex = '1';
          }
        }
      });
    }

    async function goHome() {
      currentPath = await window.api.fs.getHome();
      loadFiles();
    }

    // Mini Browser functions
    function miniBrowserGo() {
      const webview = document.getElementById('mini-browser-frame');
      let url = document.getElementById('mini-browser-url').value.trim();
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      webview.src = url;
    }

    function miniBrowserBack() {
      const webview = document.getElementById('mini-browser-frame');
      if (webview.canGoBack()) webview.goBack();
    }

    function miniBrowserForward() {
      const webview = document.getElementById('mini-browser-frame');
      if (webview.canGoForward()) webview.goForward();
    }

    function miniBrowserRefresh() {
      const webview = document.getElementById('mini-browser-frame');
      webview.reload();
    }

    function miniBrowserHome() {
      const webview = document.getElementById('mini-browser-frame');
      webview.src = settings.browserHome;
      document.getElementById('mini-browser-url').value = settings.browserHome;
    }

    // Load saved home page immediately and update URL bar on navigation
    (function() {
      const saved = localStorage.getItem('dterm-settings');
      const homePage = saved ? (JSON.parse(saved).browserHome || 'https://duckduckgo.com') : 'https://duckduckgo.com';
      const webview = document.getElementById('mini-browser-frame');
      const urlInput = document.getElementById('mini-browser-url');
      if (webview) webview.src = homePage;
      if (urlInput) urlInput.value = homePage;
    })();

    document.addEventListener('DOMContentLoaded', () => {
      const webview = document.getElementById('mini-browser-frame');
      const loadingEl = document.getElementById('mini-browser-loading');
      if (webview) {
        webview.addEventListener('did-start-loading', () => {
          loadingEl.classList.add('visible');
        });
        webview.addEventListener('did-stop-loading', () => {
          loadingEl.classList.remove('visible');
        });
        webview.addEventListener('did-navigate', (e) => {
          document.getElementById('mini-browser-url').value = e.url;
        });
        webview.addEventListener('did-navigate-in-page', (e) => {
          document.getElementById('mini-browser-url').value = e.url;
        });
      }
    });

    function goUp() {
      const parent = currentPath.split('/').slice(0, -1).join('/') || '/';
      currentPath = parent;
      loadFiles();
    }

    async function openFolder() {
      const path = await window.api.dialog.openFolder();
      if (path) {
        currentPath = path;
        loadFiles();
      }
    }

    function refresh() {
      loadFiles();
    }

    function showContextMenu(e, file) {
      e.preventDefault();
      selectedFile = file;
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
    }

    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
      document.getElementById('terminal-context-menu').style.display = 'none';
    }

    // Terminal context menu
    let activeTerminalForMenu = null;

    function showTerminalContextMenu(e, termId) {
      hideContextMenu();
      activeTerminalForMenu = termId;
      const menu = document.getElementById('terminal-context-menu');
      menu.style.display = 'block';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
    }

    function terminalCopy() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData && termData.term.hasSelection()) {
        navigator.clipboard.writeText(termData.term.getSelection());
      }
    }

    function terminalPaste() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        navigator.clipboard.readText().then(text => {
          termData.term.paste(text);
        });
      }
    }

    function terminalSelectAll() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        termData.term.selectAll();
      }
    }

    function terminalClear() {
      hideContextMenu();
      const termData = terminals.find(t => t.id === activeTerminalForMenu);
      if (termData) {
        termData.term.clear();
      }
    }

    // Command Palette
    const commands = [
      { name: 'New Terminal', icon: 'üíª', action: () => createTerminal(), shortcut: '‚åòT' },
      { name: 'New File', icon: 'üìÑ', action: () => newFile() },
      { name: 'New Folder', icon: 'üìÅ', action: () => newFolder() },
      { name: 'Open Folder', icon: 'üìÇ', action: () => openFolder() },
      { name: 'Save File', icon: 'üíæ', action: () => saveCurrentFile(), shortcut: '‚åòS' },
      { name: 'Toggle Sidebar', icon: '‚óÄ', action: () => toggleSidebar(), shortcut: '‚åòB' },
      { name: 'Settings', icon: '‚öô', action: () => showSettings(), shortcut: '‚åò,' },
      { name: 'Keyboard Shortcuts', icon: '‚å®', action: () => showShortcuts(), shortcut: '‚åò/' },
      { name: 'Search in Terminal', icon: 'üîç', action: () => openTerminalSearch(), shortcut: '‚åòF' },
      { name: 'Clear Terminal', icon: 'üßπ', action: () => { const t = getActiveTerminalData(); if(t) t.term.clear(); } },
      { name: 'Go Home', icon: 'üè†', action: () => goHome() },
      { name: 'Refresh Files', icon: 'üîÑ', action: () => refresh() },
      { name: 'Toggle Hidden Files', icon: 'üëÅ', action: () => toggleHidden() },
      { name: 'Notes', icon: 'üìù', action: () => showRightTab('notes') },
      { name: 'AI Chat', icon: 'ü§ñ', action: () => showRightTab('ai') },
      { name: 'FTP', icon: 'üåê', action: () => showRightTab('ftp') },
    ];

    let selectedCommandIndex = 0;
    let filteredCommands = [...commands];

    function toggleSidebar() {
      const left = document.getElementById('left-panel');
      const resizer = document.getElementById('left-resizer');
      if (left.style.display === 'none') {
        left.style.display = 'flex';
        resizer.style.display = 'block';
      } else {
        left.style.display = 'none';
        resizer.style.display = 'none';
      }
    }

    function showCommandPalette() {
      document.getElementById('command-palette').classList.add('visible');
      document.getElementById('command-palette-input').value = '';
      document.getElementById('command-palette-input').focus();
      selectedCommandIndex = 0;
      filteredCommands = [...commands];
      renderCommands();
    }

    function hideCommandPalette() {
      document.getElementById('command-palette').classList.remove('visible');
    }

    function filterCommands() {
      const query = document.getElementById('command-palette-input').value.toLowerCase();
      filteredCommands = commands.filter(c => c.name.toLowerCase().includes(query));
      selectedCommandIndex = 0;
      renderCommands();
    }

    function renderCommands() {
      const list = document.getElementById('command-palette-list');
      list.innerHTML = '';
      filteredCommands.forEach((cmd, i) => {
        const div = document.createElement('div');
        div.className = 'command-item' + (i === selectedCommandIndex ? ' selected' : '');
        div.innerHTML = `
          <span class="command-icon">${cmd.icon}</span>
          <span class="command-name">${cmd.name}</span>
          ${cmd.shortcut ? `<span class="command-shortcut">${cmd.shortcut}</span>` : ''}
        `;
        div.onclick = () => executeCommand(i);
        div.onmouseenter = () => {
          selectedCommandIndex = i;
          renderCommands();
        };
        list.appendChild(div);
      });
    }

    function executeCommand(index) {
      const cmd = filteredCommands[index];
      if (cmd) {
        hideCommandPalette();
        cmd.action();
      }
    }

    function handleCommandKey(e) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedCommandIndex = Math.min(selectedCommandIndex + 1, filteredCommands.length - 1);
        renderCommands();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
        renderCommands();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        executeCommand(selectedCommandIndex);
      } else if (e.key === 'Escape') {
        hideCommandPalette();
      }
    }

    // File Preview
    const previewableExtensions = {
      image: ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg', 'ico'],
      video: ['mp4', 'webm', 'mov', 'avi'],
      audio: ['mp3', 'wav', 'ogg', 'flac', 'm4a']
    };

    function canPreview(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return previewableExtensions.image.includes(ext) ||
             previewableExtensions.video.includes(ext) ||
             previewableExtensions.audio.includes(ext);
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (previewableExtensions.image.includes(ext)) return 'image';
      if (previewableExtensions.video.includes(ext)) return 'video';
      if (previewableExtensions.audio.includes(ext)) return 'audio';
      return null;
    }

    function showFilePreview(file) {
      const container = document.getElementById('file-preview-container');
      const type = getFileType(file.name);
      const fileUrl = 'file://' + file.path;

      if (type === 'image') {
        container.innerHTML = `<img src="${fileUrl}" alt="${file.name}"><div id="file-preview-name">${file.name}</div>`;
      } else if (type === 'video') {
        container.innerHTML = `<video src="${fileUrl}" controls autoplay><div id="file-preview-name">${file.name}</div>`;
      } else if (type === 'audio') {
        container.innerHTML = `<div style="padding:40px;text-align:center;"><div style="font-size:48px;margin-bottom:20px;">üéµ</div><audio src="${fileUrl}" controls autoplay></audio><div id="file-preview-name">${file.name}</div></div>`;
      }

      document.getElementById('file-preview-overlay').classList.add('visible');
    }

    function closeFilePreview() {
      document.getElementById('file-preview-overlay').classList.remove('visible');
      document.getElementById('file-preview-container').innerHTML = '';
    }

    // Terminal search
    function openTerminalSearch() {
      const searchEl = document.getElementById('terminal-search');
      searchEl.classList.add('visible');
      document.getElementById('terminal-search-input').focus();
    }

    function closeTerminalSearch() {
      document.getElementById('terminal-search').classList.remove('visible');
      document.getElementById('terminal-search-input').value = '';
      document.getElementById('terminal-search-count').textContent = '';
    }

    function getActiveTerminalData() {
      return terminals.find(t => document.getElementById(t.id)?.classList.contains('active'));
    }

    function terminalSearchNext() {
      const termData = getActiveTerminalData();
      const query = document.getElementById('terminal-search-input').value;
      if (termData && query) {
        termData.searchAddon.findNext(query);
      }
    }

    function terminalSearchPrev() {
      const termData = getActiveTerminalData();
      const query = document.getElementById('terminal-search-input').value;
      if (termData && query) {
        termData.searchAddon.findPrevious(query);
      }
    }

    function handleTerminalSearchKey(e) {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          terminalSearchPrev();
        } else {
          terminalSearchNext();
        }
      } else if (e.key === 'Escape') {
        closeTerminalSearch();
      }
    }

    function openSelectedFile() {
      hideContextMenu();
      if (selectedFile) {
        handleDoubleClick(selectedFile);
      }
    }

    function previewSelectedFile() {
      hideContextMenu();
      if (selectedFile && canPreview(selectedFile.name)) {
        showFilePreview(selectedFile);
      }
    }

    async function deleteFile() {
      hideContextMenu();
      if (selectedFile && confirm(`Delete "${selectedFile.name}"?`)) {
        await window.api.fs.delete(selectedFile.path);
        loadFiles();
      }
    }

    document.addEventListener('click', (e) => {
      hideContextMenu();
      if (!e.target.closest('#command-palette')) {
        hideCommandPalette();
      }
    });

    // Input dialog
    let inputDialogCallback = null;

    function showInputDialog(title, defaultValue = '') {
      return new Promise((resolve) => {
        document.getElementById('input-dialog-title').textContent = title;
        document.getElementById('input-dialog-input').value = defaultValue;
        document.getElementById('input-dialog').style.display = 'flex';
        document.getElementById('input-dialog-input').focus();
        inputDialogCallback = resolve;
      });
    }

    function closeInputDialog() {
      document.getElementById('input-dialog').style.display = 'none';
      if (inputDialogCallback) {
        inputDialogCallback(null);
        inputDialogCallback = null;
      }
    }

    function confirmInputDialog() {
      const value = document.getElementById('input-dialog-input').value;
      document.getElementById('input-dialog').style.display = 'none';
      if (inputDialogCallback) {
        inputDialogCallback(value);
        inputDialogCallback = null;
      }
    }

    document.getElementById('input-dialog-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') confirmInputDialog();
      if (e.key === 'Escape') closeInputDialog();
    });

    async function newFile() {
      const name = await showInputDialog('Enter file name:');
      if (name && name.trim()) {
        const filePath = currentPath + '/' + name.trim();
        try {
          await window.api.fs.writeFile(filePath, '');
          loadFiles();
          await openFileInEditor({ path: filePath, name: name.trim(), isDirectory: false });
        } catch (err) {
          alert('Could not create file: ' + err.message);
        }
      }
    }

    async function newFolder() {
      const name = await showInputDialog('Enter folder name:');
      if (name && name.trim()) {
        const folderPath = currentPath + '/' + name.trim();
        try {
          await window.api.fs.mkdir(folderPath);
          loadFiles();
        } catch (err) {
          alert('Could not create folder: ' + err.message);
        }
      }
    }

    async function renameFile() {
      hideContextMenu();
      if (!selectedFile) return;
      const newName = await showInputDialog('Enter new name:', selectedFile.name);
      if (newName && newName.trim() && newName !== selectedFile.name) {
        const newPath = currentPath + '/' + newName.trim();
        try {
          await window.api.fs.rename(selectedFile.path, newPath);
          loadFiles();
        } catch (err) {
          alert('Could not rename: ' + err.message);
        }
      }
    }

    // Terminal
    function createTerminal(shell) {
      const id = 'term-' + Date.now();
      const container = document.createElement('div');
      container.className = 'terminal-panel';
      container.id = id;
      document.getElementById('terminal-container').appendChild(container);

      const term = new Terminal({
        fontSize: 13,
        fontFamily: 'Menlo, Monaco, monospace',
        theme: {
          background: '#000000',
          foreground: '#cccccc',
          cursor: '#ffffff',
          cursorAccent: '#000000',
          selectionBackground: '#0066cc'
        },
        cursorBlink: true
      });

      const fitAddon = new FitAddon.FitAddon();
      const searchAddon = new SearchAddon.SearchAddon();
      term.loadAddon(fitAddon);
      term.loadAddon(searchAddon);
      term.open(container);
      fitAddon.fit();

      const shellToUse = shell || settings.shell || '/bin/zsh';
      window.api.terminal.create(id, shellToUse);

      term.onData(data => window.api.terminal.write(id, data));
      term.onResize(({ cols, rows }) => window.api.terminal.resize(id, cols, rows));

      const shellName = shellToUse.split('/').pop();
      const termData = { id, term, fitAddon, searchAddon, name: shellName };
      terminals.push(termData);

      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.id = 'tab-' + id;
      tab.innerHTML = `<span>${shellName}</span><span class="tab-close" onclick="closeTerminal('${id}', event)">‚úï</span>`;
      tab.onclick = () => activateTerminal(id);
      document.getElementById('terminal-tabs').insertBefore(tab, document.getElementById('new-term-btn'));

      activateTerminal(id);
      new ResizeObserver(() => fitAddon.fit()).observe(container);

      // Terminal context menu
      container.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showTerminalContextMenu(e, id);
      });
    }

    function activateTerminal(id) {
      document.querySelectorAll('.terminal-panel').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('#terminal-tabs .tab').forEach(el => el.classList.remove('active'));

      document.getElementById(id).classList.add('active');
      document.getElementById('tab-' + id).classList.add('active');

      const termData = terminals.find(t => t.id === id);
      if (termData) {
        termData.fitAddon.fit();
        termData.term.focus();
      }
    }

    function closeTerminal(id, e) {
      e.stopPropagation();
      window.api.terminal.kill(id);

      const idx = terminals.findIndex(t => t.id === id);
      if (idx !== -1) {
        terminals[idx].term.dispose();
        terminals.splice(idx, 1);
      }

      document.getElementById(id).remove();
      document.getElementById('tab-' + id).remove();

      if (terminals.length > 0) {
        activateTerminal(terminals[terminals.length - 1].id);
      }
    }

    window.api.terminal.onData((id, data) => {
      const termData = terminals.find(t => t.id === id);
      if (termData) termData.term.write(data);
    });

    window.api.terminal.onExit((id, code) => {
      const termData = terminals.find(t => t.id === id);
      if (termData) termData.term.write(`\r\n[Process exited with code ${code}]\r\n`);
    });

    // Right Panel
    function showRightTab(tab) {
      const frame = document.getElementById('ai-frame');
      const notesPanel = document.getElementById('right-notes-panel');
      const ftpPanel = document.getElementById('right-ftp-panel');
      const select = document.getElementById('ai-select');
      const tabs = document.querySelectorAll('.right-tab');

      tabs.forEach(t => t.classList.remove('active'));

      notesPanel.style.display = 'none';
      ftpPanel.style.display = 'none';
      frame.style.display = 'none';
      select.style.display = 'none';

      if (tab === 'notes') {
        tabs[0].classList.add('active');
        notesPanel.style.display = 'flex';
      } else if (tab === 'ai') {
        tabs[1].classList.add('active');
        frame.style.display = 'flex';
        select.style.display = 'block';
        if (frame.src === 'about:blank') {
          frame.src = select.value;
        }
      } else if (tab === 'ftp') {
        tabs[2].classList.add('active');
        ftpPanel.style.display = 'block';
      }
    }

    function switchAI() {
      const select = document.getElementById('ai-select');
      const frame = document.getElementById('ai-frame');
      frame.src = select.value;
    }

    // FTP
    let ftpConnected = false;
    let ftpCurrentPath = '/';

    async function connectFtp() {
      const host = document.getElementById('ftp-host').value;
      const port = parseInt(document.getElementById('ftp-port').value) || 21;
      const user = document.getElementById('ftp-user').value;
      const pass = document.getElementById('ftp-pass').value;

      if (!host) {
        alert('Please enter a host');
        return;
      }

      document.getElementById('ftp-status').textContent = 'Connecting...';

      try {
        await window.api.ftp.connect(host, port, user, pass);
        ftpConnected = true;
        ftpCurrentPath = '/';
        document.getElementById('ftp-status').textContent = `Connected to ${host}`;
        loadFtpFiles();
      } catch (err) {
        document.getElementById('ftp-status').textContent = 'Error: ' + err.message;
      }
    }

    async function loadFtpFiles() {
      if (!ftpConnected) return;

      const fileList = document.getElementById('ftp-file-list');
      fileList.innerHTML = '';

      try {
        const files = await window.api.ftp.list(ftpCurrentPath);

        // Add parent directory
        if (ftpCurrentPath !== '/') {
          const upDiv = document.createElement('div');
          upDiv.className = 'file-item';
          upDiv.innerHTML = '<span>üìÅ</span><span>..</span>';
          upDiv.ondblclick = () => {
            ftpCurrentPath = ftpCurrentPath.split('/').slice(0, -1).join('/') || '/';
            loadFtpFiles();
          };
          fileList.appendChild(upDiv);
        }

        files.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.innerHTML = `<span>${file.isDirectory ? 'üìÅ' : 'üìÑ'}</span><span>${file.name}</span>`;
          div.ondblclick = () => {
            if (file.isDirectory) {
              ftpCurrentPath = ftpCurrentPath === '/' ? '/' + file.name : ftpCurrentPath + '/' + file.name;
              loadFtpFiles();
            }
          };
          fileList.appendChild(div);
        });
      } catch (err) {
        fileList.innerHTML = `<div style="padding:10px;color:#f44">Error: ${err.message}</div>`;
      }
    }

    // Notes
    async function initNotes() {
      const notes = document.getElementById('notes-area');
      const saved = await window.api.notes.load();
      if (saved && saved.content) notes.value = saved.content;

      let saveTimeout;
      notes.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          window.api.notes.save({ content: notes.value });
        }, 500);
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd+S - Save
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        saveCurrentFile();
      }
      // Cmd+T - New terminal
      if ((e.metaKey || e.ctrlKey) && e.key === 't') {
        e.preventDefault();
        createTerminal();
      }
      // Cmd+W - Close tab
      if ((e.metaKey || e.ctrlKey) && e.key === 'w') {
        e.preventDefault();
        if (activeFileIndex >= 0) {
          closeEditorTab(activeFileIndex, { stopPropagation: () => {} });
        }
      }
      // Cmd+B - Toggle sidebar
      if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
        e.preventDefault();
        const left = document.getElementById('left-panel');
        const resizer = document.getElementById('left-resizer');
        if (left.style.display === 'none') {
          left.style.display = 'flex';
          resizer.style.display = 'block';
        } else {
          left.style.display = 'none';
          resizer.style.display = 'none';
        }
      }
      // Cmd+, - Settings
      if ((e.metaKey || e.ctrlKey) && e.key === ',') {
        e.preventDefault();
        showSettings();
      }
      // Cmd+/ - Shortcuts
      if ((e.metaKey || e.ctrlKey) && e.key === '/') {
        e.preventDefault();
        showShortcuts();
      }
      // Cmd+Shift+P - Command Palette
      if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'p') {
        e.preventDefault();
        showCommandPalette();
      }
      // Cmd+P - Command Palette (alternative)
      if ((e.metaKey || e.ctrlKey) && !e.shiftKey && e.key === 'p') {
        e.preventDefault();
        showCommandPalette();
      }
      // Escape - Close dialogs
      if (e.key === 'Escape') {
        closeSettings();
        closeShortcuts();
        closeFilePreview();
        closeTerminalSearch();
      }
      // Cmd+Left - Go to beginning of line (send Ctrl+A to terminal)
      if (e.metaKey && !e.altKey && e.key === 'ArrowLeft') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x01');
        }
      }
      // Cmd+Right - Go to end of line (send Ctrl+E to terminal)
      if (e.metaKey && !e.altKey && e.key === 'ArrowRight') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x05');
        }
      }
      // Cmd+Option+Left - Go one word back (send Alt+B to terminal)
      if (e.metaKey && e.altKey && e.key === 'ArrowLeft') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x1bb');
        }
      }
      // Cmd+Option+Right - Go one word forward (send Alt+F to terminal)
      if (e.metaKey && e.altKey && e.key === 'ArrowRight') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal) {
          e.preventDefault();
          window.api.terminal.write(activeTerminal.id, '\x1bf');
        }
      }
      // Cmd+F - Search in terminal (when terminal focused)
      if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
        const activeTerminal = terminals.find(t =>
          document.getElementById(t.id)?.classList.contains('active')
        );
        if (activeTerminal && document.activeElement?.closest('#terminal-container')) {
          e.preventDefault();
          openTerminalSearch();
        }
      }
    });

    // File manager keyboard shortcuts
    document.getElementById('file-list').addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'c') {
        copyFile();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'x') {
        cutFile();
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'v') {
        pasteFile();
      }
    });

    // Start
    init();
    initNotes();
  </script>
</body>
</html>
